<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RefactorisÃ© - Boutons Corrections</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tab { padding: 10px; margin: 5px; cursor: pointer; background-color: #eee; display: inline-block; border-radius: 4px; }
        .tab.active { background-color: #007acc; color: white; font-weight: bold; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; border-radius: 4px; border: none; }
        .btn-auto { background-color: #28a745; color: white; }
        .btn-manual { background-color: #ffc107; color: black; }
        .card { border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 4px; }
        .auto-fixable { border-color: green; background-color: #f0fff0; }
        .manual-fix { border-color: orange; background-color: #fffaf0; }
        .hidden { display: none !important; }
        .log { border: 1px solid #ddd; padding: 10px; margin: 20px 0; background: #f9f9f9; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Test RefactorisÃ© - Boutons Corrections</h1>

    <div>
        <div class="tab active" data-filter="auto">Auto</div>
        <div class="tab" data-filter="manual">Manuel</div>
    </div>

    <button id="applyAllAutoBtn" class="btn-auto">âœ¨ Appliquer les corrections (Auto)</button>
    <button id="applyAllManualBtn" class="btn-manual">ðŸ”§ Appliquer les corrections (Manuel)</button>

    <div id="cards">
        <!-- Cartes auto-fixables -->
        <div class="card auto-fixable" data-indices="[0]">
            <strong>Auto 1:</strong> Variable couleur principale â†’ #FF0000
        </div>
        <div class="card auto-fixable" data-indices="[1]">
            <strong>Auto 2:</strong> Variable espacement â†’ 16px
        </div>

        <!-- Cartes manuelles -->
        <div class="card manual-fix" data-indices="[2]">
            <strong>Manuel 1:</strong> Conflit de couleurs
            <select class="manual-select" data-indices="[2]">
                <option value="">Choisir...</option>
                <option value="red-primary">Rouge primaire</option>
                <option value="red-secondary">Rouge secondaire</option>
            </select>
        </div>
        <div class="card manual-fix" data-indices="[3]">
            <strong>Manuel 2:</strong> Espacement conflictuel
            <select class="manual-select" data-indices="[3]">
                <option value="">Choisir...</option>
                <option value="spacing-sm">Petit</option>
                <option value="spacing-md">Moyen</option>
            </select>
        </div>
    </div>

    <div class="log" id="log"></div>

    <script>
        // Fonctions simulÃ©es
        function showNotification(message, type) {
            log(`ðŸ”” NOTIFICATION [${type.toUpperCase()}]: ${message}`);
        }

        function applyGroupFix(indices, variableId) {
            log(`ðŸ”§ APPLYING: indices=${JSON.stringify(indices)}, variableId="${variableId}"`);
            // Simuler succÃ¨s
            setTimeout(() => {
                log(`âœ… SUCCESS: Correction appliquÃ©e`);
                // Masquer la carte
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    const cardIndices = JSON.parse(card.getAttribute('data-indices') || '[]');
                    if (cardIndices.includes(indices[0])) {
                        card.style.display = 'none';
                        log(`ðŸ‘ï¸ CARD HIDDEN: ${card.querySelector('strong').textContent}`);
                    }
                });
            }, 500);
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Gestion des onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const filter = this.getAttribute('data-filter');
                applyFilter(filter);
                log(`ðŸ”„ SWITCHED TO TAB: ${filter}`);
            });
        });

        function applyFilter(filterType) {
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                let isVisible = false;

                if (filterType === 'auto') {
                    isVisible = card.classList.contains('auto-fixable');
                } else if (filterType === 'manual') {
                    isVisible = card.classList.contains('manual-fix');
                }

                card.style.display = isVisible ? 'block' : 'none';
            });
        }

        // Fonction applyAllAutoFixes refactorisÃ©e
        function applyAllAutoFixes() {
            log('ðŸš€ applyAllAutoFixes called');

            // VÃ©rifier que nous sommes sur l'onglet "Auto"
            var autoTab = document.querySelector('.tab[data-filter="auto"]');
            var isAutoTabActive = autoTab && autoTab.classList.contains('active');

            if (!isAutoTabActive) {
                showNotification('Cette action n\'est disponible que sur l\'onglet "Auto"', 'warning');
                return;
            }

            // RÃ©cupÃ©rer les cartes auto-fixables visibles
            var autoCards = Array.from(document.querySelectorAll('.card.auto-fixable'))
                .filter(card => card.style.display !== 'none');

            log(`ðŸ“‹ Found ${autoCards.length} auto-fixable cards`);

            if (autoCards.length === 0) {
                showNotification('Aucune correction automatique disponible', 'info');
                return;
            }

            // DÃ©sactiver le bouton
            const applyBtn = document.getElementById('applyAllAutoBtn');
            applyBtn.disabled = true;
            applyBtn.textContent = 'Correction en cours...';

            var fixesApplied = 0;
            var processedCards = 0;

            function processNextCard() {
                if (processedCards >= autoCards.length) {
                    log('ðŸ All auto cards processed');
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'âœ¨ Appliquer les corrections (Auto)';

                    if (fixesApplied > 0) {
                        showNotification(`${fixesApplied} correction(s) appliquÃ©e(s)`, 'success');
                    }
                    return;
                }

                var card = autoCards[processedCards];
                const indices = JSON.parse(card.getAttribute('data-indices'));
                const variableId = 'auto-var-' + indices[0];

                log(`âš™ï¸ Processing card ${processedCards + 1}/${autoCards.length}`);
                applyGroupFix(indices, variableId);
                fixesApplied++;

                setTimeout(() => {
                    processedCards++;
                    processNextCard();
                }, 600);
            }

            processNextCard();
        }

        // Fonction applyAllManualFixes refactorisÃ©e
        function applyAllManualFixes() {
            log('ðŸš€ applyAllManualFixes called');

            // VÃ©rifier que nous sommes sur l'onglet "Manuel"
            var manualTab = document.querySelector('.tab[data-filter="manual"]');
            var isManualTabActive = manualTab && manualTab.classList.contains('active');

            if (!isManualTabActive) {
                showNotification('Cette action n\'est disponible que sur l\'onglet "Manuel"', 'warning');
                return;
            }

            var readyCards = document.querySelectorAll('.manual-fix');
            var fixesApplied = 0;

            readyCards.forEach(function (card) {
                if (card.style.display === 'none') return; // Skip hidden cards

                var select = card.querySelector('.manual-select');
                if (select && select.value) {
                    var indicesRaw = select.getAttribute('data-indices');
                    var indices = indicesRaw ? indicesRaw.split(',').map(Number) : [];
                    var variableId = select.value;

                    log(`âš™ï¸ Processing manual card: ${card.querySelector('strong').textContent}`);
                    applyGroupFix(indices, variableId);
                    fixesApplied++;
                } else {
                    log(`âš ï¸ Manual card skipped (no selection): ${card.querySelector('strong').textContent}`);
                }
            });

            if (fixesApplied > 0) {
                showNotification(`${fixesApplied} correction(s) manuelle(s) appliquÃ©e(s)`, 'success');
            } else {
                showNotification('Aucune correction manuelle prÃªte', 'info');
            }
        }

        // Attacher les event listeners
        document.getElementById('applyAllAutoBtn').addEventListener('click', applyAllAutoFixes);
        document.getElementById('applyAllManualBtn').addEventListener('click', applyAllManualFixes);

        // Initialisation
        applyFilter('auto');
        log('ðŸŽ¯ Test initialized');
        log('ðŸ“ Test: Cliquez sur "Appliquer les corrections (Auto)" sur l\'onglet Auto');
        log('ðŸ“ Test: Changez d\'onglet et essayez les boutons pour voir les protections');

        // PrÃ©-remplir une sÃ©lection manuelle pour le test
        setTimeout(() => {
            const selects = document.querySelectorAll('.manual-select');
            if (selects[0]) selects[0].value = 'red-primary';
            if (selects[1]) selects[1].value = 'spacing-md';
            log('ðŸ”§ Pre-filled manual selections for testing');
        }, 1000);
    </script>
</body>
</html>