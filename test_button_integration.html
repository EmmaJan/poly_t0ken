<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration Bouton G√©n√©rer les Tokens</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005aa3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { border: 1px solid #ddd; padding: 10px; margin: 20px 0; background: #f9f9f9; max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .step { margin: 15px 0; padding: 10px; border-left: 4px solid #007acc; background: #f0f8ff; }
    </style>
</head>
<body>
    <h1>Test d'Int√©gration - Bouton "G√©n√©rer les Tokens"</h1>

    <div class="step">
        <h3>Simulation de l'interface utilisateur</h3>
        <p>Cette page simule exactement ce qui se passe dans ui.html quand l'utilisateur clique sur "G√©n√©rer les Tokens".</p>

        <label>Couleur s√©lectionn√©e:
            <input type="color" id="colorPicker" value="#6366F1">
            <span id="colorValue">#6366F1</span>
        </label>

        <br><br>

        <label> Biblioth√®que s√©lectionn√©e:
            <select id="namingSelect">
                <option value="">Aucune (devrait devenir "custom")</option>
                <option value="custom" selected>Custom</option>
                <option value="shadcn">ShadCN</option>
                <option value="antd">Ant Design</option>
            </select>
        </label>

        <br><br>

        <button id="step2Generate">G√©n√©rer les Tokens ‚Üí</button>
    </div>

    <div class="step">
        <h3>R√©sultats du test</h3>
        <button id="runIntegrationTest">Lancer le test d'int√©gration</button>
        <button id="clearLog">Effacer le log</button>
    </div>

    <div class="log" id="log"></div>

    <!-- Charger le code du plugin pour simuler le backend -->
    <script src="code.js"></script>

    <script>
        var currentColor = "#6366F1";
        var currentNaming = "";

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.className = type;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // Simuler le message handler du plugin (comme dans code.js)
        function simulatePluginMessage(msg) {
            log(`üîΩ Plugin received message: ${JSON.stringify(msg, null, 2)}`, 'info');

            if (msg.type === "generate") {
                log(`üîÑ Processing generate request...`, 'info');

                try {
                    // Appliquer la logique corrig√©e
                    var naming = msg.naming && msg.naming.trim() !== "" ? msg.naming : "custom";
                    log(`üìù Resolved naming: "${msg.naming}" -> "${naming}"`, 'info');

                    var tokens = {
                        brand: generateBrandColors(msg.color, naming),
                        system: generateSystemColors(naming),
                        gray: generateGrayscale(naming),
                        spacing: generateSpacing(naming),
                        radius: generateRadius(naming),
                        typography: generateTypography(naming),
                        border: generateBorder()
                    };

                    log(`‚úÖ Tokens generated successfully: ${Object.keys(tokens).length} categories`, 'success');
                    log(`üì¶ Token categories: ${Object.keys(tokens).join(', ')}`, 'info');

                    // Simuler l'envoi de la r√©ponse √† l'UI
                    setTimeout(() => {
                        log(`üì§ Sending tokens-generated message back to UI`, 'info');
                        handleTokensGenerated(tokens);
                    }, 200);

                } catch (error) {
                    log(`‚ùå Error generating tokens: ${error.message}`, 'error');
                    console.error('Full error:', error);
                }
            }
        }

        function handleTokensGenerated(tokens) {
            log(`üì• UI received tokens-generated message`, 'success');

            // Afficher un r√©sum√© des tokens g√©n√©r√©s
            let summary = 'Tokens g√©n√©r√©s:\n';
            for (const [category, tokenSet] of Object.entries(tokens)) {
                const count = Object.keys(tokenSet).length;
                summary += `  - ${category}: ${count} tokens\n`;
            }
            log(summary, 'success');

            alert('üéâ Tokens g√©n√©r√©s avec succ√®s !\n\nV√©rifiez le log pour les d√©tails complets.');
        }

        // Configuration de l'interface de test
        document.getElementById('colorPicker').addEventListener('change', function() {
            currentColor = this.value.toUpperCase();
            document.getElementById('colorValue').textContent = currentColor;
            log(`üé® Color changed to: ${currentColor}`);
        });

        document.getElementById('namingSelect').addEventListener('change', function() {
            currentNaming = this.value;
            log(`üìö Naming changed to: "${currentNaming}"`);
        });

        // Configuration du bouton principal (comme dans ui.html)
        document.getElementById('step2Generate').addEventListener('click', function() {
            log(`üñ±Ô∏è step2Generate button clicked`, 'info');

            // Simuler l'envoi du message au plugin (exactement comme dans ui.html)
            var message = {
                pluginMessage: {
                    type: "generate",
                    color: currentColor,
                    naming: currentNaming
                }
            };

            log(`üì§ Sending message to plugin: ${JSON.stringify(message, null, 2)}`, 'info');

            // Simuler la r√©ception par le plugin apr√®s un petit d√©lai
            setTimeout(() => {
                simulatePluginMessage(message.pluginMessage);
            }, 100);
        });

        // Test d'int√©gration
        document.getElementById('runIntegrationTest').addEventListener('click', function() {
            log('üöÄ Starting integration test...', 'info');

            // Test 1: Avec naming vide (devrait devenir "custom")
            log('Test 1: Empty naming (should become "custom")', 'info');
            currentNaming = "";
            document.getElementById('namingSelect').value = "";
            document.getElementById('step2Generate').click();

            setTimeout(() => {
                // Test 2: Avec naming "shadcn"
                log('Test 2: ShadCN naming', 'info');
                currentNaming = "shadcn";
                document.getElementById('namingSelect').value = "shadcn";
                document.getElementById('step2Generate').click();
            }, 1000);
        });

        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // Initialisation
        log('üéØ Integration test page initialized', 'info');
        log('üìã Current state:', 'info');
        log(`   Color: ${currentColor}`, 'info');
        log(`   Naming: "${currentNaming}"`, 'info');
    </script>
</body>
</html>