<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Débogage du bouton "Corriger"</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .card { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
        .auto-fixable { border-color: green; }
        .manual-required { border-color: orange; }
        .hidden { display: none; background-color: #f0f0f0; }
        .tab { padding: 10px; margin: 5px; cursor: pointer; background-color: #eee; }
        .tab.active { background-color: #ddd; font-weight: bold; }
        button { padding: 10px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Débogage du bouton "Corriger"</h1>

    <div>
        <button class="tab active" data-filter="auto">Auto</button>
        <button class="tab" data-filter="manual">Manuel</button>
    </div>

    <button id="applyAllAutoBtn">✨ Appliquer les corrections</button>

    <div id="cards">
        <!-- Cartes de test -->
        <div class="card auto-fixable" data-indices="[0]" style="display: flex;">
            <strong>Carte Auto 1</strong> - Visible sur Auto
        </div>
        <div class="card auto-fixable" data-indices="[1]" style="display: none;">
            <strong>Carte Auto 2</strong> - Masquée (ignorée)
        </div>
        <div class="card manual-required" data-indices="[2]" style="display: none;">
            <strong>Carte Manuel 1</strong> - Visible sur Manuel
        </div>
        <div class="card auto-fixable manual-required" data-indices="[3]" style="display: flex;">
            <strong>Carte Mixte</strong> - Problème potentiel
        </div>
    </div>

    <div id="log"></div>

    <script>
        var currentFilter = 'auto';

        // Simulation de showNotification
        function showNotification(message, type) {
            log(`NOTIFICATION [${type.toUpperCase()}]: ${message}`);
        }

        // Simulation de applyGroupFix
        function applyGroupFix(indices, variableId) {
            log(`APPLYING CORRECTION: indices=${indices}, variableId=${variableId}`);
        }

        // Fonction de logging
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        // Gestion des onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Changer l'onglet actif
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');

                // Appliquer le filtre
                applyFilter(currentFilter);
                log(`Switched to tab: ${currentFilter}`);
            });
        });

        // Fonction applyFilter simulée
        function applyFilter(filterType) {
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                let isVisible = false;

                if (filterType === 'auto') {
                    isVisible = card.classList.contains('auto-fixable');
                } else if (filterType === 'manual') {
                    isVisible = card.classList.contains('manual-required');
                }

                card.style.display = isVisible ? 'block' : 'none';
                log(`Card ${card.querySelector('strong').textContent}: visible=${isVisible}`);
            });
        }

        // Fonction applyAllAutoFixes modifiée
        function applyAllAutoFixes() {
            log('=== applyAllAutoFixes called ===');

            // Vérifier que nous sommes sur l'onglet "Auto"
            if (currentFilter !== 'auto') {
                log(`IGNORED - onglet actif: ${currentFilter}`);
                showNotification('Cette action n\'est disponible que sur l\'onglet "Auto"', 'warning');
                return;
            }

            // Récupérer toutes les cartes auto-fixables visibles dans l'onglet actif
            var autoCards = Array.from(document.querySelectorAll('.card.auto-fixable'))
                .filter(card => card.style.display !== 'none');

            log(`Found ${autoCards.length} auto-fixable cards`);

            if (autoCards.length === 0) {
                log('No cards to process');
                return;
            }

            // Traiter chaque carte
            autoCards.forEach((card, index) => {
                const indices = JSON.parse(card.getAttribute('data-indices'));
                log(`Processing card ${index + 1}: ${card.querySelector('strong').textContent} with indices ${indices}`);

                // Simuler l'application de la correction
                applyGroupFix(indices, 'test-variable-id');
            });

            showNotification(`${autoCards.length} correction(s) appliquée(s)`, 'success');
        }

        // Attacher l'événement au bouton
        document.getElementById('applyAllAutoBtn').addEventListener('click', applyAllAutoFixes);

        // Initialiser
        applyFilter('auto');
        log('Page initialized - currentFilter: auto');
    </script>
</body>
</html>