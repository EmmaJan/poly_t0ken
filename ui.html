<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ============================================
       POLYCEA THEME - Variables CSS
       ============================================ */
    :root {
      --poly-bg: #07190F;
      --poly-surface: #0E2416;
      --poly-surface-soft: #122D1D;
      --poly-accent: #8AD53F;
      --poly-accent-rgb: 138, 213, 63;
      --poly-accent-hover: #A6E766;
      --poly-text: #F9FAFB;
      --poly-text-muted: #9CA3AF;
      --poly-border-subtle: #1F3A25;
      --poly-success: #16A34A;
      --poly-success-hover: #15803D;
      --poly-info: #2563EB;
      --poly-warning: #F59E0B;
      --poly-error: #DC2626;
      --poly-error-hover: #B91C1C;
      --poly-success-light: rgba(22, 163, 74, 0.1);
      --poly-error-light: rgba(220, 38, 38, 0.1);
      --poly-radius: 12px;
      --poly-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      --poly-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    /* ============================================
       RESIZE HANDLE STYLES
       ============================================ */

    /* Mise à jour du sélecteur pour cibler la nouvelle liste unifiée */
    #unifiedCleaningList {
      max-height: calc(100vh - 300px); /* Hauteur adaptative basée sur la fenêtre */
      overflow-y: auto;  /* Active le scroll si nécessaire */
      padding-right: 8px;
      display: block;    /* Force l'affichage */
      min-height: 50px;  /* Assure qu'elle ne soit pas écrasée à 0px */
    }

    /* Custom scrollbar for unified cleaning list */
    #unifiedCleaningList::-webkit-scrollbar {
      width: 6px;
    }

    #unifiedCleaningList::-webkit-scrollbar-track {
      background: var(--poly-surface-soft);
      border-radius: 3px;
    }

    #unifiedCleaningList::-webkit-scrollbar-thumb {
      background: var(--poly-accent);
      border-radius: 3px;
    }

    #unifiedCleaningList::-webkit-scrollbar-thumb:hover {
      background: var(--poly-accent-hover);
    }
    #resize-handle {
      opacity: 0.8;
      transition: all 0.2s ease;
    }

    #resize-handle:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Prevent selection during resize */
    .resizing * {
      user-select: none !important;
      cursor: nw-resize !important;
    }

    /* Prevent scroll during resize */
    .resizing {
      overflow: hidden !important;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--poly-bg);
      color: var(--poly-text);
      font-size: 14px;
      line-height: 1.5;
      position: relative; /* Pour le positionnement du handle de redimensionnement */
      min-width: 400px;
      min-height: 500px;
    }

    /* ============================================
       APP LAYOUT & HEADER
       ============================================ */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      background: var(--poly-surface);
      border-bottom: 1px solid var(--poly-border-subtle);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 72px;
      flex-shrink: 0;
      position: relative; /* Pour le debug si nécessaire */
    }

    .header-logo-section {
      flex: 0 0 auto; /* Ne prend que l'espace nécessaire */
      min-width: 0; /* Permet de réduire si nécessaire */
      max-width: 60%; /* Maximum 60% de la largeur du header */
      display: flex;
      align-items: center;
    }

    .header-controls {
      flex: 0 0 auto; /* Ne prend que l'espace nécessaire */
      margin-left: auto; /* Pousse vers la droite */
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      height: 32px !important;
      width: auto !important;
      min-width: 0 !important;
      object-fit: contain;
      display: block;
      flex-shrink: 0 !important;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }


    /* App body - Unique Scrollable Zone logic handled by steps */
    .app-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      height: 100%;
      overflow: hidden;
      padding: 20px;
      padding-bottom: 0 !important;
    }

    /* ============================================
       WIZARD STEPS & CARDS (The Logic)
       ============================================ */
    .wizard-step {
      display: none;
    }

    /* DEFAULT STATE (Steps 0, 1, 2): Hug Content & Page Scroll */
    .wizard-step.active {
      display: flex;
      flex-direction: column;
      height: auto;
      width: 100%;
    }

    /* Allow specific steps to scroll the page body */
    #wizardStep0.active,
    #wizardStep1.active,
    #wizardStep2.active {
      overflow-y: auto;
      height: 100%;
      display: block;
      padding-bottom: 120px;
      /* Clear footer */
    }

    #wizardStep4.active {
      overflow-y: visible;
      height: 100%;
      display: block;
      padding-bottom: 120px;
      /* Clear footer */
    }

    .card {
      display: flex;
      flex-direction: column;
      height: auto;
      flex-grow: 0;
      background: var(--poly-surface-soft);
      padding: 20px;
      border-radius: var(--poly-radius);
      border: 1px solid var(--poly-border-subtle);
      box-shadow: var(--poly-shadow-sm);
      margin-bottom: 20px;
    }

    /* --- STEP 0: No borders for sections --- */
    #wizardStep0 .card.choice-section {
      border: none;
      box-shadow: none;
    }

    /* --- No borders for correction cards --- */
    .cleaning-result-card {
      border: none;
      box-shadow: none;
    }


    /* --- STEP 3 EXCEPTION: Full Height & Internal Scroll --- */
    #wizardStep3.active {
      height: 100%;
      flex: 1;
      overflow: hidden;
      /* No outer scroll */
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #wizardStep3 .card {
      height: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      /* Allows children to shrink */
      margin-bottom: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
      padding-bottom: 0;
      overflow: visible; /* Remove scroll from card container */
    }

    /* ============================================
       DESIGNER & DEV VIEWS (Step 3)
       ============================================ */

    /* Designer View (Token Table) */
    #designerView {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      /* Remove scroll from designer view - only unified list should scroll */
      overflow: visible;
      padding: 0 4px 120px 0;
      /* Bottom padding for footer */
    }

    /* Developer View (Code Editor) */
    #devView {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      gap: 0;
      min-height: 0;
      /* CRITICAL for scroll */
    }

    /* Spacing fixes for Dev View */
    #devView h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--poly-text);
    }

    #devView p {
      margin: 0 0 20px 0;
      font-size: 13px;
      color: var(--poly-text-muted);
      line-height: 1.4;
    }

    #devView label {
      display: block;
      margin-bottom: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--poly-text-muted);
    }

    #devView select {
      margin-bottom: 16px;
      width: 100%;
    }

    /* Code Editor Wrapper & Container */
    .editor-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--poly-border-subtle);
      border-radius: 8px;
      min-height: 0;
      /* CRITICAL for scroll */
    }

    .editor-container {
      flex: 1;
      background: #1E1E1E;
      border: none;
      border-radius: 0;
      overflow: auto;
      /* Internal Scroll */
      padding: 16px 16px 120px 16px;
      /* Huge bottom padding */
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #D4D4D4;
      white-space: pre;
      user-select: text;
      cursor: text;
    }

    /* Syntax Highlighting */
    .syn-key {
      color: #9CDCFE;
    }

    .syn-string {
      color: #CE9178;
    }

    .syn-number {
      color: #B5CEA8;
    }

    .syn-comment {
      color: #6A9955;
    }

    .syn-kwd {
      color: #C586C0;
    }

    .syn-punc {
      color: #D4D4D4;
    }

    /* ============================================
       COMPONENTS (Inputs, Buttons, etc.)
       ============================================ */
    .card h3 {
      margin: 0 0 16px;
      font-size: 15px;
      font-weight: 600;
      color: var(--poly-text);
    }

    .card p {
      color: var(--poly-text-muted);
      font-size: 13px;
      margin: 0 0 12px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--poly-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid var(--poly-border-subtle);
      margin-bottom: 14px;
      font-family: inherit;
      background: var(--poly-surface);
      color: var(--poly-text);
      transition: all 0.2s;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--poly-accent);
      box-shadow: 0 0 0 3px rgba(138, 213, 63, 0.15);
    }

    /* Color Input Group */
    .color-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      /* Center alignment */
      margin-bottom: 14px;
      width: 100%;
    }

    /* Middle Input Wrapper */
    .color-input-wrapper {
      flex: 1;
      display: flex;
    }

    /* Force input to match height and remove margin inside group */
    .color-input-group input[type="text"] {
      margin-bottom: 0;
      height: 48px;
    }

    /* Ensure button doesn't look weird */
    .color-input-group button {
      height: 48px;
      width: auto !important;
      /* Force auto width */
      flex-shrink: 0;
      margin: 0;
      /* Remove default margins if any */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .color-preview {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: 2px solid var(--poly-border-subtle);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .color-preview:hover {
      border-color: var(--poly-accent);
    }

    .color-preview input[type="color"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      opacity: 0;
    }

    .color-preview-bg {
      width: 100%;
      height: 100%;
    }

    /* Buttons */
    button {
      background: var(--poly-accent);
      color: var(--poly-bg);
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--poly-accent-hover);
      transform: translateY(-1px);
    }

    button:disabled {
      background: var(--poly-surface-soft);
      color: var(--poly-text-muted);
      border: 1px solid var(--poly-border-subtle);
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }

    .btn-secondary {
      background: var(--poly-surface);
      color: var(--poly-text);
      border: 1px solid var(--poly-border-subtle);
    }

    .btn-secondary:hover {
      background: var(--poly-surface-soft);
      border-color: var(--poly-accent);
    }

    .btn-icon {
      background: transparent;
      border: none;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 14px;
      opacity: 0.6;
      width: auto;
    }

    .btn-icon:hover {
      opacity: 1;
      color: var(--poly-error);
    }

    .btn-icon svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    /* Tabs */

    /* Onglets de génération de tokens - style original restauré */
    #tokenTabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--poly-surface);
      padding: 6px;
      border: 1px solid rgba(138, 213, 63, 0.3);
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #tokenTabs .tab {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      border: none;
      background: transparent;
      color: var(--poly-text-muted);
      transition: all 0.2s ease;
      position: relative;
      text-transform: none;
      letter-spacing: normal;
    }

    #tokenTabs .tab.active {
      background: var(--poly-accent);
      color: var(--poly-bg);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(138, 213, 63, 0.3);
    }

    #tokenTabs .tab:hover:not(.active) {
      color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.1);
      transform: translateY(-1px);
    }

    #tokenTabs .tab:focus:not(.active) {
      outline: none;
      color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.1);
      box-shadow: 0 0 0 2px rgba(138, 213, 63, 0.2);
    }

    /* Locked Banner */
    .locked-banner {
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(138, 213, 63, 0.1);
      border: 1px solid rgba(138, 213, 63, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--poly-accent);
    }

    .locked-banner-text {
      font-size: 12px;
      font-weight: 500;
      color: var(--poly-text);
      line-height: 1.4;
    }

    .locked-banner-sub {
      font-size: 11px;
      color: var(--poly-text-muted);
      display: block;
      margin-top: 2px;
    }

    /* Mode Toggle */
    .mode-toggle {
      display: inline-flex;
      background: var(--poly-surface);
      border: 1px solid var(--poly-border-subtle);
      border-radius: 6px;
      padding: 2px;
      gap: 2px;
    }

    .mode-toggle-btn {
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      border: none;
      background: transparent;
      color: var(--poly-text-muted);
      border-radius: 4px;
      cursor: pointer;
      text-transform: uppercase;
    }

    .mode-toggle-btn.active {
      background: var(--poly-accent);
      color: var(--poly-bg);
    }

    .mode-toggle-btn:hover,
    .mode-toggle-btn:focus {
      background: rgba(138, 213, 63, 0.15);
      color: var(--poly-accent);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .mode-toggle-btn.active:hover,
    .mode-toggle-btn.active:focus {
      background: var(--poly-accent-hover);
      color: var(--poly-bg);
    }

    .hidden {
      display: none !important;
    }

    /* Library Grid & Icons */
    .library-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    /* --- LIBRARY CARD STYLES (Harmonized with Step 0) --- */

    /* 1. The Container (Card) */
    .library-option {
      background: var(--poly-surface);
      padding: 20px;
      border-radius: var(--poly-radius);
      border: 2px solid var(--poly-border-subtle);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--poly-text);
      min-height: 110px; /* Increased slightly for the circle */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* 2. Hover on Card (Lift effect) */
    .library-option:hover {
      border-color: var(--poly-accent);
      background: var(--poly-surface-soft);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .library-option.selected {
      border-color: var(--poly-accent);
      background: var(--poly-surface-soft);
      color: var(--poly-accent);
      box-shadow: 0 0 0 3px rgba(138, 213, 63, 0.15);
    }

    /* 3. The Icon (Circle Style) */
    .library-option .icon {
      display: flex;
      align-items: center;
      justify-content: center;

      /* Dimensions (Match Step 0) */
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;

      /* Shape & Color */
      border-radius: 50%;
      background: var(--poly-surface-soft);
      border: 1px solid var(--poly-border-subtle);
      color: var(--poly-accent);

      margin-bottom: 8px;
      flex-shrink: 0 !important;
      transition: all 0.2s ease;
    }

    /* 4. Hover on Icon (Invert Colors + Scale) */
    .library-option:hover .icon,
    .library-option.selected .icon {
      background: var(--poly-accent);
      border-color: var(--poly-accent);
      color: var(--poly-bg) !important; /* Icon turns dark */
      transform: scale(1.1);
    }


    /* Choice Grid (Vue 0) */
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .choice-card {
      background: var(--poly-surface);
      border: 1px solid var(--poly-border-subtle);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      height: 100%;
    }

    .choice-card:hover {
      border-color: var(--poly-accent);
      background: var(--poly-surface-soft);
    }

    .choice-card.active {
      border-color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.05);
      box-shadow: 0 0 0 1px var(--poly-accent);
    }

    .choice-card .icon {
      border-radius: 50%;
      background: var(--poly-surface-soft);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--poly-accent);
      margin-bottom: 8px;
      border: 1px solid var(--poly-border-subtle);
    }

    /* Hover and active effects for choice-card icons (make them dark) */
    .choice-card:hover .icon,
    .choice-card.active .icon {
      background: var(--poly-accent);
      border-color: var(--poly-accent);
      color: var(--poly-bg) !important; /* Icon turns dark */
      transform: scale(1.1);
    }

    .choice-card .icon svg {
      width: 20px;
      height: 20px;
    }

    /* Sticky Footer */
    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(14, 36, 22, 0.95);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--poly-border-subtle);
      padding: 12px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
    }

    .sticky-footer-content {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    .footer-signature {
      font-size: 10px;
      color: var(--poly-text-muted);
      opacity: 0.7;
    }

    .footer-signature a {
      color: var(--poly-accent-hover);
      text-decoration: none;
      border-bottom: 1px dotted var(--poly-text-muted);
    }

    /* Token Table */
    .token-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .token-table th {
      text-align: left;
      padding: 6px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--poly-text-muted);
      text-transform: uppercase;
      border-bottom: 2px solid var(--poly-border-subtle);
    }

    .token-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--poly-border-subtle);
      font-size: 12px;
      vertical-align: middle;
    }

    .token-table tr:hover {
      background: rgba(138, 213, 63, 0.05);
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--poly-border-subtle);
      display: inline-block;
    }

    .table-input {
      width: 100%;
      border: 1px solid transparent;
      background: transparent;
      padding: 3px 6px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      border-radius: 4px;
      color: inherit;
    }

    .table-input.locked {
      cursor: default;
      pointer-events: none;
      opacity: 1;
      color: var(--poly-text-muted);
      border: 1px solid transparent;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .token-table tr {
      opacity: 0;
      animation: fadeInUp 0.3s ease forwards;
    }

    .token-table tr:nth-child(1) {
      animation-delay: 0.05s;
    }

    .token-table tr:nth-child(2) {
      animation-delay: 0.1s;
    }

    .token-table tr:nth-child(3) {
      animation-delay: 0.15s;
    }

    .token-table tr:nth-child(4) {
      animation-delay: 0.2s;
    }

    .token-table tr:nth-child(5) {
      animation-delay: 0.25s;
    }

    .token-table tr:nth-child(6) {
      animation-delay: 0.3s;
    }

    .token-table tr:nth-child(7) {
      animation-delay: 0.35s;
    }

    .token-table tr:nth-child(8) {
      animation-delay: 0.4s;
    }

    .token-table tr:nth-child(9) {
      animation-delay: 0.45s;
    }

    .token-table tr:nth-child(10) {
      animation-delay: 0.5s;
    }

    /* Popular Badge */
    .popular-badge {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(180, 220, 80, 0.2);
      color: #B4DC50;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-radius: 4px;
      border: 1px solid rgba(180, 220, 80, 0.3);
      line-height: 1.2;
    }

    .file-info:hover {
      border-color: var(--poly-accent);
    }

    /* ============================================
       UTILITY CLASSES
       ============================================ */
    .hidden {
      display: none !important;
    }

    .text-sm {
      font-size: 12px;
    }

    /* ============================================
       TEXTAREA (for export)
       ============================================ */
    textarea {
      background: var(--poly-surface);
      color: var(--poly-text);
      border: 1px solid var(--poly-border-subtle);
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: var(--poly-accent);
      box-shadow: 0 0 0 3px rgba(138, 213, 63, 0.15);
    }

    /* ============================================
       CHECKBOX STYLING
       ============================================ */
    input[type="checkbox"] {
      accent-color: var(--poly-accent);
      cursor: pointer;
    }

    /* ============================================
       NOUVELLE INTERFACE NETTOYAGE - Hiérarchie claire
       ============================================ */

    /* Tableau de bord récapitulatif */
    .cleaning-dashboard {
      background: var(--poly-surface-soft);
      border: 1px solid var(--poly-border-subtle);
      border-radius: var(--poly-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--poly-shadow-sm);
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .dashboard-stats {
      display: flex;
      gap: 16px;
    }

    .stat-item {
      text-align: center;
      min-width: 60px;
    }

    .stat-number {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--poly-accent);
      line-height: 1;
    }

    .stat-label {
      font-size: 10px;
      color: var(--poly-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* ============================================
       FILTER SYSTEM (remplace les onglets)
       ============================================ */

    .content-header {
      margin-bottom: 16px;
    }

    .content-header h5 {
      margin-bottom: 4px;
    }

    .filter-system {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .filter-buttons {
      display: flex;
      gap: 4px;
      background: var(--poly-surface);
      padding: 6px;
      border: 1px solid rgba(138, 213, 63, 0.3);
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      border: none;
      background: transparent;
      color: var(--poly-text-muted);
      transition: all 0.2s ease;
      position: relative;
      text-transform: none;
      letter-spacing: normal;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .filter-btn:hover:not(.active) {
      color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.1);
      transform: translateY(-1px);
    }

    .filter-btn.active {
      background: var(--poly-accent);
      color: var(--poly-bg);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(138, 213, 63, 0.3);
    }

    .filter-count {
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
    }

    .filter-btn.active .filter-count {
      background: rgba(7, 25, 15, 0.3);
    }

    .filter-actions {
      display: flex;
      gap: 8px;
    }

    /* ============================================
       BULK ACTIONS ENHANCED
       ============================================ */

    .bulk-actions-enhanced {
      animation: slideUp 0.3s ease-out;
    }

    .bulk-stats {
      font-size: 14px;
      color: var(--poly-text);
    }

    .selection-info {
      font-weight: 500;
    }

    .progress-bar {
      position: relative;
      background: var(--poly-surface-soft);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--poly-accent), var(--poly-accent-hover));
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .bulk-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .bulk-buttons .btn-primary,
    .bulk-buttons .btn-outline {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-icon {
      font-size: 16px;
    }

    .btn-count {
      opacity: 0.8;
      font-weight: 400;
    }

    /* ============================================
       ANIMATIONS ET TRANSITIONS
       ============================================ */

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* ============================================
       LOADING STATES
       ============================================ */

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--poly-accent);
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes loadingPulse {
      0%, 100% { width: 30%; opacity: 1; }
      50% { width: 70%; opacity: 0.7; }
    }

    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading .btn-text::after {
      content: " (en cours...)";
      font-weight: 400;
    }

    /* ============================================
       ENHANCED EMPTY STATES
       ============================================ */

    .empty-state-enhanced {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, var(--poly-surface-soft), var(--poly-surface));
      border-radius: var(--poly-radius);
      border: 1px dashed var(--poly-border-subtle);
    }

    .empty-state-enhanced .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      opacity: 0.6;
      background: linear-gradient(135deg, var(--poly-accent), var(--poly-accent-hover));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }

    .empty-state-enhanced h3 {
      margin-bottom: 12px;
      font-size: 20px;
      font-weight: 600;
      color: var(--poly-text);
    }

    .empty-state-enhanced p {
      margin-bottom: 24px;
      color: var(--poly-text-muted);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .empty-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .empty-actions .btn-primary,
    .empty-actions .btn-secondary {
      padding: 12px 24px;
      font-size: 14px;
    }

    /* ============================================
       CHECKBOXES ET SÉLECTIONS
       ============================================ */

    .item-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--poly-border-subtle);
      border-radius: 4px;
      background: var(--poly-surface);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .item-checkbox:checked {
      background: var(--poly-accent);
      border-color: var(--poly-accent);
    }

    .item-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .item-checkbox:hover {
      border-color: var(--poly-accent);
    }

    .cleaning-result-card:hover {
      border-color: var(--poly-accent);
      box-shadow: var(--poly-shadow-sm);
      transform: translateY(-1px);
    }

    /* Padding supplémentaire pour la première carte au hover pour éviter le crop */
    .cleaning-result-card:first-child:hover {
      margin-top: 4px;
    }

    .cleaning-result-card.selected {
      border-color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.05);
    }

    /* ============================================
       RESPONSIVE DESIGN AMÉLIORÉ
       ============================================ */

    @media (max-width: 800px) {
      .filter-system {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .filter-buttons {
        justify-content: center;
      }

      .bulk-buttons {
        flex-direction: column;
      }

      .bulk-buttons .btn-primary,
      .bulk-buttons .btn-outline {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 600px) {
      .cleaning-result-card {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
        padding: 12px;
      }

    }

    /* Contenu des onglets */
    .tab-content {
      min-height: 200px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* En-têtes de section */
    .section-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 16px;
      align-items: flex-start;
    }

    .section-header h5 {
      margin: 0 0 4px 0;
      color: var(--poly-text);
      font-size: 14px;
      font-weight: 600;
    }

    .section-desc {
      margin: 0;
      font-size: 12px;
      color: var(--poly-text-muted);
      line-height: 1.4;
    }

    /* Actions groupées */
    .bulk-actions {
      margin-top: 16px;
      padding: 16px;
      background: var(--poly-surface-soft);
      border-radius: 8px;
      text-align: center;
    }

    .bulk-actions .btn-primary {
      padding: 10px 20px;
      font-size: 13px;
    }

    /* État vide pour les onglets */
    .status-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--poly-text-muted);
    }

    .status-empty span {
      display: block;
      margin-bottom: 8px;
    }

    /* Amélioration des cartes de résultats - Structure Header + Body */
    .cleaning-result-card {
      display: flex;
      flex-direction: column;
      padding: 12px 16px;
      background: var(--poly-surface);
      border: 1px solid rgba(138, 213, 63, 0.3);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    /* Conteneur de grille pour les cartes de nettoyage */
    .cleaning-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    /* Ajustements pour les cartes en grille */
    .cleaning-cards-grid .cleaning-result-card {
      margin-bottom: 0;
    }

    /* Responsive pour la grille */
    @media (max-width: 600px) {
      .cleaning-cards-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }

    .cleaning-result-card:hover {
      border-color: var(--poly-accent);
    }

    /* Styles pour la structure Header + Body */
    .cleaning-result-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .cleaning-result-card .card-body {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Style spécifique pour les cartes Auto-Fix (Design Row) */
    .cleaning-result-card.auto-fixable {
      display: flex;
      flex-direction: column;
      padding: 12px 16px;
      background: var(--poly-surface);
      border: 1px solid rgba(138, 213, 63, 0.3);
      border-radius: 12px;
      margin-bottom: 8px;
    }


    .auto-card-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .property-badge {
      align-self: flex-start;
      background: rgba(138, 213, 63, 0.15);
      color: var(--poly-accent);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      padding: 3px 6px 1px 6px;
      border-radius: 4px;
      margin-bottom: 0;
      line-height: 1;
    }

    .transformation-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      color: #fff;
    }

    .trans-arrow {
      color: #6B7280;
      font-size: 12px;
    }

    .var-name {
      color: var(--poly-accent);
      font-weight: 600;
      font-family: monospace;
    }

    .var-value-muted {
      color: #6B7280;
      font-size: 12px;
    }

    /* Zone Actions à droite */
    .auto-card-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-see-layers {
      background: rgba(255, 255, 255, 0.1);
      color: #E5E7EB;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
      width: fit-content;
    }

    .btn-see-layers:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Styles pour les cartes manuelles */
    .manual-card-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .value-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      color: #fff;
    }

    .variable-selector-row {
      margin-top: 4px;
    }

    .manual-card-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .manual-apply-btn:disabled {
      background: #374151 !important;
      color: #6B7280 !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }


    .cleaning-result-card.manual-fix {
      border-left: 4px solid var(--poly-warning);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    /* Indicateurs de priorité */
    .priority-indicator {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 12px;
    }

    .priority-indicator.auto {
      background: var(--poly-success);
      color: white;
    }

    .priority-indicator.manual {
      background: var(--poly-warning);
      color: white;
    }

    /* Actions globales */
    .global-actions {
      background: var(--poly-surface-soft);
      border-radius: 8px;
      padding: 16px;
    }

    .global-actions .btn-outline {
      border: 1px solid var(--poly-border-subtle);
      background: transparent;
      color: var(--poly-text);
    }

    .global-actions .btn-outline:hover {
      background: var(--poly-surface);
      border-color: var(--poly-accent);
    }

    /* Bouton Voir avec fond légèrement vert */
    .btn-view {
      background: rgba(138, 213, 63, 0.1) !important;
      border-color: rgba(138, 213, 63, 0.3) !important;
      color: var(--poly-accent) !important;
    }

    .btn-view:hover {
      background: rgba(138, 213, 63, 0.2) !important;
      border-color: var(--poly-accent) !important;
    }

    /* Jauge de progression circulaire */
    .progress-gauge {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .progress-circle {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .progress-circle svg {
      width: 100%;
      height: 100%;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-weight: 600;
      color: var(--poly-text);
    }

    #progressPercentage {
      font-size: 18px;
      line-height: 1;
    }

    .percent-symbol {
      font-size: 12px;
      color: var(--poly-text-muted);
    }

    .progress-label {
      font-size: 11px;
      color: var(--poly-text-muted);
      text-align: center;
      font-weight: 500;
    }

    /* Responsive pour la jauge de progression */
    @media (max-width: 600px) {
      .content-header {
        flex-direction: column !important;
        gap: 16px !important;
      }

      .progress-gauge {
        align-self: center;
      }

      .progress-circle {
        width: 70px;
        height: 70px;
      }

      .progress-circle svg {
        width: 100%;
        height: 100%;
      }

      #progressPercentage {
        font-size: 16px;
      }

      .percent-symbol {
        font-size: 10px;
      }
    }

    /* Mini-swatches pour les couleurs */
    .mini-swatch {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid var(--poly-border-subtle);
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* Indicateurs de statut pour les cartes */
    .cleaning-result-card.ready-to-apply {
      border-color: var(--poly-success);
      background: rgba(22, 163, 74, 0.05);
    }

    /* Labels de propriétés */
    .property-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--poly-accent);
      background: var(--poly-surface);
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cleaning-result-card.ready-to-apply .priority-indicator.manual {
      background: var(--poly-success);
      color: white;
    }

    /* Améliorations pour les sélecteurs manuels */
    .manual-select {
      transition: border-color 0.2s ease;
    }

    .manual-select:focus {
      outline: none;
      border-color: var(--poly-accent);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    /* Animation pour les notifications */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Boutons d'action dans les cartes de correction et scan */
    .cleaning-result-card .btn-primary,
    .cleaning-result-card .btn-outline,
    .cleaning-result-card .btn-x,
    .scan-result-card .btn-primary,
    .scan-result-card .btn-outline,
    .scan-result-card .btn-x {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .cleaning-result-card .btn-primary svg,
    .cleaning-result-card .btn-outline svg,
    .cleaning-result-card .btn-x svg,
    .scan-result-card .btn-primary svg,
    .scan-result-card .btn-outline svg,
    .scan-result-card .btn-x svg {
      width: 16px;
      height: 16px;
    }

    /* Améliorations responsive */
    @media (max-width: 600px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .tab-buttons {
        flex-wrap: wrap;
      }

      .tab-btn {
        flex: 1;
        min-width: 120px;
        font-size: 12px;
      }

      .cleaning-result-card {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .cleaning-result-card .btn-primary {
        width: 100%;
        max-width: none;
      }

      .global-actions {
        flex-direction: column;
        gap: 8px;
      }

      .global-actions .btn-secondary,
      .global-actions .btn-primary {
        width: 100%;
      }
    }

    /* ============================================
       TOKEN EDIT BUTTONS
       ============================================ */
    .btn-icon {
      background: transparent;
      border: none;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity 0.2s;
      width: auto;
    }

    .btn-icon:hover {
      opacity: 1;
      transform: none;
      box-shadow: none;
    }

    /* ============================================
       MODAL
       ============================================ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--poly-surface);
      padding: 24px;
      border-radius: var(--poly-radius);
      border: 1px solid var(--poly-border-subtle);
      max-width: 400px;
      width: 90%;
      box-shadow: var(--poly-shadow);
    }

    .modal-content h3 {
      margin: 0 0 16px;
      color: var(--poly-text);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    /* ============================================
       INLINE ICONS
       ============================================ */
    .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.2em;
      height: 1.2em;
      margin-right: 6px;
      vertical-align: middle;
      line-height: 1;
    }

    h3 .icon {
      font-size: 1.1em;
      margin-right: 8px;
      vertical-align: text-bottom;
    }

    button .icon {
      margin-right: 4px;
      vertical-align: middle;
    }

    .btn-secondary .icon {
      font-size: 0.95em;
    }

    .btn-icon {
      font-size: 14px;
      line-height: 1;
    }

    /* ============================================
       WIZARD STYLES
       ============================================ */
    .wizard-step {
      display: none;
    }

    /* 1. Allow the step container to shrink */
    .wizard-step.active {
      display: flex;
      flex-direction: column;
      /* REMOVED: flex: 1 and height: 100% */
      height: auto;
      width: 100%;
    }

    /* EXCEPTION: Step 3 (Dashboard) MUST be Full Height */
    #wizardStep3.active {
      height: 100%;
      flex: 1;
      overflow: hidden;
    }

    /* Cards de choix (Vue 0) */
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    /* Sections organisées */
    .choice-section {
      padding: 20px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, var(--poly-surface) 0%, var(--poly-surface-soft) 100%);
      border: 1px solid var(--poly-accent);
      border-radius: var(--poly-radius);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25);
    }

    .choice-section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .section-icon {
      font-size: 16px;
      opacity: 0.8;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--poly-accent);
      margin: 0;
    }

    /* Variations de couleur pour chaque section */
    .section-create {
      background: linear-gradient(135deg, rgba(10, 36, 22, 0.95) 0%, rgba(18, 45, 29, 0.95) 100%);
      border-left: 3px solid var(--poly-accent);
    }

    .section-analyze {
      background: linear-gradient(135deg, var(--poly-surface-soft) 0%, rgba(var(--poly-accent-rgb, 0.05), 0.05) 100%);
      border-left: 3px solid #4ADE80;
    }

    .choice-card {
      background: var(--poly-surface);
      border: 1px solid var(--poly-border-subtle);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      height: 100%;
    }

    .choice-card:hover {
      border-color: var(--poly-accent);
      background: var(--poly-surface-soft);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .choice-card .icon {
      /* Forme ronde pour éviter l'effet checkbox */
      border-radius: 50%;
      background: var(--poly-surface-soft);
      /* Fond plus neutre par défaut */
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--poly-accent);
      margin-bottom: 8px;
      transition: all 0.2s ease;
      border: 1px solid var(--poly-border-subtle);
    }

    .choice-card:hover .icon,
    .choice-card.active .icon {
      background: var(--poly-accent);
      color: var(--poly-bg);
      border-color: var(--poly-accent);
      transform: scale(1.1);
    }

    /* État actif sélectionné */
    .choice-card.active {
      border-color: var(--poly-accent);
      background: rgba(138, 213, 63, 0.05);
      box-shadow: 0 0 0 1px var(--poly-accent);
    }



    /* Footer Sticky pour les boutons d'action */
    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--poly-surface);
      border-top: 1px solid var(--poly-border-subtle);
      padding: 12px 20px;
      display: flex;
      flex-direction: column;
      /* Stack bouton et signature */
      align-items: center;
      /* Aligner à droite */
      gap: 8px;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
    }

    .sticky-footer-content {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      /* Boutons à droite */
      align-items: center;
      gap: 12px;
    }

    /* Cas particulier pour les steps avec bouton retour à gauche */
    .sticky-footer-content.space-between {
      justify-content: space-between;
    }

    .footer-signature {
      font-size: 10px;
      color: var(--poly-text-muted);
      text-align: right;
      opacity: 0.7;
    }

    .footer-signature a {
      color: var(--poly-accent-hover);
      text-decoration: none;
      border-bottom: 1px dotted var(--poly-text-muted);
      transition: color 0.2s;
    }

    .footer-signature a:hover {
      color: var(--poly-accent);
      border-bottom-color: var(--poly-accent);
    }

    /* SVG styling dans les cartes */
    .choice-card .icon svg {
      width: 20px;
      height: 20px;
      stroke-width: 2;
    }

    .choice-card h3 {
      font-size: 13px;
      font-weight: 600;
      margin: 0;
      color: var(--poly-text);
    }

    .choice-card p {
      font-size: 13px;
      /* Plus lisible */
      color: var(--poly-text-muted);
      margin: 0;
      line-height: 1.4;
    }

    /* Bouton supprimer SVG */
    .btn-icon svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    /* Library Grid (Vue 1) */
    .library-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    /* --- LIBRARY CARD STYLES (Harmonized with Step 0) --- */


/* Ajustement de l'SVG à l'intérieur */
.library-option .icon svg {
  width: 20px;
  height: 20px;
  display: block;
  flex-shrink: 0;
  /* On retire object-fit qui ne sert à rien sur un SVG inline */
}

/* Ajustement spécifique pour l'icône des variables (viewBox 90x104) */
#choiceManageTokens .icon svg {
  width: 18px;
  height: 20px;
}

    /* 4. Hover on Icon (Invert Colors + Scale) */
    .library-option:hover .icon,
    .library-option.selected .icon {
      background: var(--poly-accent);
      border-color: var(--poly-accent);
      color: var(--poly-bg) !important; /* Icon turns dark */
      transform: scale(1.1);
    }


    .popular-badge {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(180, 220, 80, 0.2);
      color: #B4DC50;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-radius: 4px;
      border: 1px solid rgba(180, 220, 80, 0.3);
      line-height: 1.2;
    }

    /* ============================================
       VARIABLE SELECTOR STYLES
       ============================================ */

    .variable-selector {
      transition: all 0.2s ease;
    }

    .variable-selector:hover {
      opacity: 0.9;
    }

    .variable-selector:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(138, 213, 63, 0.3);
    }

    .variable-badge.exact-match {
      transition: all 0.2s ease;
    }

    .variable-badge.exact-match:hover {
      opacity: 0.9;
    }

    /* ============================================
       COMPACT TABLE STYLES - Scan Results UX
       ============================================ */

    /* Catégories Pliables */
    details.category-group {
      margin-bottom: 12px;
      border: 1px solid var(--poly-border-subtle);
      border-radius: 8px;
      background: var(--poly-surface);
      overflow: hidden;
    }

    summary.category-header {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      list-style: none; /* Cache la flèche par défaut */
    }

    summary.category-header:hover { background: rgba(255, 255, 255, 0.05); }

    /* Style pour les détails ouverts/fermés */
    details.category-group summary::before {
      content: "▶";
      margin-right: 8px;
      transition: transform 0.2s;
      color: var(--poly-accent);
    }

    details.category-group[open] summary::before {
      transform: rotate(90deg);
    }

    /* Cacher la flèche par défaut */
    details.category-group summary::-webkit-details-marker {
      display: none;
    }

    /* Lignes Compactes - Nouvelle structure Grid */
    .compact-row {
      display: grid;
      grid-template-columns: 1.5fr 0.8fr 2fr 30px; /* Grille précise */
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--poly-border-subtle);
      gap: 16px;
      transition: background 0.1s;
      margin-bottom: 8px;
    }

    .compact-row:hover {
      background: var(--poly-surface-soft);
    }

    /* Colonne Problème (Valeur Actuelle) */
    .col-problem {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Monaco', monospace;
      font-size: 12px;
      color: var(--poly-text);
    }


    .value-display {
      font-weight: bold;
    }

    .mini-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid var(--poly-border-subtle);
      display: inline-block;
    }

    /* Colonne Flèche (Lien) */
    .col-arrow {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
    }

    .arrow-symbol {
      font-size: 14px;
      color: var(--poly-text-muted);
    }

    .layer-count-badge {
      font-size: 9px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      cursor: inherit;
      margin-top: 6px;
      transition: all 0.2s;
    }

    .layer-count-badge:hover {
      background: var(--poly-accent);
      color: #000;
    }

    /* Colonne Solution (Variable) */
    .col-solution {
      display: flex;
      align-items: center;
      width: 100%;
    }

    .variable-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 6px 10px;
      background: rgba(138, 213, 63, 0.1);
      border: 1px solid rgba(138, 213, 63, 0.3);
      border-radius: 6px;
      color: var(--poly-accent);
      font-weight: 500;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .variable-pill:hover {
      background: var(--poly-accent);
      color: #000;
    }

    .variable-icon {
      width: 12px;
      height: 12px;
      opacity: 0.7;
    }

    /* Selecteur en cas de conflit */
    .conflict-select {
      width: 100%;
      padding: 6px 10px;
      border-radius: 6px;
      background: var(--poly-surface);
      color: var(--poly-warning);
      border: 1px solid var(--poly-warning);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .conflict-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
    }

    /* Bouton Ignorer (X) */
    .btn-x {
      background: transparent;
      border: none;
      color: var(--poly-text-muted);
      cursor: pointer;
      font-size: 14px;
      padding: 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-x:hover {
      color: var(--poly-error);
      background: rgba(239, 68, 68, 0.1);
    }

    /* Bouton Tout Corriger */
    .btn-fix-all {
      background: var(--poly-accent);
      color: var(--poly-bg);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-fix-all:hover {
      background: var(--poly-accent-hover);
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- ============================================
         HEADER RECONÇU - Structure optimisée
         - Logo dans section dédiée avec contraintes flexibles
         - Contrôles séparés pour éviter les conflits d'espace
         ============================================ -->
    <header class="app-header">
      <!-- Logo Section - Priorité haute -->
      <div class="header-logo-section">
        <svg xmlns="http://www.w3.org/2000/svg" width="329" height="36" viewBox="0 0 329 36" fill="none">
          <path d="M1.48278 25.3976C1.48278 31.1143 5.81112 35.7461 11.1594 35.7461H17.022V30.4083H12.2736C9.06809 30.4083 7.03677 27.6275 7.03677 24.2009V20.6711L4.16549 17.8731L7.03677 15.075V11.5452C7.03677 8.11864 9.06809 5.33781 12.2736 5.33781L17.022 5.33781V5.1252e-07L11.1594 0C5.8197 -4.66813e-07 1.48278 4.63184 1.48278 10.3485L1.48278 12.7419L6.27715e-07 14.2916L0 21.4718L1.48278 23.0215L1.48278 25.4149V25.3976Z" fill="#96D700"/>
          <path d="M22.9807 27.3276C21.3063 27.3276 19.9595 26.6997 18.9403 25.4438C17.9392 24.1698 17.4387 22.4317 17.4387 20.2294C17.4387 18.7552 17.7026 17.4902 18.2304 16.4346C18.7765 15.379 19.4772 14.5691 20.3326 14.0049C21.2062 13.4225 22.1162 13.1313 23.0626 13.1313C23.8089 13.1313 24.4368 13.2587 24.9464 13.5135C25.456 13.7683 25.9383 14.1141 26.3933 14.5509L26.2295 12.476V7.86224H30.2427V27H26.9666L26.6936 25.6622H26.5844C26.1112 26.1354 25.5561 26.5358 24.9191 26.8635C24.2821 27.1729 23.636 27.3276 22.9807 27.3276ZM24.0182 24.0515C24.455 24.0515 24.8554 23.9605 25.2194 23.7785C25.5834 23.5965 25.9201 23.278 26.2295 22.823V17.2809C25.8837 16.9533 25.5197 16.7258 25.1375 16.5984C24.7553 16.471 24.3731 16.4073 23.9909 16.4073C23.5541 16.4073 23.1536 16.5438 22.7896 16.8168C22.4256 17.0898 22.1253 17.5085 21.8887 18.0727C21.6703 18.6187 21.5611 19.3194 21.5611 20.1748C21.5611 21.5034 21.7795 22.4863 22.2163 23.1233C22.6531 23.7421 23.2538 24.0515 24.0182 24.0515Z" fill="white"/>
          <path d="M39.8591 27.3276C38.5669 27.3276 37.4021 27.0455 36.3646 26.4812C35.3272 25.917 34.5082 25.1071 33.9076 24.0515C33.307 22.9959 33.0067 21.7218 33.0067 20.2294C33.0067 18.7552 33.307 17.4902 33.9076 16.4346C34.5264 15.379 35.3272 14.5691 36.31 14.0049C37.2929 13.4225 38.3212 13.1313 39.395 13.1313C40.6872 13.1313 41.7611 13.4225 42.6165 14.0049C43.4719 14.5691 44.1089 15.3426 44.5275 16.3254C44.9461 17.3082 45.1554 18.4094 45.1554 19.6288C45.1554 19.9746 45.1372 20.3204 45.1008 20.6662C45.0644 20.9938 45.028 21.2577 44.9916 21.4579H36.1189L36.0643 18.6733H41.7156C41.7156 17.9635 41.5427 17.381 41.1969 16.926C40.851 16.4528 40.2777 16.2162 39.4769 16.2162C39.0401 16.2162 38.6124 16.3345 38.1938 16.5711C37.7752 16.8077 37.4294 17.2172 37.1564 17.7997C36.8834 18.3821 36.756 19.192 36.7742 20.2294C36.7924 21.2486 36.9744 22.0494 37.3202 22.6319C37.6842 23.2143 38.1392 23.6329 38.6852 23.8877C39.2312 24.1243 39.8045 24.2426 40.4051 24.2426C40.9329 24.2426 41.4335 24.1698 41.9067 24.0242C42.3981 23.8604 42.8804 23.642 43.3536 23.369L44.664 25.826C43.9906 26.2992 43.2262 26.6724 42.3708 26.9454C41.5154 27.2002 40.6781 27.3276 39.8591 27.3276Z" fill="white"/>
          <path d="M51.9145 27.3276C51.0226 27.3276 50.1035 27.1547 49.1571 26.8089C48.2107 26.463 47.4008 25.9625 46.7274 25.3073L48.42 23.0414C49.0388 23.5328 49.6485 23.8786 50.2491 24.0788C50.8679 24.2608 51.4595 24.3518 52.0237 24.3518C52.6243 24.3518 53.0611 24.2517 53.3341 24.0515C53.6071 23.8331 53.7436 23.551 53.7436 23.2052C53.7436 22.8958 53.6162 22.641 53.3614 22.4408C53.1248 22.2406 52.8063 22.0677 52.4059 21.922C52.0237 21.7582 51.5869 21.5853 51.0954 21.4033C50.4402 21.1667 49.8396 20.8664 49.2936 20.5024C48.7476 20.1384 48.3017 19.7016 47.9559 19.192C47.6283 18.6824 47.4645 18.0727 47.4645 17.3628C47.4645 16.0888 47.9377 15.0696 48.8841 14.3052C49.8487 13.5226 51.1045 13.1313 52.6516 13.1313C53.6344 13.1313 54.5262 13.2951 55.327 13.6227C56.1461 13.9321 56.8468 14.3416 57.4292 14.8512L55.7092 17.0898C55.2178 16.744 54.7264 16.4983 54.235 16.3527C53.7436 16.1889 53.2613 16.107 52.7881 16.107C52.2603 16.107 51.869 16.2071 51.6142 16.4073C51.3594 16.6075 51.232 16.8623 51.232 17.1717C51.232 17.4265 51.323 17.645 51.505 17.827C51.687 18.009 51.96 18.1819 52.324 18.3457C52.7062 18.4913 53.1794 18.6551 53.7436 18.8371C54.4352 19.0737 55.0631 19.374 55.6273 19.738C56.2098 20.0838 56.6648 20.5206 56.9924 21.0484C57.32 21.5762 57.4838 22.2133 57.4838 22.9595C57.4838 23.7785 57.2654 24.5156 56.8286 25.1708C56.41 25.826 55.7912 26.3538 54.9721 26.7543C54.1531 27.1365 53.1339 27.3276 51.9145 27.3276Z" fill="white"/>
          <path d="M60.0326 27V13.4589H64.0457V27H60.0326ZM62.0255 11.4659C61.3521 11.4659 60.8061 11.2748 60.3875 10.8926C59.9689 10.5104 59.7595 10.0008 59.7595 9.36377C59.7595 8.72676 59.9689 8.21715 60.3875 7.83494C60.8061 7.45273 61.3521 7.26163 62.0255 7.26163C62.6989 7.26163 63.2449 7.45273 63.6635 7.83494C64.0821 8.21715 64.2914 8.72676 64.2914 9.36377C64.2914 10.0008 64.0821 10.5104 63.6635 10.8926C63.2449 11.2748 62.6989 11.4659 62.0255 11.4659Z" fill="white"/>
          <path d="M72.4097 32.7604C71.3541 32.7604 70.3895 32.633 69.5159 32.3782C68.6605 32.1416 67.978 31.7685 67.4683 31.2589C66.9769 30.7674 66.7312 30.1213 66.7312 29.3205C66.7312 28.7563 66.895 28.2467 67.2226 27.7917C67.5684 27.3367 68.0507 26.9363 68.6696 26.5904V26.4812C68.3238 26.2446 68.0234 25.9443 67.7686 25.5803C67.532 25.1981 67.4137 24.734 67.4137 24.188C67.4137 23.6966 67.5593 23.2325 67.8505 22.7957C68.1418 22.3407 68.5058 21.9584 68.9426 21.649V21.5398C68.4512 21.2122 68.0234 20.739 67.6594 20.1202C67.2954 19.5014 67.1134 18.8007 67.1134 18.0181C67.1134 16.9442 67.3773 16.0433 67.9051 15.3153C68.433 14.5873 69.1246 14.0413 69.98 13.6773C70.8354 13.3133 71.7454 13.1313 72.7101 13.1313C73.0923 13.1313 73.4563 13.1586 73.8021 13.2132C74.1661 13.2678 74.5028 13.3497 74.8122 13.4589H79.7536V16.38H77.4877V16.4892C77.6697 16.7258 77.8062 16.9897 77.8972 17.2809C77.9882 17.554 78.0337 17.8634 78.0337 18.2092C78.0337 19.2284 77.7971 20.0747 77.3239 20.7481C76.8506 21.4033 76.2045 21.8947 75.3855 22.2224C74.5847 22.55 73.6929 22.7138 72.7101 22.7138C72.4734 22.7138 72.2186 22.6956 71.9456 22.6592C71.6726 22.6046 71.3814 22.5318 71.072 22.4408C70.9082 22.5864 70.7808 22.732 70.6898 22.8776C70.617 23.0232 70.5806 23.2143 70.5806 23.4509C70.5806 23.7785 70.7353 24.0333 71.0447 24.2153C71.3541 24.3791 71.8819 24.461 72.6281 24.461H74.8122C76.4866 24.461 77.7607 24.734 78.6343 25.28C79.5261 25.8078 79.972 26.6814 79.972 27.9009C79.972 28.8291 79.6626 29.6572 79.0438 30.3852C78.425 31.1314 77.5514 31.7139 76.4229 32.1325C75.2945 32.5511 73.9568 32.7604 72.4097 32.7604ZM72.7101 20.284C73.0741 20.284 73.3926 20.2021 73.6656 20.0383C73.9386 19.8563 74.157 19.6015 74.3208 19.2739C74.4846 18.9463 74.5665 18.5277 74.5665 18.0181C74.5665 17.29 74.3845 16.744 74.0205 16.38C73.6747 16.016 73.2379 15.834 72.7101 15.834C72.1822 15.834 71.7363 16.016 71.3723 16.38C71.0265 16.744 70.8536 17.29 70.8536 18.0181C70.8536 18.5277 70.9355 18.9463 71.0993 19.2739C71.2813 19.6015 71.5088 19.8563 71.7818 20.0383C72.0548 20.2021 72.3642 20.284 72.7101 20.284ZM73.0377 30.2487C73.6383 30.2487 74.1661 30.1759 74.6211 30.0303C75.0943 29.8847 75.4674 29.6845 75.7404 29.4297C76.0134 29.1749 76.1499 28.8928 76.1499 28.5834C76.1499 28.1466 75.9679 27.8554 75.6039 27.7098C75.2399 27.5824 74.7303 27.5187 74.0751 27.5187H72.6827C72.2095 27.5187 71.8273 27.5005 71.5361 27.4641C71.2631 27.4459 71.0083 27.4095 70.7717 27.3549C70.5169 27.5733 70.3258 27.7826 70.1984 27.9828C70.0892 28.2012 70.0346 28.4378 70.0346 28.6926C70.0346 29.2022 70.3076 29.5844 70.8536 29.8392C71.4178 30.1122 72.1458 30.2487 73.0377 30.2487Z" fill="white"/>
          <path d="M82.161 27V13.4589H85.437L85.71 15.1788H85.8192C86.3835 14.6146 87.0205 14.1323 87.7303 13.7319C88.4401 13.3315 89.25 13.1313 90.16 13.1313C91.6525 13.1313 92.7263 13.6227 93.3815 14.6055C94.0367 15.5701 94.3643 16.8987 94.3643 18.5914V27H90.3511V19.1101C90.3511 18.1273 90.2146 17.4538 89.9416 17.0898C89.6868 16.7258 89.2682 16.5438 88.6858 16.5438C88.1762 16.5438 87.7394 16.6621 87.3754 16.8987C87.0114 17.1171 86.611 17.4356 86.1741 17.8543V27H82.161Z" fill="white"/>
          <path d="M107.208 24.4337V19.4104H102.403V16.5711H107.208V11.5478H110.157V16.5711H114.962V19.4104H110.157V24.4337H107.208Z" fill="#96D700"/>
          <path d="M127.971 27.3276C126.296 27.3276 124.949 26.6997 123.93 25.4438C122.929 24.1698 122.429 22.4317 122.429 20.2294C122.429 18.7552 122.693 17.4902 123.22 16.4346C123.766 15.379 124.467 14.5691 125.323 14.0049C126.196 13.4225 127.106 13.1313 128.053 13.1313C128.799 13.1313 129.427 13.2587 129.936 13.5135C130.446 13.7683 130.928 14.1141 131.383 14.5509L131.219 12.476V7.86224H135.233V27H131.957L131.684 25.6622H131.574C131.101 26.1354 130.546 26.5358 129.909 26.8635C129.272 27.1729 128.626 27.3276 127.971 27.3276ZM129.008 24.0515C129.445 24.0515 129.845 23.9605 130.209 23.7785C130.573 23.5965 130.91 23.278 131.219 22.823V17.2809C130.874 16.9533 130.51 16.7258 130.127 16.5984C129.745 16.471 129.363 16.4073 128.981 16.4073C128.544 16.4073 128.144 16.5438 127.78 16.8168C127.416 17.0898 127.115 17.5085 126.879 18.0727C126.66 18.6187 126.551 19.3194 126.551 20.1748C126.551 21.5034 126.769 22.4863 127.206 23.1233C127.643 23.7421 128.244 24.0515 129.008 24.0515Z" fill="white"/>
          <path d="M144.849 27.3276C143.557 27.3276 142.392 27.0455 141.355 26.4812C140.317 25.917 139.498 25.1071 138.898 24.0515C138.297 22.9959 137.997 21.7218 137.997 20.2294C137.997 18.7552 138.297 17.4902 138.898 16.4346C139.516 15.379 140.317 14.5691 141.3 14.0049C142.283 13.4225 143.311 13.1313 144.385 13.1313C145.677 13.1313 146.751 13.4225 147.606 14.0049C148.462 14.5691 149.099 15.3426 149.518 16.3254C149.936 17.3082 150.145 18.4094 150.145 19.6288C150.145 19.9746 150.127 20.3204 150.091 20.6662C150.054 20.9938 150.018 21.2577 149.982 21.4579H141.109L141.054 18.6733H146.706C146.706 17.9635 146.533 17.381 146.187 16.926C145.841 16.4528 145.268 16.2162 144.467 16.2162C144.03 16.2162 143.602 16.3345 143.184 16.5711C142.765 16.8077 142.419 17.2172 142.146 17.7997C141.873 18.3821 141.746 19.192 141.764 20.2294C141.782 21.2486 141.964 22.0494 142.31 22.6319C142.674 23.2143 143.129 23.6329 143.675 23.8877C144.221 24.1243 144.795 24.2426 145.395 24.2426C145.923 24.2426 146.423 24.1698 146.897 24.0242C147.388 23.8604 147.87 23.642 148.344 23.369L149.654 25.826C148.981 26.2992 148.216 26.6724 147.361 26.9454C146.505 27.2002 145.668 27.3276 144.849 27.3276Z" fill="white"/>
          <path d="M155.871 27L151.312 13.4589H155.352L157.099 19.8472C157.281 20.5206 157.454 21.2031 157.618 21.8947C157.8 22.5864 157.982 23.2962 158.164 24.0242H158.273C158.437 23.2962 158.61 22.5864 158.792 21.8947C158.974 21.2031 159.147 20.5206 159.311 19.8472L161.085 13.4589H164.935L160.512 27H155.871Z" fill="white"/>
          <path d="M171.668 16.2435V13.4043H184.226V16.2435H171.668ZM171.668 22.5773V19.738H184.226V22.5773H171.668Z" fill="#96D700"/>
          <path d="M192.731 27V9.19997H198.846C200.156 9.19997 201.34 9.38197 202.395 9.74598C203.469 10.0918 204.324 10.6833 204.961 11.5205C205.598 12.3577 205.917 13.4953 205.917 14.9331C205.917 16.3163 205.598 17.4538 204.961 18.3457C204.324 19.2375 203.478 19.9018 202.422 20.3386C201.367 20.7572 200.211 20.9665 198.955 20.9665H196.744V27H192.731ZM196.744 17.7724H198.71C199.82 17.7724 200.639 17.5267 201.167 17.0352C201.713 16.5438 201.986 15.8431 201.986 14.9331C201.986 13.9867 201.694 13.3315 201.112 12.9675C200.53 12.5852 199.692 12.3941 198.6 12.3941H196.744V17.7724Z" fill="white"/>
          <path d="M213.895 27.3276C212.748 27.3276 211.674 27.0546 210.673 26.5085C209.672 25.9443 208.853 25.1344 208.216 24.0788C207.597 23.005 207.288 21.7218 207.288 20.2294C207.288 18.737 207.597 17.463 208.216 16.4073C208.853 15.3335 209.672 14.5236 210.673 13.9776C211.674 13.4134 212.748 13.1313 213.895 13.1313C215.023 13.1313 216.088 13.4134 217.089 13.9776C218.09 14.5236 218.9 15.3335 219.519 16.4073C220.156 17.463 220.474 18.737 220.474 20.2294C220.474 21.7218 220.156 23.005 219.519 24.0788C218.9 25.1344 218.09 25.9443 217.089 26.5085C216.088 27.0546 215.023 27.3276 213.895 27.3276ZM213.895 24.0788C214.441 24.0788 214.896 23.9241 215.26 23.6147C215.642 23.3053 215.924 22.8594 216.106 22.277C216.288 21.6945 216.379 21.012 216.379 20.2294C216.379 19.4468 216.288 18.7643 216.106 18.1819C215.924 17.5995 215.642 17.1535 215.26 16.8441C214.896 16.5347 214.441 16.38 213.895 16.38C213.33 16.38 212.866 16.5347 212.502 16.8441C212.138 17.1535 211.865 17.5995 211.683 18.1819C211.501 18.7643 211.41 19.4468 211.41 20.2294C211.41 21.012 211.501 21.6945 211.683 22.277C211.865 22.8594 212.138 23.3053 212.502 23.6147C212.866 23.9241 213.33 24.0788 213.895 24.0788Z" fill="white"/>
          <path d="M226.908 27.3003C225.998 27.3003 225.27 27.1183 224.724 26.7543C224.197 26.372 223.814 25.8442 223.578 25.1708C223.341 24.4792 223.223 23.6784 223.223 22.7684V7.88954H227.236V22.9322C227.236 23.369 227.309 23.6693 227.455 23.8331C227.618 23.9787 227.791 24.0515 227.973 24.0515C228.046 24.0515 228.11 24.0515 228.164 24.0515C228.237 24.0333 228.328 24.0151 228.437 23.9969L228.929 26.9727C228.71 27.0637 228.428 27.1365 228.082 27.1911C227.755 27.2639 227.363 27.3003 226.908 27.3003Z" fill="white"/>
          <path d="M232.536 32.2963C232.136 32.2963 231.781 32.269 231.471 32.2144C231.18 32.1598 230.898 32.0779 230.625 31.9687L231.335 29.0202C231.535 29.0748 231.699 29.1021 231.826 29.1021C231.972 29.1203 232.108 29.1294 232.236 29.1294C232.909 29.1294 233.428 28.9565 233.792 28.6107C234.174 28.2831 234.447 27.8645 234.611 27.3549L234.802 26.6451L229.588 13.4589H233.628L235.566 19.2739C235.767 19.8927 235.949 20.5206 236.112 21.1576C236.276 21.7946 236.449 22.4499 236.631 23.1233H236.74C236.886 22.4863 237.032 21.8492 237.177 21.2122C237.341 20.557 237.505 19.9109 237.669 19.2739L239.307 13.4589H243.156L238.46 27.1365C238.023 28.2649 237.55 29.2113 237.041 29.9757C236.549 30.7401 235.94 31.3135 235.211 31.6957C234.502 32.0961 233.61 32.2963 232.536 32.2963Z" fill="white"/>
          <path d="M250.486 27.3003C248.811 27.3003 247.61 26.818 246.882 25.8533C246.154 24.8705 245.79 23.6056 245.79 22.0585V16.5984H243.961V13.6227L246.036 13.4589L246.5 9.30917H249.831V13.4589H253.079V16.5984H249.831V22.0039C249.831 22.7684 249.985 23.3235 250.295 23.6693C250.622 23.9969 251.05 24.1607 251.578 24.1607C251.796 24.1607 252.015 24.1425 252.233 24.1061C252.451 24.0697 252.661 24.0151 252.861 23.9423L253.516 26.7543C253.17 26.8999 252.734 27.0273 252.206 27.1365C251.696 27.2457 251.123 27.3003 250.486 27.3003Z" fill="white"/>
          <path d="M261.155 27.3276C259.299 27.3276 257.797 26.554 256.651 25.007C255.522 23.46 254.958 21.2122 254.958 18.2638C254.958 15.2971 255.522 13.0676 256.651 11.5751C257.797 10.0827 259.299 9.33647 261.155 9.33647C263.012 9.33647 264.504 10.0918 265.632 11.6024C266.779 13.0949 267.352 15.3153 267.352 18.2638C267.352 21.2122 266.779 23.46 265.632 25.007C264.504 26.554 263.012 27.3276 261.155 27.3276ZM261.155 24.2153C261.61 24.2153 262.02 24.0515 262.384 23.7239C262.748 23.3781 263.03 22.7775 263.23 21.922C263.448 21.0484 263.558 19.829 263.558 18.2638C263.558 16.6803 263.448 15.47 263.23 14.6328C263.03 13.7956 262.748 13.2223 262.384 12.9129C262.02 12.6034 261.61 12.4487 261.155 12.4487C260.7 12.4487 260.291 12.6034 259.927 12.9129C259.563 13.2223 259.271 13.7956 259.053 14.6328C258.853 15.47 258.753 16.6803 258.753 18.2638C258.753 19.829 258.853 21.0484 259.053 21.922C259.271 22.7775 259.563 23.3781 259.927 23.7239C260.291 24.0515 260.7 24.2153 261.155 24.2153Z" fill="white"/>
          <path d="M270.146 27V7.86224H274.104V18.7825H274.214L278.418 13.4589H282.813L278.118 19.0828L283.168 27H278.827L275.77 21.7309L274.104 23.6147V27H270.146Z" fill="white"/>
          <path d="M290.39 27.3276C289.098 27.3276 287.933 27.0455 286.896 26.4812C285.858 25.917 285.039 25.1071 284.439 24.0515C283.838 22.9959 283.538 21.7218 283.538 20.2294C283.538 18.7552 283.838 17.4902 284.439 16.4346C285.057 15.379 285.858 14.5691 286.841 14.0049C287.824 13.4225 288.852 13.1313 289.926 13.1313C291.218 13.1313 292.292 13.4225 293.147 14.0049C294.003 14.5691 294.64 15.3426 295.058 16.3254C295.477 17.3082 295.686 18.4094 295.686 19.6288C295.686 19.9746 295.668 20.3204 295.632 20.6662C295.595 20.9938 295.559 21.2577 295.523 21.4579H286.65L286.595 18.6733H292.246C292.246 17.9635 292.074 17.381 291.728 16.926C291.382 16.4528 290.809 16.2162 290.008 16.2162C289.571 16.2162 289.143 16.3345 288.725 16.5711C288.306 16.8077 287.96 17.2172 287.687 17.7997C287.414 18.3821 287.287 19.192 287.305 20.2294C287.323 21.2486 287.505 22.0494 287.851 22.6319C288.215 23.2143 288.67 23.6329 289.216 23.8877C289.762 24.1243 290.335 24.2426 290.936 24.2426C291.464 24.2426 291.964 24.1698 292.438 24.0242C292.929 23.8604 293.411 23.642 293.885 23.369L295.195 25.826C294.522 26.2992 293.757 26.6724 292.902 26.9454C292.046 27.2002 291.209 27.3276 290.39 27.3276Z" fill="white"/>
          <path d="M298.46 27V13.4589H301.736L302.009 15.1788H302.118C302.682 14.6146 303.319 14.1323 304.029 13.7319C304.739 13.3315 305.549 13.1313 306.459 13.1313C307.951 13.1313 309.025 13.6227 309.68 14.6055C310.335 15.5701 310.663 16.8987 310.663 18.5914V27H306.65V19.1101C306.65 18.1273 306.513 17.4538 306.24 17.0898C305.985 16.7258 305.567 16.5438 304.984 16.5438C304.475 16.5438 304.038 16.6621 303.674 16.8987C303.31 17.1171 302.91 17.4356 302.473 17.8543V27H298.46Z" fill="white"/>
          <path d="M327.388 10.5051C327.388 4.78846 323.059 0.156621 317.711 0.156621H311.848V5.49443H316.597C319.802 5.49443 321.834 8.27526 321.834 11.7018V15.2316L324.705 18.0297L321.834 20.8277V24.3576C321.834 27.7841 319.802 30.5649 316.597 30.5649H311.848V35.9027H317.711C323.051 35.9027 327.388 31.2709 327.388 25.5543V23.1609L328.87 21.6112V14.431L327.388 12.8813V10.4879V10.5051Z" fill="#96D700"/>
        </svg>
      </div>

      <!-- Controls Section - Priorité basse -->
      <div class="header-controls">
        <!-- Mode Toggle (Designer / Developer) - Masqué par défaut -->
        <div class="mode-toggle hidden" id="modeToggle">
          <button class="mode-toggle-btn active" id="modeDesigner">Designer</button>
          <button class="mode-toggle-btn" id="modeDev">Developer</button>
        </div>
      </div>
    </header>

    <!-- ============================================
         BODY - Contenu principal
         ============================================ -->
    <main class="app-body">

      <!-- ============================================
           VUE 0: ACCUEIL - Choix du parcours
           ============================================ -->
      <div id="wizardStep0" class="wizard-step active">
        <div class="card">
          <h3 style="margin-bottom: 4px;">Générez, importez et synchronisez vos variables Figma avec votre code
          </h3>
          <p style="margin-bottom: 24px;">Choisissez comment vous souhaitez commencer :</p>

          <!-- Section 1: CRÉER & IMPORTER -->
          <div class="card choice-section section-create">
            <div class="section-header">
              <span class="section-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.5 7C2.5 9.48528 4.51472 11.5 7 11.5C9.48528 11.5 11.5 9.48528 11.5 7C11.5 4.51472 9.48528 2.5 7 2.5C4.51472 2.5 2.5 4.51472 2.5 7ZM2.5 17C2.5 19.4853 4.51472 21.5 7 21.5C9.48528 21.5 11.5 19.4853 11.5 17C11.5 14.5147 9.48528 12.5 7 12.5C4.51472 12.5 2.5 14.5147 2.5 17ZM12.5 17C12.5 19.4853 14.5147 21.5 17 21.5C19.4853 21.5 21.5 19.4853 21.5 17C21.5 14.5147 19.4853 12.5 17 12.5C14.5147 12.5 12.5 14.5147 12.5 17ZM16 11V8H13V6H16V3H18V6H21V8H18V11H16Z"></path></svg>
              </span>
              <h4 class="section-title">CRÉER & IMPORTER</h4>
            </div>
            <div class="choice-grid">
              <!-- Option A: Créer un nouveau système -->
              <div class="choice-card" id="choiceNewSystem">
                <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                      d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                  </svg>
                </span>
                <h3>Démarrer un nouveau système</h3>
                <p>Générez automatiquement une palette complète et des échelles standards à partir d'une couleur
                  principale.</p>
              </div>

              <!-- Option B: Importer un fichier -->
              <div class="choice-card" id="choiceImportFile">
                <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                    <path d="M12 12v9" />
                    <path d="m16 16-4-4-4 4" />
                  </svg>
                </span>
                <h3>Importer les tokens de votre code</h3>
                <p>Depuis un fichier JSON ou CSS.</p>
              </div>
            </div>
          </div>

          <!-- Section 2: ANALYSER & CORRIGER -->
          <div class="card choice-section section-analyze" style="display: none;">
            <div class="section-header">
              <span class="section-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 7.53861L15 21.5386L18.6594 13H23V11H17.3406L15 16.4614L9 2.46143L5.3406 11H1V13H6.6594L9 7.53861Z"></path></svg>
              </span>
              <h4 class="section-title">ANALYSER & CORRIGER</h4>
            </div>
            <div class="choice-grid">
              <!-- Option C: Gérer mes tokens (visible uniquement si tokens existent) -->
              <div class="choice-card hidden" id="choiceManageTokens">
                <span class="icon" style="color: var(--poly-accent);">
                  <svg width="90" height="104" viewBox="0 0 90 104" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9 31.176L45 10.386L81 31.176V72.747L45 93.537L9 72.747V31.176ZM45 0.00900002L90 25.992V77.949L45 103.932L0 77.949V25.983L45 0V0.00900002ZM54 51.939C54 56.916 49.968 60.939 45 60.939C40.032 60.939 36 56.916 36 51.939C36 46.971 40.032 42.939 45 42.939C49.968 42.939 54 46.971 54 51.939Z" />
                  </svg>
                </span>
                <h3>Gérer les variables locales</h3>
                <p id="existingTokensInfo" style="margin-bottom: 4px;">Chargement...</p>
                <p style="font-size: 10px; opacity: 0.7; margin: 0;">
                  <span id="existingTokensCount">0 tokens</span>
                </p>
              </div>

              <!-- Option D: Vérifier une Frame -->
              <div class="choice-card" id="choiceVerifyFrames">
                <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                  </svg>
                </span>
                <h3>Vérifier une Frame</h3>
                <p>Détectez les valeurs en dur et remplacez-les par vos variables.</p>
              </div>
            </div>
          </div>

          <!-- Input file caché (pour l'import) -->
          <input id="realFileInput" type="file" accept=".json,.css" style="display:none;" />

          <!-- Footer Sticky Vue 0 -->
          <div class="sticky-footer">
            <div class="sticky-footer-content">
              <button id="step0Next" class="btn-primary" disabled>Continuer</button>
            </div>
            <div class="footer-signature">
              Designed and developed by <a color="var(--color-primary)" href="https://www.linkedin.com/in/emma-jan/"
                target="_blank">Emma Jan</a>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================
           VUE 1: LIBRAIRIE - Choix de la librairie
           ============================================ -->
      <div id="wizardStep1" class="wizard-step">
        <div class="card">
          <h3>Choisissez votre librairie</h3>
          <p style="margin-bottom: 4px;">PolyToken adaptera les noms, les échelles de couleurs et les espacements pour
            correspondre parfaitement à votre framework !</p>

          <div class="library-grid">
            <div class="library-option" data-library="tailwind" aria-label="Tailwind / Shadcn - Option populaire">
              <span class="icon" style="color: var(--poly-accent);">
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path
                    d="M12.001,4.8c-3.2,0-5.2,1.6-6,4.8c1.2-1.6,2.6-2.2,4.2-1.8c0.913,0.228,1.565,0.89,2.288,1.624 C13.666,10.618,15.027,12,18.001,12c3.2,0,5.2-1.6,6-4.8c-1.2,1.6-2.6,2.2-4.2,1.8c-0.913-0.228-1.565-0.89-2.288-1.624 C16.337,6.182,14.976,4.8,12.001,4.8z M6.001,12c-3.2,0-5.2,1.6-6,4.8c1.2-1.6,2.6-2.2,4.2-1.8c0.913,0.228,1.565,0.89,2.288,1.624 c1.177,1.194,2.538,2.576,5.512,2.576c3.2,0,5.2-1.6,6-4.8c-1.2,1.6-2.6,2.2-4.2,1.8c-0.913-0.228-1.565-0.89-2.288-1.624 C10.337,13.382,8.976,12,6.001,12z" />
                </svg>
              </span>
              <span>Tailwind / Shadcn</span>
              <span class="popular-badge" aria-hidden="true" style="margin-top: 4px;">Populaire</span>
            </div>

            <div class="library-option" data-library="mui">
              <span class="icon" style="color: var(--poly-accent);">
                <svg viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <title>Material-UI icon</title>
                  <path d="M0 2.475v10.39l3 1.733V7.67l6 3.465 6-3.465v3.465l-6 3.463v3.464l6 3.463 9-5.195V9.402l-3 1.733v3.463l-6 3.464-3-1.732 6-3.465V2.475L9 7.67 0 2.475zm24 0l-3 1.73V7.67l3-1.732V2.474Z" />
                </svg>
              </span>
              <span>Material UI</span>
            </div>

            <div class="library-option" data-library="ant">
              <span class="icon" style="color: var(--poly-accent);">
                <svg viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path d="M17.451 6.68c.51-.506.51-1.33 0-1.837L15.578 2.97l.003.002-2.554-2.55a1.463 1.463 0 0 0-2.05.013L.427 10.98a1.443 1.443 0 0 0 0 2.047l10.549 10.54a1.45 1.45 0 0 0 2.05 0l4.423-4.42a1.297 1.297 0 0 0 0-1.838 1.305 1.305 0 0 0-1.84 0l-3.35 3.354a.346.346 0 0 1-.495 0l-8.427-8.419a.346.346 0 0 1 0-.495l8.424-8.42c.01-.01.024-.018.035-.029a.34.34 0 0 1 .46.03l3.354 3.35a1.3 1.3 0 0 0 1.841 0zm-8.245 5.376a2.848 2.846 0 1 0 5.697 0 2.848 2.846 0 1 0-5.697 0zm14.368-1.034L20.28 7.743a1.303 1.303 0 0 0-1.841.003 1.297 1.297 0 0 0 0 1.838l2.224 2.222c.14.139.14.356 0 .495l-2.192 2.19a1.297 1.297 0 0 0 0 1.837 1.305 1.305 0 0 0 1.84 0l3.264-3.26a1.445 1.445 0 0 0-.002-2.047z" />
                </svg>
              </span>
              <span>Ant Design</span>
            </div>

            <div class="library-option" data-library="bootstrap">
              <span class="icon" style="color: var(--poly-accent);">
                <svg viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path d="M11.77 11.24H9.956V8.202h2.152c1.17 0 1.834.522 1.834 1.466 0 1.008-.773 1.572-2.174 1.572zm.324 1.206H9.957v3.348h2.231c1.459 0 2.232-.585 2.232-1.685s-.795-1.663-2.326-1.663zM24 11.39v1.218c-1.128.108-1.817.944-2.226 2.268-.407 1.319-.463 2.937-.42 4.186.045 1.3-.968 2.5-2.337 2.5H4.985c-1.37 0-2.383-1.2-2.337-2.5.043-1.249-.013-2.867-.42-4.186-.41-1.324-1.1-2.16-2.228-2.268V11.39c1.128-.108 1.819-.944 2.227-2.268.408-1.319.464-2.937.42-4.186-.045-1.3.968-2.5 2.338-2.5h14.032c1.37 0 2.382 1.2 2.337 2.5-.043 1.249.013 2.867.42 4.186.409 1.324 1.098 2.16 2.226 2.268zm-7.927 2.817c0-1.354-.953-2.333-2.368-2.488v-.057c1.04-.169 1.856-1.135 1.856-2.213 0-1.537-1.213-2.538-3.062-2.538h-4.16v10.172h4.181c2.218 0 3.553-1.086 3.553-2.876z" />
                </svg>
              </span>
              <span>Bootstrap</span>
            </div>

            <div class="library-option" data-library="chakra">
              <span class="icon" style="color: var(--poly-accent);">
                <svg viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                  <path d="M12 0C5.352 0 0 5.352 0 12s5.352 12 12 12 12-5.352 12-12S18.648 0 12 0zm2.8 4.333c.13-.004.248.136.171.278l-3.044 5.58a.187.187 0 0 0 .164.276h5.26c.17 0 .252.207.128.323l-9.22 8.605c-.165.154-.41-.063-.278-.246l4.364-6.021a.187.187 0 0 0-.151-.296H6.627a.187.187 0 0 1-.131-.32l8.18-8.123a.182.182 0 0 1 .125-.056z" />
                </svg>
              </span>
              <span>Chakra UI</span>
            </div>

            <div class="library-option" data-library="custom">
              <span class="icon" style="color: var(--poly-accent);">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 3H15V0.5L18.5 4L15 7.5V5H8V7.5L4.5 4L8 0.5V3ZM3 17V6.5H5V17C5 18.1046 5.89543 19 7 19H17.5V21H7C4.79086 21 3 19.2091 3 17ZM21 16V9H23.5L20 5.5L16.5 9H19V16H16.5L20 19.5L23.5 16H21Z" />
                </svg>
              </span>
              <span>Custom</span>
            </div>
          </div>
        </div>

        <!-- Sticky Footer for Vue 1 -->
        <!-- Sticky Footer for Vue 1 -->
        <div class="sticky-footer">
          <div class="sticky-footer-content space-between">
            <button class="btn-secondary" id="step1Back" style="flex: 1;">← Retour</button>
            <button class="btn-primary" id="step1Next" disabled style="flex: 1;">Suivant →</button>
          </div>
          <div class="footer-signature">
            Designed and developed by <a href="https://www.linkedin.com/in/emma-jan/" target="_blank">Emma Jan</a>
          </div>
        </div>
      </div>

      <!-- ============================================
           VUE 2: COULEUR - Sélecteur de couleur primaire
           ============================================ -->
      <div id="wizardStep2" class="wizard-step">
        <div class="card">
          <h3>Définissez votre identité de marque</h3>
          <p style="margin-bottom: 16px;">Cette couleur servira de pivot pour générer toutes vos nuances sémantiques et
            vos états (hover, active, etc.)</p>

          <label>Primary Color</label>
          <div class="color-input-group">
            <div class="color-preview">
              <div class="color-preview-bg" id="colorPreviewBg"></div>
              <input type="color" id="colorPicker" value="#6366F1">
            </div>
            <div class="color-input-wrapper">
              <input type="text" id="colorInput" value="#6366F1" placeholder="#6366F1">
            </div>
            <button class="btn-secondary" id="randomBtn">Random</button>
          </div>
        </div>

        <!-- Sticky Footer for Vue 2 -->
        <div class="sticky-footer">
          <div class="sticky-footer-content space-between">
            <button class="btn-secondary" id="step2Back" style="flex: 1;">← Retour</button>
            <button class="btn-primary" id="step2Generate" style="flex: 1;">Générer les Tokens →</button>
          </div>
          <div class="footer-signature">
            DesDesigned and developed by <a href="https://www.linkedin.com/in/emma-jan/" target="_blank">Emma Jan</a>
          </div>
        </div>
      </div>

      <!-- ============================================
           VUE 3: RÉSULTAT - Preview & Export
           ============================================ -->
      <div id="wizardStep3" class="wizard-step">

        <!-- Card unique contenant les deux vues -->
        <div class="card">
          <!-- Dashboard Header (Live Color & Library) -->
          <div class="dashboard-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--poly-border-subtle);">
            <div class="mini-color-control" style="display: flex; align-items: center; gap: 10px;">
              <div class="color-preview" style="width: 32px; height: 32px; border-radius: 6px;">
                <div class="color-preview-bg" id="dashboardColorPreviewBg"
                  style="background-color: var(--poly-accent);"></div>
                <input type="color" id="dashboardColorPicker">
              </div>
              <div>
                <label style="margin: 0; font-size: 10px; cursor: pointer;" for="dashboardColorPicker">Primary
                  Color</label>
                <div id="dashboardColorValue" style="font-family: monospace; font-size: 12px; color: var(--poly-text);">
                  #6366F1</div>
              </div>
            </div>

            <div id="activeLibraryBadge"
              style="font-size: 11px; background: var(--poly-surface-soft); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--poly-border-subtle); color: var(--poly-text-muted);">
              Library: <span id="libraryNameDisplay"
                style="color: var(--poly-accent); font-weight: 600;">Tailwind</span>
            </div>
          </div>

          <!-- Designer View -->
          <div id="designerView">
            <div class="tabs" id="tokenTabs">
              <button class="tab active" data-category="brand">Brand</button>
              <button class="tab" data-category="system">System</button>
              <button class="tab" data-category="gray">Gray</button>
              <button class="tab" data-category="spacing">Spacing</button>
              <button class="tab" data-category="radius">Radius</button>
              <button class="tab" data-category="typography">Typography</button>
              <button class="tab" data-category="border">Border</button>
            </div>

            <div class="preview-section" id="tokenPreview"></div>
          </div>

          <!-- Developer View -->
          <div id="devView" class="hidden">
            <h3>Handoff Développeur</h3>
            <p style="font-size: 12px; color: var(--poly-text-muted); margin-bottom: 12px;">
              Récupérez le code prêt à copier-coller pour votre projet.
            </p>

            <label>Format</label>
            <select id="exportFormat">
              <option value="css">CSS Variables (:root)</option>
              <option value="json">JSON (Design Tokens)</option>
              <option value="tailwind">Tailwind Config (JS)</option>
              <option value="scss">SCSS Variables</option>
            </select>

            <!-- Code Editor Wrapper -->
            <div class="editor-wrapper">
              <div id="codeEditor" class="editor-container" tabindex="0"></div>
            </div>

            <!-- Removed old buttons div here, moved to sticky footer -->
          </div>
        </div>

        <!-- Action Buttons (Sticky Footer) -->
        <div class="sticky-footer">

          <!-- Checkbox Overwrite (Designer Only) -->
          <div id="overwriteCheckboxContainer" class="hidden"
            style="width: 100%; display: flex; justify-content: center; margin-bottom: 4px;">
            <label
              style="display: flex; align-items: center; cursor: pointer; text-transform: none; color: var(--poly-text); font-weight: 500; font-size: 13px; margin: 0;">
              <input type="checkbox" id="overwriteCheckbox" style="width: auto; margin: 0 8px 0 0;">
              Mettre à jour les variables existantes.
            </label>
          </div>

          <!-- Footer Content: Designer View -->
          <div id="footerDesignerOps" class="sticky-footer-content" style="gap: 10px; width: 100%;">
            <button class="btn-secondary" id="backToLibBtn" style="flex: 1;">← Retour</button>
            <button class="btn-primary" id="importBtn" style="flex: 2;">Synchroniser avec Figma</button>
          </div>

          <!-- Footer Content: Developer View -->
          <div id="footerDevOps" class="sticky-footer-content hidden" style="gap: 10px; width: 100%;">
            <button class="btn-secondary" id="downloadBtn" style="flex: 1;">
              <span class="icon" style="margin-right: 6px;">⬇</span> Télécharger
            </button>
            <button class="btn-primary" id="copyBtnFooter" style="flex: 1;">
              Copier le code
            </button>
          </div>

          <div class="footer-signature">
            Designed and developed by <a href="https://www.linkedin.com/in/emma-jan/" target="_blank">Emma Jan</a>
          </div>
        </div>
      </div>

      <!-- ============================================
           VUE 4: NETTOYAGE INTELLIGENT - Analyse & Corrections
           ============================================ -->
      <div id="wizardStep4" class="wizard-step">
        <div class="card">
          

          <!-- État de chargement -->
          <div id="scanLoadingState" class="empty-state-enhanced hidden">
            <div class="empty-icon pulse">🔍</div>
            <h3>Analyse en cours...</h3>
            <p>Nous examinons votre design pour détecter les valeurs qui peuvent être remplacées par des variables.</p>
            <div class="loading-bar" style="width: 200px; height: 4px; background: var(--poly-surface-soft); border-radius: 2px; margin: 20px auto; overflow: hidden;">
              <div class="loading-fill" style="height: 100%; background: linear-gradient(90deg, var(--poly-accent), var(--poly-accent-hover)); width: 30%; animation: loadingPulse 1.5s ease-in-out infinite;"></div>
            </div>
          </div>

          <!-- État vide amélioré -->
          <div id="scanEmptyState" class="empty-state-enhanced">
            <div class="empty-icon">🎯</div>
            <h3>Aucune Frame sélectionnée</h3>
            <p>Sélectionnez une frame dans Figma pour lancer l'analyse intelligente et détecter automatiquement les valeurs en dur qui peuvent être remplacées par vos variables de design.</p>

            <div class="empty-actions">
              <button class="btn-secondary" onclick="showHelpTooltip()">
                <span class="btn-icon">💡</span>
                <span class="btn-text">Comment ça marche ?</span>
              </button>
            </div>
          </div>

          <!-- Zone des résultats avec nouvelle hiérarchie -->
          <div id="scanResults" class="hidden">

            <div class="card">
              <!-- Système de filtrage simplifié -->
              <div class="filter-system" style="margin-bottom: 24px;">
                <div class="filter-buttons">
                  <button class="filter-btn active" data-filter="auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="none" style="margin-right: 6px;"><path d="M12.7179 13.0019L10.5052 17.6521C10.3628 17.9513 10.0048 18.0784 9.70564 17.936C9.63894 17.9043 9.57864 17.8605 9.52784 17.8069L5.98643 14.0681C5.89163 13.968 5.76527 13.9036 5.62859 13.8858L0.522299 13.2183C0.193719 13.1754 -0.0378213 12.8742 0.00512872 12.5456C0.0146987 12.4724 0.0377289 12.4015 0.0730389 12.3366L2.53445 7.81322C2.60034 7.69212 2.62253 7.55202 2.59728 7.41655L1.65414 2.35393C1.59345 2.02816 1.80834 1.71488 2.13411 1.65419C2.20674 1.64066 2.28125 1.64066 2.35388 1.65419L7.41651 2.59733C7.55204 2.62257 7.69214 2.60039 7.81314 2.5345L12.3365 0.0730896C12.6276 -0.0853004 12.992 0.0222695 13.1503 0.313329C13.1857 0.378229 13.2087 0.44909 13.2182 0.52235L13.8857 5.62864C13.9036 5.76532 13.968 5.89168 14.068 5.98647L17.8068 9.52782C18.0474 9.75572 18.0577 10.1355 17.8298 10.3761C17.779 10.4297 17.7187 10.4735 17.652 10.5052L13.0019 12.718C12.8774 12.7772 12.7771 12.8775 12.7179 13.0019ZM13.5147 14.929L14.9289 13.5148L19.1716 17.7574L17.7574 19.1716L13.5147 14.929Z" fill="black"/></svg>
                    Automatique
                    <span class="filter-count" id="autoCount">0</span>
                  </button>
                  <button class="filter-btn" data-filter="manual">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 19 23" fill="none" style="margin-right: 6px;"><path d="M10.0026 2C9.72654 2 9.50264 2.22386 9.50264 2.5V12H7.50264V4.5C7.50264 4.22386 7.27878 4 7.00264 4C6.72649 4 6.50264 4.22386 6.50264 4.5V14C6.14897 14 4.50268 14 4.50268 14C4.12155 12.3792 3.1448 11.4407 2.09784 11.3216C2.3817 12.0664 2.86361 13.2592 3.66878 15.0995C4.52755 17.0622 5.39372 18.5218 6.50618 19.4986C7.58074 20.442 8.96104 21 11.0026 21C14.0402 21 16.5026 18.5377 16.5026 15.5002V7C16.5026 6.72386 16.2787 6.5 16.0026 6.5C15.7265 6.5 15.5026 6.72386 15.5026 7V12H13.5026V4C13.5026 3.72386 13.2787 3.5 13.0026 3.5C12.7265 3.5 12.5026 3.72386 12.5026 4V12H10.5026V2.5C10.5026 2.22386 10.2787 2 10.0026 2ZM18.5026 15.5002C18.5026 19.6424 15.1447 23 11.0026 23C8.54414 23 6.67458 22.308 5.1866 21.0015C3.73655 19.7283 2.72772 17.9381 1.83649 15.9012C0.906371 13.7753 0.392481 12.4804 0.112351 11.7235C-0.244379 10.7597 0.248601 9.41212 1.58827 9.31846C2.7432 9.23771 3.72305 9.61249 4.50264 10.2587V4.5C4.50264 3.11929 5.62193 2 7.00264 2C7.18766 2 7.36798 2.0201 7.54154 2.05823C7.75014 0.888227 8.77264 0 10.0026 0C11.0626 0 11.9685 0.659694 12.3322 1.59091C12.5455 1.53167 12.7704 1.5 13.0026 1.5C14.3833 1.5 15.5026 2.61929 15.5026 4V4.55001C15.6642 4.51722 15.8314 4.5 16.0026 4.5C17.3833 4.5 18.5026 5.61929 18.5026 7V15.5002Z" fill="white"/></svg>
                    Manuel
                    <span class="filter-count" id="manualCount">0</span>
                  </button>
                </div>
              </div>

              <!-- Contenu unifié avec filtrage -->
              <div class="cleaning-content">
                <div class="content-header" style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                  <div class="title-section">
                    <h5 id="contentTitle">Corrections disponibles</h5>
                    <p class="section-desc" id="contentDesc">Découvrez et appliquez les corrections suggérées pour vos variables de design.</p>
                  </div>
                  <div class="progress-gauge">
                    <div class="progress-circle">
                      <svg width="80" height="80" viewBox="0 0 80 80">
                        <circle cx="40" cy="40" r="35" stroke="var(--poly-border-subtle)" stroke-width="4" fill="none"/>
                        <circle cx="40" cy="40" r="35" stroke="var(--poly-accent)" stroke-width="4" fill="none"
                                stroke-dasharray="219.91" stroke-dashoffset="219.91" stroke-linecap="round"
                                transform="rotate(-90 40 40)" id="progressRing"/>
                      </svg>
                      <div class="progress-text">
                        <span id="progressPercentage">0</span><span class="percent-symbol">%</span>
                      </div>
                    </div>
                    <div class="progress-label">Nettoyage</div>
                  </div>
                </div>

                <!-- Liste unifiée des corrections -->
                <div id="unifiedCleaningList" class="unified-list">
                  <!-- Le contenu sera injecté ici par JavaScript -->
                </div>

                <!-- État vide filtré -->
                <div id="filteredEmptyState" class="filtered-empty-state" style="display: none;">
                  <div style="text-align: center; padding: 40px 20px;">
                    <div style="margin-bottom: 16px;">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.4;">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <h5 style="margin-bottom: 8px; color: var(--poly-text-muted);">Aucun problème dans cette catégorie</h5>
                    <p style="color: var(--poly-text-muted); margin-bottom: 0;">Essayez un autre filtre pour voir d'autres corrections.</p>
                  </div>
                </div>

                <!-- Actions groupées améliorées -->
                <div id="bulkActions" class="bulk-actions-enhanced" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--poly-border-subtle);">
                  <div class="bulk-stats" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="selection-info">
                      <span id="selectedCount">0</span> élément(s) sélectionné(s)
                    </div>
                    <div class="progress-indicator">
                      <div class="progress-bar" style="width: 100px; height: 4px; background: var(--poly-surface-soft); border-radius: 2px; overflow: hidden;">
                        <div id="progressFill" class="progress-fill" style="height: 100%; background: var(--poly-accent); width: 0%; transition: width 0.3s ease;"></div>
                      </div>
                    </div>
                  </div>

                  <div class="bulk-buttons">
                    <button class="btn-primary" id="applySelectedBtn" disabled>
                      <span class="btn-icon">⚡</span>
                      <span class="btn-text">Appliquer la sélection</span>
                      <span class="btn-count" id="applyCount">(0)</span>
                    </button>
                    <button class="btn-outline" id="ignoreSelectedBtn" disabled>
                      <span class="btn-icon">👁️</span>
                      <span class="btn-text">Ignorer la sélection</span>
                      <span class="btn-count" id="ignoreCount">(0)</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Sticky Footer -->
        <div class="sticky-footer">
          <div class="sticky-footer-content">
            <button class="btn-secondary" id="step4Back">← Retour</button>
            <button class="btn-secondary" id="scanBtn" disabled style="margin-left: 12px;">Lancer l'analyse</button>
            <button class="btn-primary" id="step4ApplyAll" style="display: none; margin-left: auto;">✅ Valider</button>
          </div>
          <div class="footer-signature">
            Designed and developed by <a href="https://www.linkedin.com/in/emma-jan/" target="_blank">Emma Jan</a>
          </div>
        </div>
      </div>

    </main>

    <!-- Modal for Token Edit/Add -->
    <div id="tokenModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">Edit Token</h3>
        <label>Token Name</label>
        <input type="text" id="modalTokenName" placeholder="e.g., primary-500">
        <label>Token Value</label>
        <input type="text" id="modalTokenValue" placeholder="e.g., #6366F1">
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
          <button id="modalSaveBtn" onclick="saveToken()" style="flex: 1;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // STATE
    // ============================================
    var currentColor = "#6366F1";
    var currentNaming = "";
    var currentTokens = null;
    var selectedFile = null;
    var activeCategory = "brand";
    var currentStep = 0;
    var lastScanResults = null; // Stockage global des résultats du dernier scan
    var initialProblemCount = 0; // Stockage du nombre initial de problèmes pour la jauge

    // ============================================
    // DOM ELEMENTS
    // ============================================
    var colorPicker = document.getElementById("colorPicker");
    var colorInput = document.getElementById("colorInput");
    var colorPreviewBg = document.getElementById("colorPreviewBg");
    var randomBtn = document.getElementById("randomBtn");

    var importBtn = document.getElementById("importBtn");
    var tokenTabs = document.getElementById("tokenTabs");
    var tokenPreview = document.getElementById("tokenPreview");

    // Dashboard Elements
    var dashboardColorPicker = document.getElementById("dashboardColorPicker");
    var dashboardColorValue = document.getElementById("dashboardColorValue");
    var dashboardColorPreviewBg = document.getElementById("dashboardColorPreviewBg");
    var libraryNameDisplay = document.getElementById("libraryNameDisplay");

    // Dev Mode Elements
    var modeDesigner = document.getElementById("modeDesigner");
    var modeDev = document.getElementById("modeDev");
    var designerView = document.getElementById("designerView");
    var devView = document.getElementById("devView");
    var exportFormat = document.getElementById("exportFormat");
    // exportOutput is removed, using codeEditor and rawExportContent
    // copyBtn removed, replaced by copyBtnFooter
    var copyBtnFooter = document.getElementById("copyBtnFooter");
    var downloadBtn = document.getElementById("downloadBtn");

    var footerDesignerOps = document.getElementById("footerDesignerOps");
    var footerDevOps = document.getElementById("footerDevOps");

    // Overwrite Checkbox
    var overwriteCheckboxContainer = document.getElementById("overwriteCheckboxContainer");
    var overwriteCheckbox = document.getElementById("overwriteCheckbox");

    // Wizard Steps
    var wizardStep0 = document.getElementById("wizardStep0");
    var wizardStep1 = document.getElementById("wizardStep1");
    var wizardStep2 = document.getElementById("wizardStep2");
    var wizardStep3 = document.getElementById("wizardStep3");
    var wizardStep4 = document.getElementById("wizardStep4");

    // Vue 0 Elements
    var choiceNewSystem = document.getElementById("choiceNewSystem");
    var choiceImportFile = document.getElementById("choiceImportFile");
    var choiceManageTokens = document.getElementById("choiceManageTokens");
    var existingTokensInfo = document.getElementById("existingTokensInfo");
    var existingTokensCount = document.getElementById("existingTokensCount");
    var realFileInput = document.getElementById("realFileInput");
    var step0Next = document.getElementById("step0Next");

    // Mode Toggle
    var modeToggle = document.getElementById("modeToggle");

    // Vue 1 Elements
    var libraryOptions = document.querySelectorAll(".library-option");
    var step1Back = document.getElementById("step1Back");
    var step1Next = document.getElementById("step1Next");

    // Vue 2 Elements
    var step2Back = document.getElementById("step2Back");
    var step2Generate = document.getElementById("step2Generate");

    // Vue 3 Elements
    var backToLibBtn = document.getElementById("backToLibBtn");

    // Vue 4 Elements
    var scanBtn = document.getElementById("scanBtn");
    var scanResults = document.getElementById("scanResults");
    var scanEmptyState = document.getElementById("scanEmptyState");
    var scanResultsList = document.getElementById("unifiedCleaningList");
    var step4Back = document.getElementById("step4Back");
    var step4ApplyAll = document.getElementById("step4ApplyAll");

    // ============================================
    // STATE VARIABLES
    // ============================================
    var hasExistingTokens = false;
    var existingTokensData = null;
    var existingLibrary = null;
    var currentStartOption = null; // 'new', 'import', 'manage'

    // ============================================
    // WIZARD NAVIGATION
    // ============================================
    function switchStep(stepNumber) {
      // Hide all steps
      wizardStep0.classList.remove("active");
      wizardStep1.classList.remove("active");
      wizardStep2.classList.remove("active");
      wizardStep3.classList.remove("active");
      wizardStep4.classList.remove("active");

      // Show the target step
      currentStep = stepNumber;

      if (stepNumber === 0) {
        wizardStep0.classList.add("active");
        // Masquer le toggle sur Vue 0
        modeToggle.classList.add("hidden");
      } else if (stepNumber === 1) {
        wizardStep1.classList.add("active");
        // Masquer le toggle sur Vue 1
        modeToggle.classList.add("hidden");
      } else if (stepNumber === 2) {
        wizardStep2.classList.add("active");
        // Masquer le toggle sur Vue 2
        modeToggle.classList.add("hidden");

        // FIX: Force sync inputs with state
        if (colorPicker && colorInput) {
          colorPicker.value = currentColor;
          colorInput.value = currentColor;
          updateColorPreview(currentColor);
        }
      } else if (stepNumber === 3) {
        wizardStep3.classList.add("active");
        // Afficher le toggle sur Vue 3
        modeToggle.classList.remove("hidden");

        // Init Dashboard Header
        if (dashboardColorPicker) {
          dashboardColorPicker.value = currentColor;
          dashboardColorValue.textContent = currentColor;
          dashboardColorPreviewBg.style.backgroundColor = currentColor;
        }
        if (libraryNameDisplay) {
          var displayMap = {
            "tailwind": "Tailwind",
            "mui": "Material UI",
            "ant": "Ant Design",
            "bootstrap": "Bootstrap",
            "chakra": "Chakra UI",
            "custom": "Custom"
          };
          libraryNameDisplay.textContent = displayMap[currentNaming] || currentNaming || "Custom";
        }
      } else if (stepNumber === 4) {
        wizardStep4.classList.add("active");
        // Masquer le toggle sur Vue 4
        modeToggle.classList.add("hidden");

        // Init scan state
        updateScanUI();
      }
    }

    function resetWizard() {
      currentColor = "#6366F1";
      currentNaming = "";
      currentTokens = null;
      selectedFile = null;
      activeCategory = "brand";

      // Reset library selection
      libraryOptions.forEach(function (opt) {
        opt.classList.remove("selected");
      });
      step1Next.disabled = true;

      // Reset color
      colorInput.value = currentColor;
      colorPicker.value = currentColor;
      updateColorPreview(currentColor);

      // Reset scan results
      var scanResults = document.getElementById("scanResults");
      var scanEmptyState = document.getElementById("scanEmptyState");
      if (scanResults) scanResults.classList.add("hidden");
      if (scanEmptyState) scanEmptyState.classList.remove("hidden");

      // Go back to step 0
      switchStep(0);
    }

    // ============================================
    // VUE 0: ACCUEIL - Event Listeners
    // ============================================

    function selectStartOption(option) {
      currentStartOption = option;

      // Update UI classes
      choiceNewSystem.classList.remove("active");
      choiceImportFile.classList.remove("active");
      choiceManageTokens.classList.remove("active");
      choiceVerifyFrames.classList.remove("active");

      if (option === 'new') choiceNewSystem.classList.add("active");
      if (option === 'import') choiceImportFile.classList.add("active");
      if (option === 'manage') choiceManageTokens.classList.add("active");
      if (option === 'verify') choiceVerifyFrames.classList.add("active");

      // Enable Next Button
      step0Next.disabled = false;
    }

    choiceNewSystem.addEventListener("click", function () {
      selectStartOption('new');
    });

    choiceImportFile.addEventListener("click", function () {
      selectStartOption('import');
    });

    choiceManageTokens.addEventListener("click", function () {
      if (hasExistingTokens && existingTokensData) {
        selectStartOption('manage');
      }
    });

    choiceVerifyFrames.addEventListener("click", function () {
      selectStartOption('verify');
    });

    // Handle "Continuer" Button Click
    step0Next.addEventListener("click", function () {
      if (!currentStartOption) return;

      if (currentStartOption === 'new') {
        switchStep(1); // Go to library selection
      }
      else if (currentStartOption === 'import') {
        realFileInput.click(); // Open file picker
      }
      else if (currentStartOption === 'manage') {
        // Charger les tokens existants
        console.log("Chargement des tokens existants...");
        currentTokens = existingTokensData;
        currentNaming = existingLibrary || "tailwind";

        // Aller directement à Vue 3
        updatePreview();
        updateExport();
        switchStep(3);
      }
      else if (currentStartOption === 'verify') {
        switchStep(4); // Go to frame verification
      }
    });

    realFileInput.addEventListener("change", function (e) {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        // Parse file and go directly to step 3
        var reader = new FileReader();
        reader.onload = function (event) {
          var content = event.target.result;
          var ext = selectedFile.name.split(".").pop().toLowerCase();
          var tokensFromFile = null;

          try {
            if (ext === "json") {
              tokensFromFile = JSON.parse(content);
            } else if (ext === "css") {
              tokensFromFile = parseCssToTokens(content);
            }

            if (tokensFromFile) {
              // Send explicit import message


              currentTokens = tokensFromFile;
              updatePreview();
              updateExport();
              switchStep(3);

              // Petit feedback visuel optionnel pour dire que le fichier est chargé
              // (Pas figma.notify car le plugin ne sait rien pour l'instant)
              console.log("Fichier chargé en mémoire, prêt à être importé.");
            }
          } catch (err) {
            alert("Error parsing file: " + err.message);
          }
        };
        reader.readAsText(selectedFile);
      }
    });

    // ============================================
    // VUE 1: LIBRAIRIE - Event Listeners
    // ============================================
    libraryOptions.forEach(function (option) {
      option.addEventListener("click", function () {
        // Remove selected from all
        libraryOptions.forEach(function (opt) {
          opt.classList.remove("selected");
        });

        // Add selected to clicked
        option.classList.add("selected");
        currentNaming = option.getAttribute("data-library");

        // Enable next button
        step1Next.disabled = false;
      });
    });

    step1Back.addEventListener("click", function () {
      switchStep(0); // Back to home
    });

    step1Next.addEventListener("click", function () {
      switchStep(2); // Go to color selection
    });

    // ============================================
    // VUE 2: COULEUR - Event Listeners
    // ============================================
    function updateColorPreview(color) {
      colorPreviewBg.style.backgroundColor = color;
    }

    colorPicker.addEventListener("input", function () {
      currentColor = colorPicker.value.toUpperCase();
      colorInput.value = currentColor;
      updateColorPreview(currentColor);
    });

    colorInput.addEventListener("input", function () {
      currentColor = colorInput.value.toUpperCase();
      colorPicker.value = currentColor;
      updateColorPreview(currentColor);
    });

    randomBtn.addEventListener("click", function () {
      var randomColor = "#" + Math.floor(Math.random() * 16777215).toString(16).padStart(6, "0").toUpperCase();
      currentColor = randomColor;
      colorInput.value = randomColor;
      colorPicker.value = randomColor;
      updateColorPreview(randomColor);
    });

    step2Back.addEventListener("click", function () {
      switchStep(1); // Back to library selection
    });

    step2Generate.addEventListener("click", function () {
      // Send message to plugin to generate tokens
      parent.postMessage({
        pluginMessage: {
          type: "generate",
          color: currentColor,
          naming: currentNaming
        }
      }, "*");
    });

    // ============================================
    // VUE 3: RÉSULTAT - Event Listeners
    // ============================================

    // Dashboard Color Picker Logic
    if (dashboardColorPicker) {
      dashboardColorPicker.addEventListener("input", function () {
        var val = dashboardColorPicker.value.toUpperCase();
        dashboardColorValue.textContent = val;
        dashboardColorPreviewBg.style.backgroundColor = val;
      });

      dashboardColorPicker.addEventListener("change", function () {
        var val = dashboardColorPicker.value.toUpperCase();
        currentColor = val;

        // Regenerate
        parent.postMessage({
          pluginMessage: {
            type: "generate",
            color: currentColor,
            naming: currentNaming
          }
        }, "*");
      });
    }

    backToLibBtn.addEventListener("click", function () {
      // Reset library selection
      libraryOptions.forEach(function (opt) {
        opt.classList.remove("selected");
      });
      currentNaming = "";
      step1Next.disabled = true;
      switchStep(1); // Back to library selection
    });

    importBtn.addEventListener("click", function () {
      var shouldOverwrite = overwriteCheckbox.checked;
      parent.postMessage({
        pluginMessage: {
          type: "import",
          naming: currentNaming,
          overwrite: shouldOverwrite,
          tokens: currentTokens
        }
      }, "*");
    });

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function detectPrimaryColorFromTokens(brandTokens) {
      if (!brandTokens) return null;

      // Common keys for the base color depending on library
      var candidates = ['500', 'main', 'primary', 'base', '6'];

      for (var i = 0; i < candidates.length; i++) {
        if (brandTokens[candidates[i]]) {
          return brandTokens[candidates[i]];
        }
      }

      // Fallback: take the first available color if no standard key found
      var keys = Object.keys(brandTokens);
      if (keys.length > 0) return brandTokens[keys[0]];

      return null;
    }

    // ============================================
    // VUE 4: VÉRIFICATION DE FRAME - Event Listeners
    // ============================================

    function updateScanUI() {
      // Masquer tous les états par défaut
      var scanResults = document.getElementById("scanResults");
      var scanEmptyState = document.getElementById("scanEmptyState");
      var scanLoadingState = document.getElementById("scanLoadingState");

      if (scanResults) scanResults.classList.add('hidden');
      if (scanEmptyState) scanEmptyState.classList.remove('hidden'); // Afficher l'état vide par défaut
      if (scanLoadingState) scanLoadingState.classList.add('hidden');

      // Vérifier si une sélection existe dans Figma
      parent.postMessage({
        pluginMessage: {
          type: "check-selection"
        }
      }, "*");
    }

    // Icônes SVG simples et génériques
    var svgIcons = {
      fill: '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>',
      stroke: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>',
      radius: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>',
      spacing: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="1"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="14" y2="12"/><line x1="8" y1="16" x2="12" y2="16"/></svg>'
    };

    // ============================================
    // MAGIC FIX FUNCTIONS - Nouvelle UX
    // ============================================

    // Fonction pour enrichir les suggestions avec leur valeur résolue
    function enrichSuggestionsWithValues(suggestions, property, currentValue) {
      return suggestions.map(function(suggestion) {
        var enriched = Object.assign({}, suggestion);
        if (!enriched.resolvedValue) {
          // Pour les couleurs, la valeur hex est déjà dans suggestion.hex
          if (property === 'Fill' || property === 'Stroke') {
            enriched.resolvedValue = suggestion.hex || currentValue;
          } else {
            // Pour les autres propriétés, on utilise la valeur actuelle comme approximation
            enriched.resolvedValue = currentValue;
          }
        }
        return enriched;
      });
    }

    function groupResultsByValue(results) {
      var groups = {};

      results.forEach(function(result, index) {
        result.originalIndex = index;

        // Créer une clé unique basée sur propriété + valeur
        var groupKey = result.property + '-' + result.value;

        if (!groups[groupKey]) {
          var suggestions = result.colorSuggestions || result.numericSuggestions || [{ id: result.suggestedVariableId, name: result.suggestedVariableName, isExact: true }];
          groups[groupKey] = {
            property: result.property,
            value: result.value,
            originalIndices: [],
            suggestions: enrichSuggestionsWithValues(suggestions, result.property, result.value),
            layerNames: [] // Pour debug si nécessaire
          };
        }

        groups[groupKey].originalIndices.push(index);
        groups[groupKey].layerNames.push(result.layerName);

        // Fusionner les suggestions si elles diffèrent
        var suggestionsToMerge = result.colorSuggestions || result.numericSuggestions;
        if (suggestionsToMerge) {
          suggestionsToMerge.forEach(function(suggestion) {
            var existing = groups[groupKey].suggestions.find(function(s) { return s.id === suggestion.id; });
            if (!existing) {
              var enrichedSuggestions = enrichSuggestionsWithValues([suggestion], result.property, result.value);
              groups[groupKey].suggestions.push(enrichedSuggestions[0]);
            }
          });
        }
      });

      return Object.values(groups);
    }

    function renderCompactRow(group) {
      var hasConflicts = group.suggestions.length > 1;
      var bestSuggestion = group.suggestions[0];

      // Fonction helper pour obtenir l'icône SVG selon le type de propriété
      function getPropertyIcon(property) {
        switch(property) {
          case 'Fill':
            return '<span class="property-label">Fond</span>';
          case 'Stroke':
            return '<span class="property-label">Contour</span>';
          case 'Radius':
            return '<span class="property-label">Rayon</span>';
          case 'Spacing':
          case 'Width':
          case 'Height':
            return '<span class="property-label">Espacement</span>';
          default:
            return '<span class="property-label">' + property + '</span>';
        }
      }

      var html = '<div class="compact-row" data-indices="' + group.originalIndices.join(',') + '" onclick="highlightLayers([' + group.originalIndices.join(',') + '])" style="cursor: pointer;">';

      // Col 1 : Le "Problème" (Valeur Actuelle)
      html += '<div class="col-problem" title="Type: ' + group.property + ' | Valeur: ' + group.value + '">';

      // Icône de type
      html += getPropertyIcon(group.property);

      // Visuel (swatch ou valeur textuelle)
      if (group.property === "Fill" || group.property === "Stroke") {
        html += '<div class="mini-swatch" style="background-color: ' + group.value + ';"></div>';
      } else {
        html += '<span class="value-display">' + group.value + '</span>';
      }

      html += '</div>';

      // Col 2 : Le "Lien"
      html += '<div class="col-arrow">';
      html += '<div class="arrow-symbol">→</div>';
      html += '<div class="layer-count-badge" title="' + group.originalIndices.length + ' calque' + (group.originalIndices.length > 1 ? 's' : '') + ' concerné' + (group.originalIndices.length > 1 ? 's' : '') + '">Sur ' + group.originalIndices.length + ' calque' + (group.originalIndices.length > 1 ? 's' : '') + '</div>';
      html += '</div>';

      // Col 3 : La "Solution" (Variable)
      html += '<div class="col-solution">';
      if (hasConflicts) {
        // Multiple suggestions - select avec bordure orange
        html += '<select class="conflict-select" onchange="applyGroupFix([' + group.originalIndices.join(',') + '], this.value)">';
        html += '<option value="">⚠️ Choisir parmi ' + group.suggestions.length + ' variables</option>';
        group.suggestions.forEach(function(suggestion, idx) {
          var distanceIndicator = suggestion.isExact ? '' : ' ≈';
          var valuePreview = suggestion.hex ? suggestion.hex : (suggestion.value !== undefined ? suggestion.value : "");
          html += '<option value="' + suggestion.id + '">' + suggestion.name + ' (' + valuePreview + ')' + distanceIndicator + '</option>';
        });
        html += '</select>';
      } else {
        // Single suggestion - bouton pill vert
        html += '<button class="variable-pill" onclick="applyGroupFix([' + group.originalIndices.join(',') + '], \'' + bestSuggestion.id + '\')">';
        html += '<svg class="variable-icon" viewBox="0 0 16 16"><path fill="currentColor" d="M8 2l2.5 5 5.5.5-4 4 .5 5.5L8 12l-4 2 .5-5.5-4-4 5.5-.5L8 2z"/></svg>';
        html += '<span>' + bestSuggestion.name + '</span>';
        html += '</button>';
      }
      html += '</div>';

      // Col 4 : Bouton ignorer
      html += '<button class="btn-x" onclick="this.closest(\'.compact-row\').style.display=\'none\'" title="Ignorer ce groupe">×</button>';

      html += '</div>';

      return html;
    }

    // Fonction pour corriger tous les groupes d'une catégorie
    function applyAllCategoryFixes(categoryKey) {
      // Cette fonction sera appelée depuis le HTML généré
      var categoryRows = document.querySelectorAll('details[open] .compact-row');
      var allIndices = [];
      var variableId = null;

      categoryRows.forEach(function(row) {
        var indices = row.getAttribute('data-indices');
        if (indices) {
          var indicesArray = indices.split(',').map(Number);
          allIndices = allIndices.concat(indicesArray);

          // Pour les conflits, on ne peut pas deviner quelle variable choisir
          // Donc on ne traite que les lignes sans conflit
          if (!row.querySelector('.conflict-select')) {
            var pillBtn = row.querySelector('.btn-fix-pill');
            if (pillBtn && pillBtn.onclick) {
              // Extraire le variableId du onclick (c'est un hack, mais ça marche)
              var onclickStr = pillBtn.getAttribute('onclick');
              var match = onclickStr.match(/applyGroupFix\(\[([^\]]+)\],\s*'([^']+)'\)/);
              if (match && match[2]) {
                variableId = variableId || match[2]; // Prendre le premier variableId trouvé
              }
            }
          }
        }
      });

      if (allIndices.length > 0 && variableId) {
        applyGroupFix(allIndices, variableId);
      }
    }

    function highlightLayers(indices) {
      parent.postMessage({
        pluginMessage: {
          type: 'highlight-nodes',
          indices: indices
        }
      }, '*');
    }

    function selectLayers(indices) {
      highlightLayers(indices);
    }

    function applyGroupFix(indices, variableId) {
      parent.postMessage({
        pluginMessage: {
          type: 'apply-group-fix',
          indices: indices,
          variableId: variableId
        }
      }, '*');
    }

    function applyManualGroupFix(indices, buttonElement) {
      // Trouver le sélecteur dans la même carte
      var card = buttonElement.closest('.cleaning-result-card');
      var selector = card.querySelector('.manual-select');
      var variableId = selector.value;

      if (!variableId) {
        return; // Ne rien faire si aucune variable sélectionnée
      }

      parent.postMessage({
        pluginMessage: {
          type: 'apply-group-fix',
          indices: indices,
          variableId: variableId
        }
      }, '*');
    }

    function displayScanResults(results) {
      console.log('[displayScanResults] Démarrage affichage de', results.length, 'résultats');

      // Cas spécial : aucun résultat
      if (!results || results.length === 0) {
        console.log('[displayScanResults] Aucun résultat à afficher');
        // Afficher l'état vide
        if (scanEmptyState) {
          scanEmptyState.classList.remove("hidden");
        }
        if (scanResults) {
          scanResults.classList.add("hidden");
        }
        return;
      }

      // Stocker les résultats globalement pour les corrections individuelles
      lastScanResults = results;
      console.log('[DEBUG displayScanResults] lastScanResults défini avec', results.length, 'résultats');

      // Stocker le nombre initial de problèmes pour la jauge de progression
      initialProblemCount = results.length;

      // 1. Masquer le chargement
      hideScanLoading();

      // 2. Calculer les stats
      var stats = calculateCleaningStats(results);
      updateFilterCounts(stats);

      // 3. Générer le HTML
      var unifiedHtml = generateUnifiedCleaningContent(results, stats);

      // 4. Injecter le HTML (Sécurisé)
      var listContainer = document.getElementById('unifiedCleaningList');
      if (listContainer) {
        listContainer.innerHTML = unifiedHtml;
        console.log('[displayScanResults] HTML injecté dans la liste, longueur:', unifiedHtml.length);
      } else {
        console.error('[displayScanResults] ERREUR CRITIQUE: #unifiedCleaningList introuvable dans le DOM');
      }

      // 4b. Initialiser la jauge de progression
      console.log('[displayScanResults] Initialisation jauge avec', results.length, 'résultats');
      updateProgressGauge(results.length);

      // 5. Assigner les données aux cartes pour les filtres
      var cards = document.querySelectorAll('.cleaning-result-card');
      cards.forEach(function(card, index) {
        if (results[index]) {
          card._resultData = results[index];
        }
      });

      attachCardEventHandlers();
      applyFilter(currentFilter);

      // 6. Forcer l'affichage des conteneurs parents
      var scanResultsDiv = document.getElementById('scanResults');
      if (scanResultsDiv) {
        scanResultsDiv.classList.remove("hidden");
        scanResultsDiv.style.display = "block"; // Force brute
      }


      // 7. Mettre à jour le compteur (avec la sécurité ajoutée précédemment)
      updateProblemCounter(results.length, true);

      console.log('[displayScanResults] Terminé');
    }

    // ============================================
    // NOUVELLES FONCTIONS POUR LE SYSTÈME UNIFIÉ
    // ============================================

    // Mettre à jour les compteurs de filtres
    function updateFilterCounts(stats) {
      document.getElementById('autoCount').textContent = stats.autoFixable;
      document.getElementById('manualCount').textContent = stats.manualFixes;
    }

    // Générer le contenu unifié avec checkboxes
    function generateUnifiedCleaningContent(results, stats) {
      if (results.length === 0) {
        return '<div class="empty-state-enhanced"><div class="empty-icon">✨</div><h3>Aucun problème détecté</h3><p>Votre design utilise déjà des variables partout !</p></div>';
      }

      // Grouper les résultats par propriété + valeur
      var groups = groupResultsByValue(results);
      var html = '';

      groups.forEach(function(group) {
        var hasConflicts = group.suggestions.length > 1;
        var bestSuggestion = group.suggestions[0];
        var layerCount = group.originalIndices.length;

        // Déterminer si c'est auto-fixable (une seule suggestion) ou orphelin (aucune suggestion)
        var isAutoFixable = group.suggestions.length === 1;
        var isOrphan = group.suggestions.length === 0;

        // Classes CSS pour les filtres
        var cardClass = 'cleaning-result-card grouped-card';
        if (isAutoFixable) {
          cardClass += ' auto-fixable';
        } else {
          cardClass += ' manual-required';
        }

        // Nouvelle structure Header + Body
        html += '<div class="' + cardClass + '" data-indices="' + JSON.stringify(group.originalIndices).replace(/"/g, '&quot;') + '" data-card-data="' + JSON.stringify({property: group.property, value: group.value, suggestions: group.suggestions}).replace(/"/g, '&quot;') + '" style="display: flex; flex-direction: column; padding: 12px 16px; margin-bottom: 8px; background: var(--poly-surface); border: 1px solid rgba(138, 213, 63, 0.3); border-radius: 12px; transition: all 0.2s ease; cursor: pointer;" title="Cliquer pour sélectionner les calques dans Figma" onmouseover="this.style.borderColor=\'var(--poly-accent)\'" onmouseout="this.style.borderColor=\'rgba(138, 213, 63, 0.3)\'">';

        // HEADER: Icône + Nom propriété (gauche) + Boutons d'actions (droite)
        html += '<div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';

        // GAUCHE: Icône propriété uniquement
        var propertyIcon = getPropertyIcon(group.property);
        html += '<div style="display: flex; align-items: center;">';
        html += '<span style="color: var(--poly-accent); font-size: 16px;" title="' + group.property + '">' + propertyIcon + '</span>';
        html += '</div>';

        // DROITE: Groupe de 3 boutons d'actions (Voir, Appliquer, Ignorer)
        html += '<div style="display: flex; gap: 6px;">';

        // Bouton Voir (sélectionner les calques)
        var viewTitle = 'Voir les ' + layerCount + ' calque' + (layerCount > 1 ? 's' : '') + ' dans Figma';
        html += '<button class="btn-outline btn-view" data-action="view" data-indices="' + JSON.stringify(group.originalIndices).replace(/"/g, '&quot;') + '" title="' + viewTitle + '">' + '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>' + '</button>';

        // Bouton Appliquer (V) - désactivé pour les orphelins
        var applyDisabled = isOrphan ? ' disabled' : '';
        var applyClass = isOrphan ? 'btn-outline' : 'btn-primary';
        var applyTitle = isOrphan ? 'Aucune variable disponible' : 'Appliquer cette correction aux ' + layerCount + ' calque' + (layerCount > 1 ? 's' : '');
        html += '<button class="' + applyClass + '" data-action="apply" data-indices="' + JSON.stringify(group.originalIndices).replace(/"/g, '&quot;') + '"' + applyDisabled + ' title="' + applyTitle + '">' + '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg>' + '</button>';

        // Bouton Ignorer (X)
        var ignoreTitle = 'Ignorer ce problème pour les ' + layerCount + ' calque' + (layerCount > 1 ? 's' : '');
        html += '<button class="btn-x" data-action="ignore" data-indices="' + JSON.stringify(group.originalIndices).replace(/"/g, '&quot;') + '" title="' + ignoreTitle + '">' + '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' + '</button>';

        html += '</div>';
        html += '</div>';

        // BODY: Valeur actuelle + Compteur + Flèche + Nouvelle valeur + Type
        html += '<div class="card-body" style="display: flex; align-items: center; gap: 12px;">';

        // 1. Valeur actuelle (Swatch ou Texte)
        if (group.property === 'Fill' || group.property === 'Stroke') {
          // Swatch coloré
          html += '<div style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid var(--poly-border-subtle); background-color: ' + group.value + ';"></div>';
        } else {
          // Valeur textuelle
          html += '<div style="font-family: monospace; font-size: 12px; color: var(--poly-text); font-weight: 400;">' + group.value + '</div>';
        }

        // 2. Compteur de calques (texte gris)
        html += '<span style="font-size: 11px; color: var(--poly-text-muted);">' + layerCount + ' calque' + (layerCount > 1 ? 's' : '') + '</span>';

        // 3. Séparateur (flèche longue et fine)
        html += '<span style="color: var(--poly-text-muted); font-size: 14px; margin: 0 4px;">⟶</span>';

        // 4. Nouvelle valeur (Nom de la variable)
        if (isOrphan) {
          html += '<span style="font-size: 12px; color: var(--poly-warning); font-style: italic;">Aucune variable trouvée</span>';
        } else if (hasConflicts) {
          // Conflit: dropdown pour choisir
          html += '<div style="position: relative;">';
          html += '<select class="variable-selector" style="padding: 4px 8px; border: 1px solid var(--poly-border-subtle); border-radius: 4px; background: var(--poly-bg); font-size: 12px; min-width: 120px;">';
          html += '<option value="" disabled selected>Choisir une variable...</option>';
          group.suggestions.forEach(function(suggestion) {
            var selected = suggestion.id === bestSuggestion.id ? ' selected' : '';
            var displayValue = suggestion.resolvedValue || suggestion.hex || '';
            var optionText = displayValue ? suggestion.name + ' (' + displayValue + ')' : suggestion.name;
            html += '<option value="' + suggestion.id + '"' + selected + '>' + suggestion.name + '</option>';
          });
          html += '</select>';
          html += '</div>';
        } else {
          // Suggestion unique: nom de la variable
          html += '<span style="font-size: 12px; color: var(--poly-accent); font-weight: 500;">' + bestSuggestion.name + '</span>';
        }

        // 5. Valeur de la variable (entre parenthèses, texte gris)
        if (!isOrphan) {
          var displayValue = bestSuggestion.resolvedValue || bestSuggestion.hex || 'valeur';
          // Pour les couleurs, afficher le hex, pour les autres afficher la valeur
          if (group.property === 'Fill' || group.property === 'Stroke') {
            displayValue = displayValue; // Le hex est déjà correct
          }
          html += '<span class="variable-value-display" style="font-size: 11px; color: var(--poly-text-muted); font-style: italic;">(' + displayValue + ')</span>';
        }

        html += '</div>';
        html += '</div>';
      });

      return html;
    }

    // Attacher les gestionnaires d'événements aux cartes
    function attachCardEventHandlers() {
      // Gestionnaires de clic sur les cartes pour sélectionner les calques dans Figma
      var cards = document.querySelectorAll('.cleaning-result-card');
      cards.forEach(function(card) {
        card.addEventListener('click', function(event) {
          // Ne pas déclencher si on clique sur les boutons ou les sélecteurs
          if (event.target.closest('button[data-action]') ||
              event.target.closest('.variable-selector')) {
            return;
          }

          // Sélectionner les calques dans Figma
          var indices = JSON.parse(card.getAttribute('data-indices'));
          if (indices && indices.length > 0) {
            selectNodesInFigma(indices);
          }
        });
      });

      // Gestionnaires de sélecteurs de variables pour les conflits
      var variableSelectors = document.querySelectorAll('.variable-selector');
      variableSelectors.forEach(function(selector) {
        selector.addEventListener('change', function() {
          var card = this.closest('.cleaning-result-card');
          var selectedVariableId = this.value;
          card._selectedVariableId = selectedVariableId;

          // Mettre à jour l'affichage de la valeur
          updateCardValueDisplay(card, selectedVariableId);
        });
      });

      // Gestionnaires d'actions groupées
      attachGroupedActionHandlers();

      // Fonction pour mettre à jour l'affichage de la valeur dans une carte
      function updateCardValueDisplay(card, selectedVariableId) {
        // Trouver l'élément qui affiche la valeur
        var valueDisplay = card.querySelector('.variable-value-display');
        if (!valueDisplay) return;

        // Chercher la valeur de la variable sélectionnée dans les données de la carte
        var cardDataAttr = card.getAttribute('data-card-data');
        if (!cardDataAttr) return;

        var cardData = JSON.parse(cardDataAttr.replace(/&quot;/g, '"'));

        // Chercher la suggestion correspondante
        var selectedSuggestion = cardData.suggestions.find(function(s) {
          return s.id === selectedVariableId;
        });

        if (selectedSuggestion) {
          var displayValue = selectedSuggestion.resolvedValue || selectedSuggestion.hex || 'valeur';
          valueDisplay.textContent = '(' + displayValue + ')';
        }
      }

      // Effets de survol pour les boutons d'action
      var actionButtons = document.querySelectorAll('.cleaning-result-card button:not([disabled])');
      actionButtons.forEach(function(btn) {
      });

      // Gestionnaire pour le bouton "Tout corriger"
      var bulkFixBtn = document.getElementById('bulkFixBtn');
      console.log('[UI Init] 🔍 Recherche bouton bulkFixBtn:', !!bulkFixBtn);

      if (bulkFixBtn) {
        console.log('[UI Init] ✅ Bouton bulkFixBtn trouvé, ajout de l\'event listener');

        bulkFixBtn.addEventListener('click', function() {
          console.log('[bulkFixBtn] 🖱️ Clic détecté sur le bouton "Tout corriger"');

          // STRATÉGIE EN DEUX ÉTAPES:
          // 1. Essayer le système complexe existant
          // 2. Si échec, utiliser le système ultra-simple

          var appliedCount = 0;
          var systemUsed = 'complex';

          try {
            // Vérifier s'il y a des résultats du scan complexe
            if (lastScanResults && lastScanResults.length > 0) {
              console.log('[bulkFixBtn] ✅ Résultats du scan complexe disponibles, utilisation applyAllFixes');
              appliedCount = applyAllFixes();
              systemUsed = 'complex';
            } else {
              console.log('[bulkFixBtn] ⚠️ Aucun résultat du scan complexe, utilisation système simple');
              systemUsed = 'simple';

              // Système ultra-simple de secours
              console.log('[bulkFixBtn] 🔧 Lancement scan simple...');
              var simpleResults = simpleScan();

              if (simpleResults.length > 0) {
                console.log('[bulkFixBtn] 🔧 Application simple...');
                appliedCount = simpleApply(simpleResults);
              } else {
                console.log('[bulkFixBtn] ℹ️ Aucun problème trouvé avec le scan simple');
              }
            }
          } catch (error) {
            console.error('[bulkFixBtn] ❌ Erreur avec le système', systemUsed, ':', error);

            // Si le système complexe échoue, essayer le simple
            if (systemUsed === 'complex') {
              console.log('[bulkFixBtn] 🔄 Tentative avec le système simple...');
              try {
                var simpleResults = simpleScan();
                if (simpleResults.length > 0) {
                  appliedCount = simpleApply(simpleResults);
                  systemUsed = 'simple_fallback';
                }
              } catch (simpleError) {
                console.error('[bulkFixBtn] ❌ Même le système simple échoue:', simpleError);
              }
            }
          }

          // Résultat final
          console.log('[bulkFixBtn] 📊 RÉSULTAT FINAL:');
          console.log('  - Système utilisé:', systemUsed);
          console.log('  - Corrections appliquées:', appliedCount);

          if (appliedCount > 0) {
            figma.notify('✅ ' + appliedCount + ' correction(s) appliquée(s) avec succès (' + systemUsed + ')');
            console.log('[bulkFixBtn] 🎉 SUCCÈS: Bouton fonctionnel !');
          } else {
            figma.notify('ℹ️ Aucune correction applicable trouvée');
            console.log('[bulkFixBtn] ℹ️ Aucune correction applicable trouvée');
          }
        });

        console.log('[UI Init] ✅ Event listener ajouté au bouton bulkFixBtn');
      } else {
        console.error('[UI Init] ❌ Bouton bulkFixBtn non trouvé dans le DOM');
        console.log('[UI Init] 🔍 État du DOM au moment de la recherche:', document.body ? 'DOM chargé' : 'DOM pas encore chargé');
      }
    }

    // Gestion de la sélection pour les cartes groupées
    function handleGroupedItemSelection(card, isSelected) {
      console.log('[handleGroupedItemSelection] 🎯 Changement de sélection pour carte:', card.textContent, '->', isSelected);

      var dataIndices = card.getAttribute('data-indices');
      console.log('[handleGroupedItemSelection] 📋 data-indices:', dataIndices);

      if (isSelected) {
        console.log('[handleGroupedItemSelection] ✅ Sélection de la carte');
        card.classList.add('selected');

        if (dataIndices) {
          try {
            var indicesToAdd = JSON.parse(dataIndices);
            console.log('[handleGroupedItemSelection] 📊 Indices à ajouter:', indicesToAdd);
            selectedIndices = selectedIndices.concat(indicesToAdd);
            console.log('[handleGroupedItemSelection] 📊 selectedIndices après ajout:', selectedIndices);
          } catch (parseError) {
            console.error('[handleGroupedItemSelection] ❌ Erreur parsing data-indices:', parseError);
          }
        } else {
          console.warn('[handleGroupedItemSelection] ⚠️ Attribut data-indices manquant sur la carte');
        }
      } else {
        console.log('[handleGroupedItemSelection] ❌ Désélection de la carte');
        card.classList.remove('selected');

        if (dataIndices) {
          try {
            var cardIndices = JSON.parse(dataIndices);
            console.log('[handleGroupedItemSelection] 📊 Indices à retirer:', cardIndices);
            var beforeLength = selectedIndices.length;
            selectedIndices = selectedIndices.filter(function(idx) {
              return cardIndices.indexOf(idx) === -1;
            });
            console.log('[handleGroupedItemSelection] 📊 selectedIndices après retrait:', selectedIndices, '(retiré:', beforeLength - selectedIndices.length, ')');
          } catch (parseError) {
            console.error('[handleGroupedItemSelection] ❌ Erreur parsing data-indices:', parseError);
          }
        }
      }

      console.log('[handleGroupedItemSelection] 🔄 Appel de updateBulkActionsVisibility');
      updateBulkActionsVisibility();
      updateBulkActionsCounts();
    }

    // Gestionnaires d'actions pour les cartes groupées
    function attachGroupedActionHandlers() {
      // Boutons Appliquer groupés
      var applyButtons = document.querySelectorAll('button[data-action="apply"]');
      applyButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var indices = JSON.parse(this.getAttribute('data-indices'));
          var card = this.closest('.cleaning-result-card');
          var selectedVariableId = card._selectedVariableId;

          if (!selectedVariableId) {
            // --- CORRECTION DU BUG ICI ---
            // Ancienne logique erronée : if (suggestions && suggestions.length === 1)

            // Nouvelle logique : On récupère toujours la suggestion du premier élément du groupe
            // (car tous les éléments d'un groupe "Auto" partagent la même suggestion)
            var groupIndices = JSON.parse(card.getAttribute('data-indices'));

            if (groupIndices && groupIndices.length > 0 && lastScanResults) {
              // On prend le premier résultat du groupe pour trouver l'ID de la variable
              var firstResult = lastScanResults[groupIndices[0]];
              if (firstResult) {
                selectedVariableId = firstResult.suggestedVariableId;
              }
            }
          }

          if (selectedVariableId) {
            applyGroupedFix(indices, selectedVariableId);
          }
        });
      });

      // Boutons Ignorer groupés
      var ignoreButtons = document.querySelectorAll('button[data-action="ignore"]');
      ignoreButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var indices = JSON.parse(this.getAttribute('data-indices'));
          ignoreGroupedItems(indices);
        });
      });

      // Boutons Voir groupés (sélectionner les calques dans Figma)
      var viewButtons = document.querySelectorAll('button[data-action="view"]');
      viewButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var indices = JSON.parse(this.getAttribute('data-indices'));
          if (indices && indices.length > 0) {
            selectNodesInFigma(indices);
          }
        });
      });
    }

    // ============================================
    // FONCTIONS POUR CARTES GROUPÉES
    // ============================================

    function applyGroupedFix(indices, variableId) {
      console.log('[applyGroupedFix] Application groupée pour indices:', indices, 'avec variable:', variableId);

      // Trouver et animer la card avant l'application
      var card = document.querySelector('.cleaning-result-card[data-indices*="' + indices[0] + '"]');
      if (card) {
        // Animation de succès
        card.style.transition = 'all 0.3s ease';
        card.style.backgroundColor = 'var(--poly-success-light)';
        card.style.borderColor = 'var(--poly-success)';

        // Désactiver temporairement les contrôles
        var checkbox = card.querySelector('.item-checkbox');
        var buttons = card.querySelectorAll('button[data-action]');
        if (checkbox) checkbox.disabled = true;
        buttons.forEach(function(btn) { btn.disabled = true; });
      }

      // Animation initiale de la card
      if (card) {
        card.style.transition = 'all 0.3s ease';
        card.style.backgroundColor = 'var(--poly-success-light)';
        card.style.borderColor = 'var(--poly-success)';

        var buttons = card.querySelectorAll('button[data-action]');
        buttons.forEach(function(btn) { btn.disabled = true; });
      }

      // Envoyer les messages de correction pour chaque index
      indices.forEach(function(index) {
        if (lastScanResults && lastScanResults[index]) {
          var result = lastScanResults[index];
          console.log('[DEBUG applyGroupedFix] Résultat trouvé pour index', index, ':', result);
          console.log('[DEBUG applyGroupedFix] ID suggéré vs ID demandé:', result.suggestedVariableId, 'vs', variableId);

          // Envoyer un message au plugin principal pour appliquer la correction
          console.log('[DEBUG applyGroupedFix] Envoi du message apply-single-fix pour index', index);
          parent.postMessage({
            pluginMessage: {
              type: "apply-single-fix",
              index: index,
              selectedVariableId: variableId
            }
          }, "*");
        } else {
          console.log('[DEBUG applyGroupedFix] ERREUR: Pas de résultat pour index', index);
        }
      });
    }

    function ignoreGroupedItems(indices) {
      console.log('[ignoreGroupedItems] Ignorer les éléments:', indices);

      // Trouver la card et animer avant suppression
      var card = document.querySelector('.cleaning-result-card[data-indices*="' + indices[0] + '"]');
      if (card) {
        // Animation de rejet
        card.style.transition = 'all 0.3s ease';
        card.style.backgroundColor = 'var(--poly-error-light)';
        card.style.borderColor = 'var(--poly-error)';

        // Désactiver temporairement les contrôles
        var checkbox = card.querySelector('.item-checkbox');
        var buttons = card.querySelectorAll('button[data-action]');
        if (checkbox) checkbox.disabled = true;
        buttons.forEach(function(btn) { btn.disabled = true; });

        // Animation de disparition
        setTimeout(function() {
          card.style.opacity = '0';
          card.style.transform = 'translateX(-20px)';
          setTimeout(function() {
            // Supprimer la card du DOM
            if (card.parentNode) {
              card.parentNode.removeChild(card);
            }
            // Mettre à jour les compteurs
            updateProblemCounter(-indices.length, false);
          }, 300);
        }, 1000);
      } else {
        // Fallback si la card n'est pas trouvée
        indices.forEach(function(index) {
          var card = document.querySelector('.cleaning-result-card[data-indices*="' + index + '"]');
          if (card && card.parentNode) {
            card.parentNode.removeChild(card);
          }
        });
        // Mettre à jour les compteurs
        updateProblemCounter(-indices.length, false);
      }

      // Feedback utilisateur
      showNotification(indices.length + ' élément' + (indices.length > 1 ? 's' : '') + ' ignoré' + (indices.length > 1 ? 's' : ''), 'info');
    }

    function updateBulkActionsVisibility() {
      console.log('[updateBulkActionsVisibility] 🔄 Mise à jour visibilité bouton');
      console.log('[updateBulkActionsVisibility] 📊 selectedIndices.length:', selectedIndices.length);
      console.log('[updateBulkActionsVisibility] 📋 selectedIndices:', selectedIndices);

      var bulkContainer = document.getElementById('bulkActionsContainer');
      var bulkBtn = document.getElementById('bulkFixBtn');

      console.log('[updateBulkActionsVisibility] 🔍 bulkContainer trouvé:', !!bulkContainer);
      console.log('[updateBulkActionsVisibility] 🔍 bulkBtn trouvé:', !!bulkBtn);

      if (selectedIndices.length > 0 && bulkContainer && bulkBtn) {
        console.log('[updateBulkActionsVisibility] ✅ Affichage du bouton (sélection active)');
        bulkContainer.style.display = 'block';
        bulkBtn.disabled = false;
      } else if (bulkContainer) {
        console.log('[updateBulkActionsVisibility] ❌ Masquage du bouton (pas de sélection)');
        bulkContainer.style.display = 'none';
      } else {
        console.warn('[updateBulkActionsVisibility] ⚠️ bulkContainer non trouvé dans le DOM');
      }
    }

    function updateBulkActionsCounts() {
      var applyCount = document.getElementById('applyCount');
      var ignoreCount = document.getElementById('ignoreCount');

      if (applyCount) applyCount.textContent = '(' + selectedIndices.length + ')';
      if (ignoreCount) ignoreCount.textContent = '(' + selectedIndices.length + ')';
    }

    function applyBulkFixes() {
      console.log('[applyBulkFixes] 🚀 Démarrage application en masse pour', selectedIndices.length, 'éléments');

      var indicesToRemove = selectedIndices.slice(); // Copier les indices avant de les vider
      var results = {
        total: selectedIndices.length,
        successful: 0,
        failed: 0,
        details: []
      };

      // Traiter chaque correction avec vérification détaillée
      for (var i = 0; i < selectedIndices.length; i++) {
        var index = selectedIndices[i];
        if (lastScanResults && lastScanResults[index]) {
          var scanResult = lastScanResults[index];

          console.log('[applyBulkFixes] 📋 Traitement index', index, ':', scanResult.layerName, '->', scanResult.property);

          try {
            // Utiliser le nouveau système avec vérification
            var verificationResult = applyAndVerifyFix(scanResult, scanResult.suggestedVariableId);

            if (verificationResult.success) {
              results.successful++;
              console.log('[applyBulkFixes] ✅ SUCCÈS pour index', index, '(' + verificationResult.details.duration + 'ms)');
            } else {
              results.failed++;
              console.log('[applyBulkFixes] ❌ ÉCHEC pour index', index, ':', verificationResult.error);
            }

            // Stocker les détails pour analyse
            results.details.push({
              index: index,
              scanResult: scanResult,
              verificationResult: verificationResult,
              diagnosis: verificationResult.diagnosis
            });

          } catch (error) {
            results.failed++;
            console.error('[applyBulkFixes] 💥 ERREUR CRITIQUE pour index', index, ':', error);

            results.details.push({
              index: index,
              scanResult: scanResult,
              verificationResult: {
                success: false,
                error: error.message,
                details: { duration: 0 }
              }
            });
          }
        } else {
          results.failed++;
          console.warn('[applyBulkFixes] ⚠️ Résultat de scan manquant pour index', index);

          results.details.push({
            index: index,
            scanResult: null,
            verificationResult: {
              success: false,
              error: 'Résultat de scan manquant',
              details: { duration: 0 }
            }
          });
        }
      }

      // Vider la sélection après application
      selectedIndices = [];
      updateBulkActionsVisibility();

      // Mettre à jour l'UI localement
      updateUILocally(indicesToRemove);

      // Notification détaillée
      console.log('[applyBulkFixes] 📊 RÉSULTATS FINAUX:');
      console.log('  - Total traité:', results.total);
      console.log('  - Réussis:', results.successful);
      console.log('  - Échoués:', results.failed);
      console.log('  - Taux de succès:', Math.round((results.successful / results.total) * 100) + '%');

      if (results.successful > 0) {
        figma.notify('✅ ' + results.successful + '/' + results.total + ' corrections appliquées avec succès');
      }

      if (results.failed > 0) {
        console.warn('[applyBulkFixes] ⚠️', results.failed, 'corrections ont échoué. Détails:');

        // Grouper les erreurs par type pour un rapport plus clair
        var errorGroups = {};
        results.details.forEach(function(detail) {
          if (!detail.verificationResult.success && detail.verificationResult.diagnosis) {
            var issue = detail.verificationResult.diagnosis.issue;
            if (!errorGroups[issue]) {
              errorGroups[issue] = {
                count: 0,
                examples: [],
                recommendations: detail.verificationResult.diagnosis.recommendations
              };
            }
            errorGroups[issue].count++;
            if (errorGroups[issue].examples.length < 3) {
              errorGroups[issue].examples.push(detail.scanResult.layerName + ' (' + detail.scanResult.property + ')');
            }
          }
        });

        // Afficher le rapport groupé
        console.log('[applyBulkFixes] 📊 RAPPORT D\'ERREURS:');
        Object.keys(errorGroups).forEach(function(issue) {
          var group = errorGroups[issue];
          console.log('  ❌', issue + ':', group.count, 'cas');
          console.log('    📝 Exemples:', group.examples.join(', '));
          if (group.recommendations.length > 0) {
            console.log('    💡 Solutions:', group.recommendations.join(' | '));
          }
        });

        figma.notify('⚠️ ' + results.failed + ' corrections ont échoué - voir console pour diagnostic');
      }

      // Retourner les résultats détaillés pour analyse
      return results;
    }

    function updateUILocally(removedIndices) {
      console.log('[updateUILocally] Mise à jour locale de l\'UI pour indices supprimés:', removedIndices);

      // Supprimer les cartes correspondantes du DOM
      removedIndices.forEach(function(index) {
        var cards = document.querySelectorAll('.cleaning-result-card');
        cards.forEach(function(card) {
          var cardIndices = JSON.parse(card.getAttribute('data-indices') || '[]');
          if (cardIndices.includes(index)) {
            // Supprimer la carte
            card.remove();
          }
        });
      });

      // Mettre à jour les compteurs dans la status bar
      var remainingCards = document.querySelectorAll('.cleaning-result-card').length;
      updateProblemCounter(remainingCards, false);

      // Masquer la status bar si plus de problèmes
      if (remainingCards === 0) {
        var dashboard = document.getElementById('cleaningDashboard');
        if (dashboard) dashboard.style.display = 'none';

        // Afficher l'état vide
        var scanResults = document.getElementById('scanResults');
        var scanEmptyState = document.getElementById('scanEmptyState');
        if (scanResults) scanResults.classList.add('hidden');
        if (scanEmptyState) scanEmptyState.classList.remove('hidden');
      }
    }

    function updateScanProgress(progress, current, total, status) {
      // Mettre à jour la barre de progression dans l'état de chargement
      var loadingFill = document.querySelector('.loading-fill');
      var loadingBar = document.querySelector('.loading-bar');

      if (loadingFill && loadingBar) {
        loadingFill.style.width = progress + '%';
        loadingBar.style.display = 'block';
      }

      // Mettre à jour le texte de statut
      var loadingText = document.querySelector('#scanLoadingState h3');
      if (loadingText) {
        loadingText.textContent = status || 'Analyse en cours...';
      }

      // Masquer la progression quand terminée
      if (progress >= 100) {
        setTimeout(function() {
          var loadingState = document.getElementById('scanLoadingState');
          if (loadingState) {
            loadingState.style.display = 'none';
          }
        }, 500);
      }
    }

    function selectNodesInFigma(indices) {
      // Envoyer les indices des résultats pour sélectionner les nœuds dans Figma
      parent.postMessage({
        pluginMessage: {
          type: "highlight-nodes",
          indices: indices
        }
      }, "*");
    }

    function handleSingleFixApplied(appliedCount, error, index) {
      console.log('[DEBUG handleSingleFixApplied] Réponse reçue - appliedCount:', appliedCount, 'error:', error, 'index:', index);

      if (error) {
        console.error('[DEBUG handleSingleFixApplied] Erreur lors de l\'application:', error);
        showNotification('Erreur lors de l\'application de la correction', 'error');
        return;
      }

      if (appliedCount > 0) {
        // Trouver et animer la card correspondante
        var cards = document.querySelectorAll('.cleaning-result-card');
        var targetCard = null;

        cards.forEach(function(card) {
          var cardIndices = JSON.parse(card.getAttribute('data-indices') || '[]');
          if (cardIndices.includes(index)) {
            targetCard = card;
          }
        });

        if (targetCard) {
          console.log('[DEBUG handleSingleFixApplied] Animation de la card pour index', index);
          // Animation de succès
          targetCard.style.transition = 'all 0.3s ease';
          targetCard.style.backgroundColor = 'var(--poly-success-light)';
          targetCard.style.borderColor = 'var(--poly-success)';

          // Désactiver les contrôles
          var buttons = targetCard.querySelectorAll('button[data-action]');
          buttons.forEach(function(btn) { btn.disabled = true; });

          // Marquer cette correction comme réussie
          if (!targetCard._appliedIndices) {
            targetCard._appliedIndices = [];
          }
          targetCard._appliedIndices.push(index);

          // Vérifier si toutes les corrections du groupe sont appliquées
          var cardIndices = JSON.parse(targetCard.getAttribute('data-indices') || '[]');
          var allApplied = cardIndices.every(function(idx) {
            return targetCard._appliedIndices && targetCard._appliedIndices.includes(idx);
          });

          if (allApplied) {
            // Feedback utilisateur pour le groupe complet
            showNotification(cardIndices.length + ' correction' + (cardIndices.length > 1 ? 's' : '') + ' appliquée' + (cardIndices.length > 1 ? 's' : '') + ' avec succès !', 'success');

            // Animation de disparition du groupe complet
            setTimeout(function() {
              targetCard.style.opacity = '0';
              targetCard.style.transform = 'translateX(20px)';
              setTimeout(function() {
                // Supprimer la card et mettre à jour les compteurs
                if (targetCard.parentNode) {
                  targetCard.parentNode.removeChild(targetCard);
                }
                updateProblemCounter(-cardIndices.length, false);
              }, 300);
            }, 1000);
          }
        }
      } else {
        console.log('[DEBUG handleSingleFixApplied] Aucune correction appliquée pour index', index);
        showNotification('La correction n\'a pas pu être appliquée', 'warning');

        // Remettre la card à l'état normal en cas d'échec
        var cards = document.querySelectorAll('.cleaning-result-card');
        cards.forEach(function(card) {
          var cardIndices = JSON.parse(card.getAttribute('data-indices') || '[]');
          if (cardIndices.includes(index)) {
            setTimeout(function() {
              card.style.backgroundColor = '';
              card.style.borderColor = '';
              var buttons = card.querySelectorAll('button[data-action]');
              buttons.forEach(function(btn) { btn.disabled = false; });
            }, 1000);
          }
        });
      }
    }

    function requestScanUpdate() {
      // Demander un nouveau scan pour mettre à jour l'UI
      parent.postMessage({ pluginMessage: { type: "scan-frame" } }, "*");
    }

    // ============================================
    // FONCTIONS EXISTANTES MODIFIÉES
    // ============================================

    function calculateCleaningStats(results) {
      if (results.length === 0) {
        return { total: 0, autoFixable: 0, manualFixes: 0, categories: {} };
      }

      var groups = groupResultsByValue(results);
      var autoFixable = 0;
      var manualFixes = 0;
      var categories = {};

      groups.forEach(function(group) {
        var isAutoFixable = group.suggestions.length === 1;

        if (isAutoFixable) {
          autoFixable += group.originalIndices.length; // Compter les éléments dans le groupe
        } else {
          manualFixes += group.originalIndices.length;
        }

        // Comptage par catégorie
        var category = (group.property === "Fill" || group.property === "Stroke") ? "colors" : "geometry";
        if (!categories[category]) {
          categories[category] = { total: 0, auto: 0, manual: 0 };
        }
        categories[category].total += group.originalIndices.length;
        if (isAutoFixable) {
          categories[category].auto += group.originalIndices.length;
        } else {
          categories[category].manual += group.originalIndices.length;
        }
      });

      return {
        total: results.length,
        autoFixable: autoFixable,
        manualFixes: manualFixes,
        categories: categories
      };
    }

    function updateCleaningDashboard(stats) {
      document.getElementById('totalIssues').textContent = stats.total;
      document.getElementById('autoFixable').textContent = stats.autoFixable;
      document.getElementById('manualFixes').textContent = stats.manualFixes;
    }

    function generateAutoCleaningContent(results, stats) {
      // ... (Garder la vérification stats.autoFixable === 0)
      if (stats.autoFixable === 0) {
         return '<div style="text-align: center; padding: 40px 20px; color: var(--poly-text-muted);"><p>🎉 Tout est propre !</p></div>';
      }

      var groups = groupResultsByValue(results);
      var html = '<div class="cleaning-cards-list">';

      groups.forEach(function(group) {
        // On prend les groupes à suggestion unique (Exacte OU Approx)
        if (group.suggestions.length !== 1) return;

        var suggestion = group.suggestions[0];

        // Début Carte
        html += '<div class="cleaning-result-card auto-fixable">';

        // --- COLONNE GAUCHE (Infos) ---
        html += '<div class="auto-card-content">';

          // Badge Propriété (ex: CORNER RADIUS)
          html += '<div class="property-badge">' + group.property + '</div>';

          // Ligne Transformation: "4px -> spacing-1 (4px)"
          html += '<div class="transformation-row">';
            // Valeur actuelle
            if (group.property === "Fill" || group.property === "Stroke") {
               html += '<div class="mini-swatch" style="background-color: ' + group.value + ';"></div>';
               html += '<span>' + group.value + '</span>';
            } else {
               html += '<span>' + group.value + '</span>';
            }

            html += '<span class="trans-arrow">→</span>';
            html += '<span class="var-name">' + suggestion.name + '</span>';

            // Afficher la valeur réelle de la variable entre parenthèses pour confirmation
            // (Note: on suppose que value est proche, on l'affiche pour info)
            if (!suggestion.isExact) {
                 html += '<span class="var-value-muted" title="Légère différence"> (≈)</span>';
            } else {
                 // Si c'est exact, on peut afficher la valeur ou rien
                 html += '<span class="var-value-muted"> (' + group.value + ')</span>';
            }
          html += '</div>'; // Fin transformation-row
        html += '</div>'; // Fin auto-card-content

        // --- COLONNE DROITE (Boutons) ---
        html += '<div class="auto-card-actions">';

          // Bouton Voir les calques
          html += '<button class="btn-see-layers" onclick="selectLayers([' + group.originalIndices.join(',') + '])" title="Voir ' + group.originalIndices.length + ' calque(s)">';
          html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
          html += 'Voir les calques';
          html += '</button>';

          // Bouton Appliquer
          html += '<button class="btn-primary" onclick="applyGroupFix([' + group.originalIndices.join(',') + '], \'' + suggestion.id + '\')">';
          html += 'Appliquer';
          html += '</button>';

        html += '</div>'; // Fin auto-card-actions

        html += '</div>'; // Fin Card
      });

      html += '</div>';
      return html;
    }

    function generateManualCleaningContent(results, stats) {
      if (stats.manualFixes === 0) {
        return '<div style="text-align: center; padding: 40px 20px; color: var(--poly-text-muted);"><p>✅ Aucune correction manuelle requise !</p><p style="font-size: 12px; margin-top: 8px;">Toutes les valeurs correspondent exactement à vos variables.</p></div>';
      }

      var groups = groupResultsByValue(results);
      var html = '<div class="cleaning-cards-list">';

      groups.forEach(function(group) {
        if (group.suggestions.length === 1) return;

        // Début Carte
        html += '<div class="cleaning-result-card manual-fix">';

        // --- COLONNE GAUCHE (Infos) ---
        html += '<div class="manual-card-content">';

          // Badge Propriété (ex: CORNER RADIUS)
          html += '<div class="property-badge">' + group.property + '</div>';

          // Valeur actuelle
          html += '<div class="value-row">';
            if (group.property === "Fill" || group.property === "Stroke") {
               html += '<div class="mini-swatch" style="background-color: ' + group.value + ';"></div>';
               html += '<span>' + group.value + '</span>';
            } else {
               html += '<span>' + group.value + '</span>';
            }
          html += '</div>';

          // Sélecteur de variable
          html += '<div class="variable-selector-row">';
          if (group.suggestions.length > 1) {
            html += '<select class="variable-selector manual-select" data-indices="' + group.originalIndices.join(',') + '" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid var(--poly-border-subtle); background: var(--poly-surface); color: var(--poly-text); font-size: 12px;">';
            html += '<option value="">Choisir une variable...</option>';
            group.suggestions.forEach(function(suggestion, idx) {
              var distanceIndicator = suggestion.isExact ? '' : ' ≈';
              var valuePreview = suggestion.hex ? suggestion.hex : (suggestion.value || "");
              html += '<option value="' + suggestion.id + '">' + suggestion.name + ' (' + valuePreview + ')' + distanceIndicator + '</option>';
            });
            html += '</select>';
          } else {
            html += '<div style="padding: 6px; background: var(--poly-surface-soft); border-radius: 6px; font-size: 12px; color: var(--poly-text-muted);">Variable suggérée : ' + group.suggestions[0].name + '</div>';
          }
          html += '</div>';

        html += '</div>'; // Fin manual-card-content

        // --- COLONNE DROITE (Boutons) ---
        html += '<div class="manual-card-actions">';

          // Bouton Voir les calques
          html += '<button class="btn-see-layers" onclick="selectLayers([' + group.originalIndices.join(',') + '])" title="Voir ' + group.originalIndices.length + ' calque(s)">';
          html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
          html += 'Voir les calques';
          html += '</button>';

          // Bouton Appliquer (désactivé par défaut)
          html += '<button class="btn-primary manual-apply-btn" onclick="applyManualGroupFix([' + group.originalIndices.join(',') + '], this)" disabled>';
          html += 'Appliquer';
          html += '</button>';

        html += '</div>'; // Fin manual-card-actions';

        html += '</div>';
      });

      html += '</div>';
      return html;
    }

    function generateStatusContent(results, stats) {
      if (results.length === 0) {
        return '<div class="status-empty"><span>📈</span><p>Lancez une analyse pour voir l\'état de votre projet</p></div>';
      }

      var html = '<div style="display: grid; gap: 16px;">';

      // Résumé global
      html += '<div style="background: var(--poly-surface-soft); padding: 16px; border-radius: 8px; border: 1px solid var(--poly-border-subtle);">';
      html += '<h6 style="margin: 0 0 12px 0; color: var(--poly-text); font-size: 14px;">📊 Résumé du nettoyage</h6>';
      html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">';

      // Auto-corrigeable
      html += '<div style="text-align: center; padding: 12px; background: ' + (stats.autoFixable > 0 ? 'rgba(22, 163, 74, 0.1)' : 'var(--poly-surface)') + '; border-radius: 6px;">';
      html += '<div style="font-size: 18px; font-weight: 700; color: ' + (stats.autoFixable > 0 ? 'var(--poly-success)' : 'var(--poly-text-muted)') + ';">' + stats.autoFixable + '</div>';
      html += '<div style="font-size: 11px; color: var(--poly-text-muted);">Auto-corrigeables</div>';
      html += '</div>';

      // Manuel
      html += '<div style="text-align: center; padding: 12px; background: ' + (stats.manualFixes > 0 ? 'rgba(245, 158, 11, 0.1)' : 'var(--poly-surface)') + '; border-radius: 6px;">';
      html += '<div style="font-size: 18px; font-weight: 700; color: ' + (stats.manualFixes > 0 ? 'var(--poly-warning)' : 'var(--poly-text-muted)') + ';">' + stats.manualFixes + '</div>';
      html += '<div style="font-size: 11px; color: var(--poly-text-muted);">À corriger manuellement</div>';
      html += '</div>';

      // Total
      html += '<div style="text-align: center; padding: 12px; background: var(--poly-surface); border-radius: 6px;">';
      html += '<div style="font-size: 18px; font-weight: 700; color: var(--poly-accent);">' + stats.total + '</div>';
      html += '<div style="font-size: 11px; color: var(--poly-text-muted);">Total problèmes</div>';
      html += '</div>';

      html += '</div>';
      html += '</div>';

      // Détail par catégorie
      if (Object.keys(stats.categories).length > 0) {
        html += '<div style="background: var(--poly-surface-soft); padding: 16px; border-radius: 8px; border: 1px solid var(--poly-border-subtle);">';
        html += '<h6 style="margin: 0 0 12px 0; color: var(--poly-text); font-size: 14px;">🎨 Détail par catégorie</h6>';

        Object.keys(stats.categories).forEach(function(catKey) {
          var cat = stats.categories[catKey];
          var catName = catKey === 'colors' ? 'Couleurs' : 'Géométrie';
          var catIcon = catKey === 'colors' ? '🎨' : '📐';

          html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--poly-border-subtle);">';
          html += '<div style="display: flex; align-items: center; gap: 8px;">';
          html += '<span>' + catIcon + '</span>';
          html += '<span style="font-weight: 500;">' + catName + '</span>';
          html += '</div>';
          html += '<div style="display: flex; gap: 12px; font-size: 12px;">';
          html += '<span style="color: var(--poly-success);">✓ ' + cat.auto + '</span>';
          html += '<span style="color: var(--poly-warning);">⚠️ ' + cat.manual + '</span>';
          html += '<span style="color: var(--poly-text-muted);">Total: ' + cat.total + '</span>';
          html += '</div>';
          html += '</div>';
        });

        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function toggleBulkActions(stats) {
      var autoActions = document.getElementById('autoCleaningActions');
      var manualActions = document.getElementById('manualCleaningActions');

      autoActions.style.display = stats.autoFixable > 0 ? 'block' : 'none';
      manualActions.style.display = stats.manualFixes > 0 ? 'block' : 'none';
    }

    function getPropertyIcon(property) {
      console.log('[getPropertyIcon] Propriété demandée:', '"' + property + '"');
      switch(property) {
        case 'Fill':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path d="M2.5 2.5H7.5V7.5H2.5V2.5Z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2 1.5H8C8.13261 1.5 8.25979 1.55268 8.35355 1.64645C8.44732 1.74021 8.5 1.86739 8.5 2V8C8.5 8.13261 8.44732 8.25979 8.35355 8.35355C8.25979 8.44732 8.13261 8.5 8 8.5H2C1.86739 8.5 1.74021 8.44732 1.64645 8.35355C1.55268 8.25979 1.5 8.13261 1.5 8V2C1.5 1.86739 1.55268 1.74021 1.64645 1.64645C1.74021 1.55268 1.86739 1.5 2 1.5ZM0.5 2C0.5 1.46957 0.710714 0.960859 1.08579 0.585786C1.46086 0.210714 1.96957 0 2.5 0H7.5C8.03043 0 8.53914 0.210714 8.91421 0.585786C9.28929 0.960859 9.5 1.46957 9.5 2V8C9.5 8.53043 9.28929 9.03914 8.91421 9.41421C8.53914 9.78929 8.03043 10 7.5 10H2.5C1.96957 10 1.46086 9.78929 1.08579 9.41421C0.710714 9.03914 0.5 8.53043 0.5 8V2ZM2.5 7.5V2.5H7.5V7.5H2.5ZM2 2.25C2 2.11193 2.11193 2 2.25 2H7.75C7.88807 2 8 2.11193 8 2.25V7.75C8 7.88807 7.88807 8 7.75 8H2.25C2.11193 8 2 7.88807 2 7.75V2.25Z" fill="currentColor"/></svg><span class="property-label">Fond</span>';
        case 'Stroke':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path d="M2.5 2.5H7.5V7.5H2.5V2.5Z" fill="none" stroke="currentColor" stroke-width="0.5"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2 1.5H8C8.13261 1.5 8.25979 1.55268 8.35355 1.64645C8.44732 1.74021 8.5 1.86739 8.5 2V8C8.5 8.13261 8.44732 8.25979 8.35355 8.35355C8.25979 8.44732 8.13261 8.5 8 8.5H2C1.86739 8.5 1.74021 8.44732 1.64645 8.35355C1.55268 8.25979 1.5 8.13261 1.5 8V2C1.5 1.86739 1.55268 1.74021 1.64645 1.64645C1.74021 1.55268 1.86739 1.5 2 1.5ZM0.5 2C0.5 1.46957 0.710714 0.960859 1.08579 0.585786C1.46086 0.210714 1.96957 0 2.5 0H7.5C8.03043 0 8.53914 0.210714 8.91421 0.585786C9.28929 0.960859 9.5 1.46957 9.5 2V8C9.5 8.53043 9.28929 9.03914 8.91421 9.41421C8.53914 9.78929 8.03043 10 7.5 10H2.5C1.96957 10 1.46086 9.78929 1.08579 9.41421C0.710714 9.03914 0.5 8.53043 0.5 8V2Z" fill="none" stroke="currentColor" stroke-width="0.5"/></svg><span class="property-label">Contour</span>';
        case 'Font Size':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path d="M3.5 6.5H1.2L0.6 8.5H0L2.1 0H2.8L5 8.5H4.4L3.5 6.5ZM3.1 5.5L2.4 1.8L1.7 5.5H3.1ZM6.5 4.5V4.2H6.9V8.5H6.5V8.2C6.3 8.4 6.1 8.5 5.8 8.5C5.1 8.5 4.5 7.9 4.5 7C4.5 6.1 5.1 5.5 5.8 5.5C6.1 5.5 6.3 5.6 6.5 5.8V4.5ZM5.8 7.5C6.1 7.5 6.2 7.3 6.2 7C6.2 6.7 6.1 6.5 5.8 6.5C5.5 6.5 5.4 6.7 5.4 7C5.4 7.3 5.5 7.5 5.8 7.5Z" fill="currentColor"/></svg><span class="property-label">Taille police</span>';
        case 'Radius':
        case 'Top Left Radius':
        case 'Top Right Radius':
        case 'Bottom Left Radius':
        case 'Bottom Right Radius':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path d="M1 8V5C1 3.5 1 2.7 1.3 2.3C1.6 1.9 2.1 1.6 2.6 1.3C3.3 1 4.5 1 6 1H8" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="property-label">Rayon</span>';
        case 'Spacing':
        case 'Item Spacing':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0.5C1 0.367392 0.947321 0.240215 0.853553 0.146447C0.759785 0.0526785 0.632608 0 0.5 0C0.367392 0 0.240215 0.0526785 0.146447 0.146447C0.0526785 0.240215 0 0.367392 0 0.5V9.5C0 9.63261 0.0526785 9.75979 0.146447 9.85355C0.240215 9.94732 0.367392 10 0.5 10C0.632608 10 0.759785 9.94732 0.853553 9.85355C0.947321 9.75979 1 9.63261 1 9.5V0.5ZM9.5 0C9.63261 0 9.75979 0.0526785 9.85355 0.146447C9.94732 0.240215 10 0.367392 10 0.5V9.5C10 9.63261 9.94732 9.75979 9.85355 9.85355C9.75979 9.94732 9.63261 10 9.5 10C9.36739 10 9.24021 9.94732 9.14645 9.85355C9.05268 9.75979 9 9.63261 9 9.5V0.5C9 0.367392 9.05268 0.240215 9.14645 0.146447C9.24021 0.0526785 9.36739 0 9.5 0ZM6 6V4H4V6H6ZM7 4C7 3.73478 6.89464 3.48043 6.70711 3.29289C6.51957 3.10536 6.26522 3 6 3H4C3.73478 3 3.48043 3.10536 3.29289 3.29289C3.10536 3.48043 3 3.73478 3 4V6C3 6.26522 3.10536 6.51957 3.29289 6.70711C3.48043 6.89464 3.73478 7 4 7H6C6.26522 7 6.51957 6.89464 6.70711 6.70711C6.89464 6.51957 7 6.26522 7 6V4Z" fill="currentColor"/></svg><span class="property-label">Espacement</span>';
        case 'Padding':
          return '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 10 10" fill="none" style="margin-right: 3px; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0.5C1 0.367392 0.947321 0.240215 0.853553 0.146447C0.759785 0.0526785 0.632608 0 0.5 0C0.367392 0 0.240215 0.0526785 0.146447 0.146447C0.0526785 0.240215 0 0.367392 0 0.5V9.5C0 9.63261 0.0526785 9.75979 0.146447 9.85355C0.240215 9.94732 0.367392 10 0.5 10C0.632608 10 0.759785 9.94732 0.853553 9.85355C0.947321 9.75979 1 9.63261 1 9.5V0.5ZM9.5 0C9.63261 0 9.75979 0.0526785 9.85355 0.146447C9.94732 0.240215 10 0.367392 10 0.5V9.5C10 9.63261 9.94732 9.75979 9.85355 9.85355C9.75979 9.94732 9.63261 10 9.5 10C9.36739 10 9.24021 9.94732 9.14645 9.85355C9.05268 9.75979 9 9.63261 9 9.5V0.5C9 0.367392 9.05268 0.240215 9.14645 0.146447C9.24021 0.0526785 9.36739 0 9.5 0ZM6 6V4H4V6H6ZM7 4C7 3.73478 6.89464 3.48043 6.70711 3.29289C6.51957 3.10536 6.26522 3 6 3H4C3.73478 3 3.48043 3.10536 3.29289 3.29289C3.10536 3.48043 3 3.73478 3 4V6C3 6.26522 3.10536 6.51957 3.29289 6.70711C3.48043 6.89464 3.73478 7 4 7H6C6.26522 7 6.51957 6.89464 6.70711 6.70711C6.89464 6.51957 7 6.26522 7 6V4Z" fill="currentColor"/></svg><span class="property-label">Padding</span>';
        default:
          return '<span class="property-label">' + property + '</span>';
      }
    }

    // ============================================
    // GESTION DES FILTRES ET SÉLECTIONS
    // ============================================

    var currentFilter = 'auto';
    var selectedItems = new Set();

    // Initialisation du système de filtrage
    function initFilterSystem() {
      var filterButtons = document.querySelectorAll('.filter-btn');

      filterButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          var filterType = this.getAttribute('data-filter');

          // Désactiver tous les filtres
          filterButtons.forEach(function(btn) { btn.classList.remove('active'); });

          // Activer le filtre sélectionné
          this.classList.add('active');
          currentFilter = filterType;

          // Appliquer le filtre
          applyFilter(filterType);
        });
      });

      // Gestionnaire "Appliquer la sélection"
      var applySelectedBtn = document.getElementById('applySelectedBtn');
      if (applySelectedBtn) {
        applySelectedBtn.addEventListener('click', function() {
          applySelectedItems();
        });
      }

      // Gestionnaire "Ignorer la sélection"
      var ignoreSelectedBtn = document.getElementById('ignoreSelectedBtn');
      if (ignoreSelectedBtn) {
        ignoreSelectedBtn.addEventListener('click', function() {
          ignoreSelectedItems();
        });
      }

    }

    // Appliquer un filtre aux éléments affichés
    function applyFilter(filterType) {
      var cards = document.querySelectorAll('.cleaning-result-card');
      var visibleCount = 0;

      cards.forEach(function(card) {
        var isVisible = shouldShowCard(card, filterType);
        card.style.display = isVisible ? 'flex' : 'none';
        if (isVisible) visibleCount++;
      });

      // Mettre à jour l'état vide filtré
      var filteredEmptyState = document.getElementById('filteredEmptyState');
      var unifiedList = document.getElementById('unifiedCleaningList');

      if (visibleCount === 0 && cards.length > 0) {
        filteredEmptyState.style.display = 'block';
        unifiedList.style.display = 'none';
      } else {
        filteredEmptyState.style.display = 'none';
        unifiedList.style.display = 'block';
      }

      // Mettre à jour le titre et description selon le filtre
      updateFilterContent(filterType);

      // Vider la sélection quand on change de filtre
      clearAllSelections();
    }

    // Déterminer si une carte doit être affichée selon le filtre
    function shouldShowCard(card, filterType) {
      var result = card._resultData;
      if (!result) return true;

      // Obtenir les suggestions (color ou numeric)
      var suggestions = result.colorSuggestions || result.numericSuggestions || [];
      var hasVariable = !!result.suggestedVariableId;

      switch (filterType) {
        case 'auto':
          // Correction automatique : a une variable suggérée ET 0 ou 1 suggestion
          return hasVariable && suggestions.length <= 1;
        case 'manual':
          // Correction manuelle : plusieurs suggestions OU pas de variable suggérée
          return suggestions.length > 1 || !hasVariable;
        default:
          return true;
      }
    }

    // Mettre à jour le contenu selon le filtre actif
    function updateFilterContent(filterType) {
      var titleElement = document.getElementById('contentTitle');
      var descElement = document.getElementById('contentDesc');

      switch (filterType) {
        case 'auto':
          titleElement.textContent = 'Corrections automatiques';
          descElement.textContent = 'Ces valeurs correspondent exactement à vos variables et peuvent être corrigées automatiquement.';
          break;
        case 'manual':
          titleElement.textContent = 'Corrections manuelles';
          descElement.textContent = 'Ces valeurs ont plusieurs correspondances possibles. Choisissez la variable appropriée pour chaque cas.';
          break;
      }
    }

    // Sélectionner tous les éléments visibles
    function selectAllVisibleItems() {
      var visibleCards = document.querySelectorAll('.cleaning-result-card[style*="display: flex"]');
      visibleCards.forEach(function(card) {
        var checkbox = card.querySelector('.item-checkbox');
        if (checkbox && !checkbox.checked) {
          checkbox.checked = true;
          handleItemSelection(card, true);
        }
      });
      updateBulkActions();
    }

    // Désélectionner tous les éléments
    function clearAllSelections() {
      selectedItems.clear();
      var checkboxes = document.querySelectorAll('.item-checkbox');
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = false;
      });
      updateBulkActions();
    }

    // Gérer la sélection d'un élément individuel
    function handleItemSelection(card, isSelected) {
      var index = parseInt(card.getAttribute('data-index'));
      if (isSelected) {
        selectedItems.add(index);
      } else {
        selectedItems.delete(index);
      }
      updateBulkActions();
    }

    // Mettre à jour l'affichage des actions groupées
    function updateBulkActions() {
      var bulkActions = document.getElementById('bulkActions');
      var selectedCount = document.getElementById('selectedCount');
      var applyCount = document.getElementById('applyCount');
      var ignoreCount = document.getElementById('ignoreCount');
      var applyBtn = document.getElementById('applySelectedBtn');
      var ignoreBtn = document.getElementById('ignoreSelectedBtn');
      var progressFill = document.getElementById('progressFill');

      var count = selectedItems.size;

      if (count > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = count;
        applyCount.textContent = '(' + count + ')';
        ignoreCount.textContent = '(' + count + ')';
        applyBtn.disabled = false;
        ignoreBtn.disabled = false;

        // Calculer le pourcentage de progression
        var totalCards = document.querySelectorAll('.cleaning-result-card').length;
        var progressPercent = totalCards > 0 ? (count / totalCards) * 100 : 0;
        progressFill.style.width = progressPercent + '%';
      } else {
        bulkActions.style.display = 'none';
      }
    }

    // Appliquer les éléments sélectionnés
    function applySelectedItems() {
      if (selectedItems.size === 0) return;

      // Afficher l'état de chargement
      var applyBtn = document.getElementById('applySelectedBtn');
      applyBtn.classList.add('btn-loading');
      applyBtn.innerHTML = '<div class="loading-spinner"></div><span class="btn-text">Application en cours</span>';

      // Simuler un traitement asynchrone
      setTimeout(function() {
        var appliedCount = 0;
        selectedItems.forEach(function(index) {
          try {
            var result = applySingleFix(index);
            if (result > 0) appliedCount++;
          } catch (e) {
            console.error('Erreur lors de l\'application de la correction', index, ':', e);
          }
        });

        // Relancer l'analyse pour mettre à jour l'UI
        parent.postMessage({
          pluginMessage: {
            type: 'scan-frame'
          }
        }, '*');

        // Notification
        figma.notify('✅ ' + appliedCount + ' correction(s) appliquée(s)');

        // Réinitialiser le bouton
        applyBtn.classList.remove('btn-loading');
        applyBtn.innerHTML = '<span class="btn-icon">⚡</span><span class="btn-text">Appliquer la sélection</span><span class="btn-count" id="applyCount">(0)</span>';

      }, 1000);
    }

    // Ignorer les éléments sélectionnés
    function ignoreSelectedItems() {
      selectedItems.forEach(function(index) {
        var card = document.querySelector('.cleaning-result-card[data-index="' + index + '"]');
        if (card) {
          card.style.display = 'none';
          updateProblemCounter(-1);
        }
      });

      clearAllSelections();
      figma.notify('👁️ ' + selectedItems.size + ' élément(s) ignoré(s)');
    }

    // Afficher l'aide contextuelle
    function showHelpTooltip() {
      var helpHtml = '<div style="background: var(--poly-surface); padding: 20px; border-radius: 8px; border: 1px solid var(--poly-border-subtle); max-width: 400px;">';
      helpHtml += '<h4 style="margin-bottom: 12px; color: var(--poly-text);">Comment utiliser l\'analyse intelligente</h4>';
      helpHtml += '<ul style="margin: 0; padding-left: 20px; color: var(--poly-text-muted); line-height: 1.5;">';
      helpHtml += '<li>Sélectionnez une frame dans Figma</li>';
      helpHtml += '<li>Cliquez sur "Lancer l\'analyse"</li>';
      helpHtml += '<li>Utilisez les filtres pour voir les corrections</li>';
      helpHtml += '<li>Sélectionnez et appliquez les changements</li>';
      helpHtml += '</ul>';
      helpHtml += '<button onclick="this.parentElement.style.display=\'none\'" style="margin-top: 16px; padding: 8px 16px; background: var(--poly-accent); color: white; border: none; border-radius: 4px; cursor: pointer;">Compris</button>';
      helpHtml += '</div>';

      var helpContainer = document.createElement('div');
      helpContainer.innerHTML = helpHtml;
      helpContainer.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: rgba(0,0,0,0.5); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;';
      helpContainer.addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });

      document.body.appendChild(helpContainer);
    }

    // Afficher l'état de chargement pendant l'analyse
    function showScanLoading() {
      var scanEmptyState = document.getElementById('scanEmptyState');
      var scanResults = document.getElementById('scanResults');
      var scanLoadingState = document.getElementById('scanLoadingState');

      if (scanEmptyState) scanEmptyState.classList.add('hidden');
      if (scanResults) scanResults.classList.add('hidden');
      if (scanLoadingState) scanLoadingState.classList.remove('hidden');

    }

    // Masquer l'état de chargement
    function hideScanLoading() {
      var scanLoadingState = document.getElementById('scanLoadingState');
      if (scanLoadingState) scanLoadingState.classList.add('hidden');

    }

    // Fonction pour mettre à jour le bouton principal selon l'onglet actif
    function updateMainActionButton(activeTab) {
      var scanBtn = document.getElementById('scanBtn');
      if (!scanBtn) return;

      // Supprimer les anciens event listeners
      scanBtn.onclick = null;

      if (activeTab === 'auto') {
        scanBtn.textContent = '✅ Appliquer toutes les corrections auto';
        scanBtn.onclick = function() {
          applyAllAutoFixes();
        };
      } else if (activeTab === 'manual') {
        scanBtn.textContent = '🎯 Appliquer les corrections manuelles';
        scanBtn.onclick = function() {
          applyAllManualFixes();
        };
      }
    }

    // Gestionnaire pour les sélecteurs manuels
    function initManualSelectors() {
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('manual-select')) {
          var indices = e.target.getAttribute('data-indices').split(',');
          var variableId = e.target.value;
          var card = e.target.closest('.cleaning-result-card');
          var applyBtn = card.querySelector('.manual-apply-btn');

          if (variableId) {
            // Marquer cette ligne comme prête
            card.classList.add('ready-to-apply');
            // Activer le bouton individuel
            if (applyBtn) {
              applyBtn.disabled = false;
            }

            // Activer le bouton d'application groupée si nécessaire
            updateManualApplyButton();
          } else {
            card.classList.remove('ready-to-apply');
            // Désactiver le bouton individuel
            if (applyBtn) {
              applyBtn.disabled = true;
            }
            updateManualApplyButton();
          }
        }
      });
    }

    function updateManualApplyButton() {
      var readyCards = document.querySelectorAll('.manual-fix.ready-to-apply');
      var applyBtn = document.getElementById('applyAllManualBtn');

      if (readyCards.length > 0) {
        applyBtn.disabled = false;
        applyBtn.textContent = '✅ Appliquer les ' + readyCards.length + ' sélection' + (readyCards.length > 1 ? 's' : '');
      } else {
        applyBtn.disabled = true;
        applyBtn.textContent = '⚠️ Appliquer les sélections manuelles';
      }
    }

    // Application groupée des corrections manuelles
    function applyAllManualFixes() {
      var readyCards = document.querySelectorAll('.manual-fix.ready-to-apply');
      var fixesApplied = 0;

      readyCards.forEach(function(card) {
        var select = card.querySelector('.manual-select');
        if (select && select.value) {
          var indices = select.getAttribute('data-indices').split(',');
          var variableId = select.value;

          // Simuler l'application (vous devrez adapter selon votre logique existante)
          applyGroupFix(indices, variableId);
          fixesApplied++;
        }
      });

      if (fixesApplied > 0) {
        // Feedback utilisateur
        showNotification(fixesApplied + ' correction' + (fixesApplied > 1 ? 's' : '') + ' manuelle' + (fixesApplied > 1 ? 's' : '') + ' appliquée' + (fixesApplied > 1 ? 's' : '') + ' !', 'success');
      }
    }

    function showNotification(message, type) {
      // Créer une notification temporaire
      var notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; max-width: 300px;';
      notification.style.background = type === 'success' ? 'var(--poly-success)' : 'var(--poly-warning)';
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(function() {
        notification.remove();
      }, 3000);
    }

    // Appliquer toutes les corrections automatiques
    function applyAllAutoFixes() {
      var autoCards = document.querySelectorAll('.cleaning-result-card.auto-fixable');
      var fixesApplied = 0;

      autoCards.forEach(function(card) {
        var applyBtn = card.querySelector('button[onclick*="applyGroupFix"]');
        if (applyBtn) {
          // Extraire les paramètres de l'attribut onclick
          var onclickStr = applyBtn.getAttribute('onclick');
          var match = onclickStr.match(/applyGroupFix\(\[([^\]]+)\],\s*'([^']+)'\)/);
          if (match) {
            var indices = match[1].split(',').map(function(s) { return parseInt(s.trim()); });
            var variableId = match[2];
            applyGroupFix(indices, variableId);
            fixesApplied++;
          }
        }
      });

      if (fixesApplied > 0) {
        // Désactiver le bouton pendant l'application
        var applyBtn = document.getElementById('applyAllAutoBtn');
        applyBtn.disabled = true;
        applyBtn.textContent = 'Application en cours...';

        // Feedback utilisateur
        showNotification(fixesApplied + ' correction' + (fixesApplied > 1 ? 's' : '') + ' automatique' + (fixesApplied > 1 ? 's' : '') + ' appliquée' + (fixesApplied > 1 ? 's' : '') + ' !', 'success');
      }
    }

    // Exporter un rapport de nettoyage
    function exportCleaningReport() {
      var stats = {
        totalIssues: parseInt(document.getElementById('totalIssues').textContent) || 0,
        autoFixable: parseInt(document.getElementById('autoFixable').textContent) || 0,
        manualFixes: parseInt(document.getElementById('manualFixes').textContent) || 0,
        timestamp: new Date().toISOString(),
        version: '1.0'
      };

      var report = {
        title: 'Rapport de nettoyage Emma Plugin',
        date: new Date().toLocaleDateString('fr-FR'),
        stats: stats,
        summary: {
          total_problems: stats.totalIssues,
          auto_correctable: stats.autoFixable,
          manual_required: stats.manualFixes,
          completion_rate: stats.totalIssues > 0 ? Math.round((stats.autoFixable / stats.totalIssues) * 100) : 100
        }
      };

      // Créer un blob avec le rapport JSON
      var reportJson = JSON.stringify(report, null, 2);
      var blob = new Blob([reportJson], { type: 'application/json' });

      // Simuler un téléchargement (dans un vrai plugin, ceci serait géré côté plugin principal)
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'emma-cleaning-report-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification('Rapport exporté avec succès !', 'success');
    }

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', function() {
      initFilterSystem();
      initManualSelectors();
    });

    // Fonction helper pour générer le sélecteur de variable
    function generateVariableSelector(result, index) {
      var suggestions = result.colorSuggestions || result.numericSuggestions || [];
      var hasSingleExactMatch = suggestions.length === 1 && suggestions[0].isExact;

      // Si pas de suggestions mais qu'il y a une variable suggérée, créer une suggestion exacte
      if (suggestions.length === 0 && result.suggestedVariableId) {
        suggestions = [{ id: result.suggestedVariableId, name: result.suggestedVariableName, isExact: true }];
        hasSingleExactMatch = true;
      }

      // Vérifier si des suggestions ont un scope mismatch
      var hasScopeMismatch = suggestions.some(function(s) { return s.scopeMismatch; });

      if (hasSingleExactMatch) {
        // Correspondance exacte : badge statique
        var badgeStyle = hasScopeMismatch ?
          'background: var(--poly-warning); border: 1px solid var(--poly-warning);' :
          'background: var(--poly-accent);';
        var badgeHtml = '<div class="variable-badge exact-match" style="' + badgeStyle + ' color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; font-family: monospace;">' + result.suggestedVariableName;
        if (hasScopeMismatch) {
          badgeHtml += ' ⚠️';
        }
        badgeHtml += '</div>';
        return badgeHtml;
      } else if (suggestions.length > 0) {
        // Suggestions multiples : dropdown stylisé
        var dropdownStyle = hasScopeMismatch ?
          'background: var(--poly-warning); border: 1px solid var(--poly-warning);' :
          'background: var(--poly-accent);';
        var selectHtml = '<div style="position: relative;">';
        selectHtml += '<select class="variable-selector" data-index="' + index + '" style="appearance: none; ' + dropdownStyle + ' color: white; border: none; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; font-family: monospace; cursor: pointer; min-width: 80px;">';

        suggestions.forEach(function(suggestion, idx) {
          var selected = idx === 0 ? 'selected' : '';
          var distanceIndicator = suggestion.isExact ? '' : ' ≈';
          var scopeIndicator = suggestion.scopeMismatch ? ' ⚠️' : '';
          var valuePreview = suggestion.hex ? suggestion.hex : (suggestion.value !== undefined ? suggestion.value : "");
          selectHtml += '<option value="' + suggestion.id + '" ' + selected + '>' + suggestion.name + ' (' + valuePreview + ')' + distanceIndicator + scopeIndicator + '</option>';
        });

        selectHtml += '</select>';
        // Flèche du dropdown
        selectHtml += '<span style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); pointer-events: none; color: white; font-size: 8px;">▼</span>';
        selectHtml += '</div>';
        return selectHtml;
      }
    }

    function generateColorCard(result) {
      var icon = result.property === "Fill" ? svgIcons.fill : svgIcons.stroke;
      var cardHtml = '<div class="scan-result-card" data-index="' + result.originalIndex + '" style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: var(--poly-surface-soft); border: 1px solid var(--poly-border-subtle); border-radius: 8px; transition: all 0.2s ease;">';

      // Icône et nom de la propriété
      cardHtml += '<div style="display: flex; align-items: center; min-width: 80px; margin-right: 16px;">';
      cardHtml += '<span style="color: var(--poly-accent); margin-right: 6px;">' + icon + '</span>';
      cardHtml += '<span style="font-size: 12px; color: var(--poly-text-muted); font-weight: 500;">' + result.property + '</span>';
      cardHtml += '</div>';

      // Nom du layer
      cardHtml += '<div style="flex: 1; margin-right: 16px;">';
      cardHtml += '<div style="font-weight: 500; font-size: 13px; color: var(--poly-text-primary); margin-bottom: 2px;">' + result.layerName + '</div>';
      cardHtml += '</div>';

      // Transformation visuelle couleur
      cardHtml += '<div style="display: flex; align-items: center; margin-right: 16px;">';
      // Rond avec la couleur brute
      cardHtml += '<div style="width: 20px; height: 20px; border-radius: 50%; background-color: ' + result.value + '; border: 1px solid var(--poly-border-subtle); margin-right: 8px;"></div>';
      // Flèche
      cardHtml += '<span style="color: var(--poly-text-muted); margin-right: 8px;">→</span>';
      // Sélecteur de variable (badge ou dropdown)
      cardHtml += generateVariableSelector(result);
      cardHtml += '</div>';

      // Boutons d'action
      cardHtml += '<div style="display: flex; gap: 4px;">';
      cardHtml += '<button class="btn-primary" data-action="apply" data-index="' + result.originalIndex + '" title="Appliquer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg></button>';
      cardHtml += '<button class="btn-x" data-action="ignore" data-index="' + result.originalIndex + '" title="Ignorer"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';
      cardHtml += '</div>';

      cardHtml += '</div>';
      return cardHtml;
    }

    function generateGeometryCard(result) {
      var icon = result.property.includes("Radius") ? svgIcons.radius : svgIcons.spacing;
      var cardHtml = '<div class="scan-result-card" data-index="' + result.originalIndex + '" style="display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: var(--poly-surface-soft); border: 1px solid var(--poly-border-subtle); border-radius: 8px; transition: all 0.2s ease;">';

      // Icône et nom de la propriété
      cardHtml += '<div style="display: flex; align-items: center; min-width: 80px; margin-right: 16px;">';
      cardHtml += '<span style="color: var(--poly-accent); margin-right: 6px;">' + icon + '</span>';
      cardHtml += '<span style="font-size: 12px; color: var(--poly-text-muted); font-weight: 500;">' + result.property + '</span>';
      cardHtml += '</div>';

      // Nom du layer
      cardHtml += '<div style="flex: 1; margin-right: 16px;">';
      cardHtml += '<div style="font-weight: 500; font-size: 13px; color: var(--poly-text-primary); margin-bottom: 2px;">' + result.layerName + '</div>';
      cardHtml += '</div>';

      // Transformation visuelle mesure
      cardHtml += '<div style="display: flex; align-items: center; margin-right: 16px;">';
      // Valeur en px
      cardHtml += '<span style="font-family: monospace; font-size: 13px; color: var(--poly-text-primary); margin-right: 8px;">' + result.value + '</span>';
      // Flèche
      cardHtml += '<span style="color: var(--poly-text-muted); margin-right: 8px;">→</span>';
      // Sélecteur de variable (badge ou dropdown)
      cardHtml += generateVariableSelector(result);
      cardHtml += '</div>';

      // Boutons d'action
      cardHtml += '<div style="display: flex; gap: 4px;">';
      cardHtml += '<button class="btn-primary" data-action="apply" data-index="' + result.originalIndex + '" title="Appliquer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg></button>';
      cardHtml += '<button class="btn-x" data-action="ignore" data-index="' + result.originalIndex + '" title="Ignorer"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';
      cardHtml += '</div>';

      cardHtml += '</div>';
      return cardHtml;
    }

    function attachActionHandlers() {
      // Gestionnaire pour les boutons d'action
      var actionButtons = document.querySelectorAll('button[data-action]');
      actionButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          var action = this.getAttribute('data-action');
          var index = parseInt(this.getAttribute('data-index'));

          if (action === 'apply') {
            // Récupérer la variable sélectionnée depuis le dropdown si elle existe
            var selectedVariableId = null;
            var card = this.closest('.scan-result-card');
            if (card) {
              var selector = card.querySelector('.variable-selector');
              if (selector) {
                selectedVariableId = selector.value;
              }
            }

            // Envoyer le message apply-single-fix avec la variable sélectionnée
            parent.postMessage({
              pluginMessage: {
                type: "apply-single-fix",
                index: index,
                selectedVariableId: selectedVariableId
              }
            }, "*");

            // Masquer la carte immédiatement
            if (card) {
              card.style.display = 'none';
              updateProblemCounter(-1);
            }
          } else if (action === 'ignore') {
            // Masquer la carte visuellement
            var card = this.closest('.scan-result-card');
            if (card) {
              card.style.display = 'none';
              updateProblemCounter(-1);
            }
          }
        });
      });
    }

    function updateProblemCounter(change, reset) {
      // Sécurité : si la liste n'existe pas, on arrête tout pour éviter le crash
      if (!scanResultsList) return;

      var counterElement = document.getElementById('problemCounter');
      if (!counterElement) {
        // Créer le compteur s'il n'existe pas
        // On utilise la classe parente directe ou le parentElement
        var scanResultsContainer = document.querySelector('.cleaning-content') || scanResultsList.parentElement;
        if (scanResultsContainer) {
          var counterHtml = '<div id="problemCounter" style="text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--poly-text-muted);">';
          counterHtml += '<span id="problemCount" style="font-weight: 600; color: var(--poly-accent); font-size: 18px;">0</span>';
          counterHtml += '</div>';
          // Insertion sécurisée
          var fragment = document.createRange().createContextualFragment(counterHtml);
          scanResultsContainer.insertBefore(fragment, scanResultsList);
          counterElement = document.getElementById('problemCounter');
        }
      }

      if (counterElement) {
        var countElement = document.getElementById('problemCount');
        if (countElement) {
          var currentCount;
          if (reset) {
            currentCount = 0;
          } else {
            currentCount = parseInt(countElement.textContent) || 0;
          }
          var newCount = Math.max(0, currentCount + change);
          countElement.textContent = newCount;

          // Masquer le compteur si aucun problème
          counterElement.style.display = newCount > 0 ? 'block' : 'none';
        }
      }

      // Mettre à jour les compteurs dans la status bar
      updateStatusBarCounters();
    }

    function updateStatusBarCounters() {
      // Recalculer les stats basées sur les cartes restantes
      var remainingCards = document.querySelectorAll('.cleaning-result-card');
      var total = 0;
      var autoFixable = 0;
      var manual = 0;

      remainingCards.forEach(function(card) {
        total++;
        if (card.classList.contains('auto-fixable')) {
          autoFixable++;
        } else if (card.classList.contains('manual-required')) {
          manual++;
        }
      });

      // Mettre à jour la status bar
      var totalIssues = document.getElementById('totalIssues');
      var autoFixableEl = document.getElementById('autoFixable');
      var manualFixes = document.getElementById('manualFixes');

      if (totalIssues) totalIssues.textContent = total;
      if (autoFixableEl) autoFixableEl.textContent = autoFixable;
      if (manualFixes) manualFixes.textContent = manual;

      // Mettre à jour la jauge de progression
      updateProgressGauge(total);
    }

    function updateProgressGauge(remainingProblems) {
      var progressPercentage = document.getElementById('progressPercentage');
      var progressRing = document.getElementById('progressRing');

      if (!progressPercentage || !progressRing) return;

      // Calculer le pourcentage de progression
      // On considère que le nettoyage initial a 100% de problèmes
      // Le pourcentage représente le nettoyage effectué (problèmes résolus)
      var initialTotal = initialProblemCount || 0;

      // Si on n'a pas de total initial ou qu'il n'y a plus de problèmes, considérer comme 100%
      if (initialTotal === 0 || remainingProblems === 0) {
        var progressPercent = 100;
      } else {
        progressPercent = Math.round(((initialTotal - remainingProblems) / initialTotal) * 100);
        progressPercent = Math.max(0, Math.min(100, progressPercent)); // S'assurer que c'est entre 0 et 100
      }

      // Mettre à jour le texte du pourcentage
      progressPercentage.textContent = progressPercent;

      // Mettre à jour l'animation du cercle
      var circumference = 219.91; // 2 * π * 35 (rayon du cercle)
      var offset = circumference - (progressPercent / 100) * circumference;
      progressRing.style.strokeDashoffset = offset;

      // Changer la couleur selon le progrès
      if (progressPercent === 100) {
        progressRing.style.stroke = 'var(--poly-success)';
      } else if (progressPercent > 50) {
        progressRing.style.stroke = 'var(--poly-accent)';
      } else {
        progressRing.style.stroke = 'var(--poly-warning)';
      }
    }

    function applyAllFixes() {
      parent.postMessage({
        pluginMessage: {
          type: "apply-all-fixes"
        }
      }, "*");

      // Désactiver les boutons pendant l'application
      var applyAllBtn = document.getElementById("applyAllBtn");
      var step4ApplyAll = document.getElementById("step4ApplyAll");

      if (applyAllBtn) {
        applyAllBtn.disabled = true;
        applyAllBtn.textContent = "Application en cours...";
      }
      if (step4ApplyAll) {
        step4ApplyAll.disabled = true;
        step4ApplyAll.textContent = "⏳ Application...";
      }
    }

    // Scan buttons
    scanBtn.addEventListener("click", function () {
      showScanLoading();
      parent.postMessage({
        pluginMessage: {
          type: "scan-frame"
        }
      }, "*");
    });


    // Apply all fixes button
    var applyAllBtn = document.getElementById("applyAllBtn");
    if (applyAllBtn) {
      applyAllBtn.addEventListener("click", function () {
        applyAllFixes();
      });
    }

    // Back button
    step4Back.addEventListener("click", function () {
      switchStep(0);
    });

    // Apply all button (sticky footer)
    if (step4ApplyAll) {
      step4ApplyAll.addEventListener("click", function () {
        applyAllFixes();
      });
    }

    // ============================================
    // NOUVEAUX GESTIONNAIRES POUR L'INTERFACE HIÉRARCHISÉE
    // ============================================

    // Bouton appliquer toutes les corrections automatiques
    var applyAllAutoBtn = document.getElementById("applyAllAutoBtn");
    if (applyAllAutoBtn) {
      applyAllAutoBtn.addEventListener("click", function () {
        applyAllAutoFixes();
      });
    }

    // Bouton appliquer les sélections manuelles
    var applyAllManualBtn = document.getElementById("applyAllManualBtn");
    if (applyAllManualBtn) {
      applyAllManualBtn.addEventListener("click", function () {
        applyAllManualFixes();
      });
    }

    // Bouton exporter le rapport
    var exportReportBtn = document.getElementById("exportReportBtn");
    if (exportReportBtn) {
      exportReportBtn.addEventListener("click", function () {
        exportCleaningReport();
      });
    }

    // ============================================
    // MESSAGES FROM PLUGIN
    // ============================================
    window.onmessage = function (event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;


      if (msg.type === "tokens-generated") {
        currentTokens = msg.tokens;
        updatePreview();
        updateExport();

        // Afficher la section ANALYSER & CORRIGER maintenant qu'il y a des tokens
        var sectionAnalyze = document.querySelector('.section-analyze');
        if (sectionAnalyze) {
          sectionAnalyze.style.display = '';
        }

        // Activer l'option "Gérer les variables locales" puisqu'il y a des tokens
        if (choiceManageTokens) {
          choiceManageTokens.classList.remove("hidden");
        }

        switchStep(3); // Show preview
      }

      if (msg.type === "has-variables") {
        if (msg.value === true) {
          // Only show if in Designer mode
          if (!designerView.classList.contains("hidden")) {
            overwriteCheckboxContainer.classList.remove("hidden");
          }
        } else {
          overwriteCheckboxContainer.classList.add("hidden");
        }
      }

      // Nouveau : Gestion des tokens existants
      if (msg.type === "existing-tokens") {
        console.log("Message existing-tokens reçu:", msg);

        if (msg.tokens && Object.keys(msg.tokens).length > 0) {
          hasExistingTokens = true;
          existingTokensData = msg.tokens;
          existingLibrary = msg.library || "tailwind";

          // 🚨 FIX: Detect and Update Primary Color State
          if (existingTokensData.brand) {
            var detectedColor = detectPrimaryColorFromTokens(existingTokensData.brand);
            if (detectedColor) {
              console.log("Couleur primaire détectée:", detectedColor);
              currentColor = detectedColor;

              // Update Inputs
              if (colorInput) colorInput.value = currentColor;
              if (colorPicker) colorPicker.value = currentColor;

              // Update Dashboard Inputs if they exist
              if (dashboardColorPicker) dashboardColorPicker.value = currentColor;
              if (dashboardColorValue) dashboardColorValue.textContent = currentColor;
              if (dashboardColorPreviewBg) dashboardColorPreviewBg.style.backgroundColor = currentColor;

              // Update Wizard Step 2 Preview
              updateColorPreview(currentColor);
            }
          }

          console.log("Tokens stockés dans existingTokensData:", existingTokensData);

          // Compter le nombre total de tokens
          var totalTokens = 0;
          for (var category in msg.tokens) {
            if (msg.tokens.hasOwnProperty(category)) {
              totalTokens += Object.keys(msg.tokens[category]).length;
            }
          }

          console.log("Nombre total de tokens:", totalTokens);

          // Afficher la 3ème carte et s'assurer que la section est visible
          choiceManageTokens.classList.remove("hidden");
          var sectionAnalyze = document.querySelector('.section-analyze');
          if (sectionAnalyze) {
            sectionAnalyze.style.display = '';
          }

          // Gérer l'affichage de la grille (deux cartes visibles)
          var analyzeChoiceGrid = choiceManageTokens.closest('.choice-grid');
          if (analyzeChoiceGrid) {
            analyzeChoiceGrid.classList.remove("single-card");
          }

          // Mettre à jour les informations
          var libraryNames = {
            "tailwind": "Tailwind / Shadcn",
            "mui": "Material UI",
            "ant": "Ant Design",
            "bootstrap": "Bootstrap",
            "chakra": "Chakra UI",
            "custom": "Custom"
          };

          existingTokensInfo.textContent = "Librairie : " + (libraryNames[existingLibrary] || existingLibrary);
          existingTokensCount.textContent = totalTokens + " token" + (totalTokens > 1 ? "s" : "");
        } else {
          // Pas de tokens existants - mais on garde la section ANALYSER & CORRIGER visible
          // pour permettre l'analyse même sans tokens pré-existants
          hasExistingTokens = false;
          console.log('[UI] Pas de tokens existants, mais section d\'analyse gardée visible');
        }
      }

      // Gestion des messages de vérification de frame
      if (msg.type === "scan-results") {
        // Masquer l'état de chargement d'abord
        hideScanLoading();

        // S'assurer qu'on est sur l'étape d'analyse (4)
        if (currentStep !== 4) {
          switchStep(4);
        }

        // Afficher les résultats
        var scanResults = document.getElementById("scanResults");
        var scanEmptyState = document.getElementById("scanEmptyState");

        if (scanResults) {
          scanResults.classList.remove("hidden");
        }
        if (scanEmptyState) {
          scanEmptyState.classList.add("hidden");
        }

        displayScanResults(msg.results);
      }

      if (msg.type === "scan-progress") {
        updateScanProgress(msg.progress, msg.current, msg.total, msg.status);
      }

      if (msg.type === "single-fix-applied") {
        handleSingleFixApplied(msg.appliedCount, msg.error, msg.index);
      }

      if (msg.type === "selection-checked") {
        if (msg.hasSelection) {
          scanBtn.disabled = false;
          scanBtn.textContent = "Lancer l'analyse";
          scanBtn.className = "btn-primary"; // Bouton vert quand frame sélectionnée

          // Remettre la fonction d'origine (lancer l'analyse)
          scanBtn.onclick = function() {
            showScanLoading();
            parent.postMessage({
              pluginMessage: {
                type: 'scan-frame'
              }
            }, '*');
          };

          // Afficher le nom de la frame sélectionnée seulement si on n'est pas en cours d'analyse
          if (currentStep !== 4 && msg.selectedFrameName) {
            scanEmptyState.innerHTML = '<div style="text-align: center; padding: 40px 20px;"><div style="margin-bottom: 16px; display: block;"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.5;"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="7" y="7" width="10" height="10" rx="1" stroke="currentColor" stroke-width="1" fill="none" opacity="0.3"/><circle cx="12" cy="12" r="1.5" fill="currentColor" opacity="0.6"/></svg></div><h4 style="margin-bottom: 8px; color: var(--poly-text);">Frame sélectionnée</h4><p style="color: var(--poly-text-muted); margin-bottom: 20px; font-weight: 500;">' + msg.selectedFrameName + '</p></div>';
            scanEmptyState.classList.remove("hidden");
          } else {
            scanEmptyState.classList.add("hidden");
          }
        } else {
          scanBtn.disabled = true;
          scanBtn.textContent = "Lancer l'analyse";
          scanBtn.className = "btn-secondary"; // Bouton gris quand aucune frame sélectionnée

          // Remettre l'état vide original
          scanEmptyState.innerHTML = '<div style="text-align: center; padding: 40px 20px;"><div style="margin-bottom: 16px; display: block;"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.5;"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="7" y="7" width="10" height="10" rx="1" stroke="currentColor" stroke-width="1" fill="none" opacity="0.3"/><circle cx="12" cy="12" r="1.5" fill="currentColor" opacity="0.6"/></svg></div><h4 style="margin-bottom: 8px; color: var(--poly-text-muted);">Aucune Frame sélectionnée</h4><p style="color: var(--poly-text-muted); margin-bottom: 20px;">Sélectionnez une frame dans Figma pour lancer l\'analyse et détecter les valeurs en dur.</p></div>';
          scanEmptyState.classList.remove("hidden");
        }
      }

      if (msg.type === "all-fixes-applied") {
        // Masquer les boutons d'application
        var applyAllSection = document.getElementById("applyAllSection");
        var step4ApplyAll = document.getElementById("step4ApplyAll");

        if (applyAllSection) {
          applyAllSection.style.display = 'none';
        }
        if (step4ApplyAll) {
          step4ApplyAll.style.display = 'none';
        }

        // Réactiver les boutons pour une future utilisation
        var applyAllBtn = document.getElementById("applyAllBtn");
        if (applyAllBtn) {
          applyAllBtn.disabled = false;
          applyAllBtn.textContent = "✅ Appliquer toutes les corrections";
        }
        if (step4ApplyAll) {
          step4ApplyAll.disabled = false;
          step4ApplyAll.textContent = "✅ Valider";
        }

        // Afficher un message de succès
        var scanResultsList = document.getElementById("unifiedCleaningList");
        if (scanResultsList) {
          scanResultsList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--poly-success);"><p>✅ ' + msg.appliedCount + ' correction(s) appliquée(s) avec succès !</p><p style="font-size: 12px; color: var(--poly-text-muted); margin-top: 8px;">Relancez l\'analyse pour vérifier qu\'il n\'y a plus d\'éléments à corriger.</p></div>';
        }
      }
    };

    // ============================================
    // PREVIEW & EXPORT FUNCTIONS
    // ============================================

    // Mode Toggle (Designer / Developer)
    modeDesigner.addEventListener("click", function () {
      modeDesigner.classList.add("active");
      modeDev.classList.remove("active");

      designerView.classList.remove("hidden");
      devView.classList.add("hidden");

      // Footer Switch
      footerDesignerOps.classList.remove("hidden");
      footerDevOps.classList.add("hidden");

      // Toggle Overwrite checkbox visibility logic (restore if needed)
      if (hasExistingTokens) {
        overwriteCheckboxContainer.classList.remove("hidden");
      }
    });

    modeDev.addEventListener("click", function () {
      modeDev.classList.add("active");
      modeDesigner.classList.remove("active");

      devView.classList.remove("hidden");
      designerView.classList.add("hidden");

      // Footer Switch
      footerDevOps.classList.remove("hidden");
      footerDesignerOps.classList.add("hidden");

      // Hide Overwrite checkbox in Dev mode (irrelevant)
      overwriteCheckboxContainer.classList.add("hidden");
    });

    // Token Category Tabs
    tokenTabs.addEventListener("click", function (e) {
      if (e.target.classList.contains("tab")) {
        var tabs = tokenTabs.querySelectorAll(".tab");
        tabs.forEach(function (tab) { tab.classList.remove("active"); });
        e.target.classList.add("active");
        activeCategory = e.target.getAttribute("data-category");
        updatePreview();
      }
    });

    function updatePreview() {
      if (!currentTokens) return;

      var categoryData = currentTokens[activeCategory];
      if (!categoryData) {
        tokenPreview.innerHTML = "<p style='color: var(--poly-text-muted); text-align: center; padding: 20px;'>No tokens available for this category.</p>";
        return;
      }

      var isColor = (activeCategory === "brand" || activeCategory === "system" || activeCategory === "gray");

      // Logic to Determine Lock State
      var isCustomLib = (currentNaming === "custom");
      var isLocked = !isCustomLib && !isColor; // Lock if Standard Lib AND Non-Color structure

      var html = "";

      // Stylish Banner for Locked State (Placed at Top)
      if (isLocked) {
        var libName = (currentNaming ? currentNaming.charAt(0).toUpperCase() + currentNaming.slice(1) : "Standard");
        html += "<div class='locked-banner' style='margin-bottom: 12px; margin-top: 0;'>";
        html += "<span class='icon'>🔒</span>";
        html += "<div>";
        html += "<div class='locked-banner-text'>" + libName + " standards are active.</div>";
        html += "<span class='locked-banner-sub'>Structure tokens are locked to ensure code compatibility.</span>";
        html += "</div>";
        html += "</div>";
      }

      html += "<table class='token-table'>";
      html += "<thead><tr>";
      if (isColor) {
        html += "<th style='width: 60px;'>Color</th>";
        html += "<th style='width: 120px;'>Name</th>"; // Fixed width
      } else {
        html += "<th style='width: 180px;'>Name</th>"; // Wider name if no color
      }
      html += "<th>Value</th>"; // Flexible width

      // ONLY show Actions header if Custom
      if (isCustomLib) {
        html += "<th style='width: 60px;'>Actions</th>";
      }
      html += "</tr></thead><tbody>";

      for (var key in categoryData) {
        if (!categoryData.hasOwnProperty(key)) continue;
        var value = categoryData[key];

        html += "<tr>";
        if (isColor) {
          html += "<td><div class='color-swatch' style='background-color: " + value + ";'></div></td>";
        }
        html += "<td class='token-name'>" + activeCategory + "-" + key + "</td>";

        // Value Column (Conditional Render)
        html += "<td>";
        if (isLocked) {
          // LOCKED DISPLAY (Disabled Input, no Icon)
          // We keep the <input> tag to ensure perfect alignment with editable rows
          html += "<input type='text' class='table-input locked' value='" + value + "' disabled />";
        } else {
          // EDITABLE INPUT (Standard)
          html += "<input type='text' class='table-input' data-token-key='" + key + "' value='" + value + "' />";
        }
        html += "</td>";

        // Action Column: ONLY if Custom
        if (isCustomLib) {
          html += "<td style='text-align: center;'>";
          html += "<button class='btn-icon' onclick='deleteToken(\"" + key + "\")' title='Delete' style='color: var(--poly-error);'><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 6h18'/><path d='M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6'/><path d='M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2'/></svg></button>";
          html += "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";

      // Only show "Add Token" if we are in "Custom" mode
      if (isCustomLib) {
        html += "<div class='add-token-sticky'>";
        html += "<button class='btn-secondary' onclick='addToken()' style='width: 100%;'>+ Add Token</button>";
        html += "</div>";
      }

      tokenPreview.innerHTML = html;

      // Add event listeners to all inputs for inline editing
      var inputs = tokenPreview.querySelectorAll('.table-input');
      inputs.forEach(function (input) {
        input.addEventListener('change', function () {
          var tokenKey = input.getAttribute('data-token-key');
          var newValue = input.value.trim();
          if (newValue && currentTokens[activeCategory][tokenKey]) {
            currentTokens[activeCategory][tokenKey] = newValue;
            updateExport();
            // Refresh preview to update color swatch if it's a color
            if (isColor) {
              updatePreview();
            }
          }
        });
      });
    }

    function highlightSyntax(code, lang) {
      if (!code) return "";

      // Basic HTML Escape
      code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

      if (lang === 'json') {
        return code.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'syn-number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'syn-key';
            } else {
              cls = 'syn-string';
            }
          } else if (/true|false|null/.test(match)) {
            cls = 'syn-kwd';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
      }

      if (lang === 'css' || lang === 'scss') {
        return code
          .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="syn-comment">$1</span>') // Comments
          .replace(/([a-zA-Z-]+)(?=:)/g, '<span class="syn-key">$1</span>') // Props
          .replace(/(:)([^;]+)(;)/g, function (m, p1, p2, p3) {
            return '<span class="syn-punc">:</span><span class="syn-number">' + p2 + '</span><span class="syn-punc">;</span>';
          });
      }

      if (lang === 'js' || lang === 'tailwind') {
        return code
          .replace(/(\/\/.*)/g, '<span class="syn-comment">$1</span>')
          .replace(/('.*?')|(".*?")/g, '<span class="syn-string">$1</span>')
          .replace(/\b(module|exports|const|var|let|return|function|theme|extend)\b/g, '<span class="syn-kwd">$1</span>')
          .replace(/(\b\d+\b)/g, '<span class="syn-number">$1</span>');
      }

      return code;
    }

    var rawExportContent = "";
    var codeEditor = document.getElementById("codeEditor");

    function updateExport() {
      if (!currentTokens) return;

      var format = exportFormat.value;
      var output = "";

      if (format === "css") {
        output = ":root {\n";
        for (var category in currentTokens) {
          if (!currentTokens.hasOwnProperty(category)) continue;
          for (var key in currentTokens[category]) {
            if (!currentTokens[category].hasOwnProperty(key)) continue;
            output += "  --" + category + "-" + key + ": " + currentTokens[category][key] + ";\n";
          }
        }
        output += "}";
      } else if (format === "json") {
        output = JSON.stringify(currentTokens, null, 2);
      } else if (format === "tailwind") {
        output = "module.exports = {\n  theme: {\n    extend: {\n";
        for (var category in currentTokens) {
          if (!currentTokens.hasOwnProperty(category)) continue;
          output += "      " + category + ": {\n";
          for (var key in currentTokens[category]) {
            if (!currentTokens[category].hasOwnProperty(key)) continue;
            output += "        '" + key + "': '" + currentTokens[category][key] + "',\n";
          }
          output += "      },\n";
        }
        output += "    }\n  }\n}";
      } else if (format === "scss") {
        for (var category in currentTokens) {
          if (!currentTokens.hasOwnProperty(category)) continue;
          for (var key in currentTokens[category]) {
            if (!currentTokens[category].hasOwnProperty(key)) continue;
            output += "$" + category + "-" + key + ": " + currentTokens[category][key] + ";\n";
          }
        }
      }

      rawExportContent = output;

      // Determine syntax lang
      var lang = 'css'; // default
      if (format === 'json') lang = 'json';
      if (format === 'tailwind') lang = 'js';
      if (format === 'scss') lang = 'scss';

      codeEditor.innerHTML = highlightSyntax(output, lang);
    }

    exportFormat.addEventListener("change", updateExport);

    function copyCheck(btn) {
      var originalHTML = btn.innerHTML;
      // Simple visual feedback
      btn.classList.add("copied"); // Optional: add a class for CSS styling
      // Try to find text node or just set innerHTML
      var textSpan = btn.querySelector("span:not(.icon)"); // Try to find text part

      btn.innerHTML = '<span class="icon">✓</span> Copied!';

      setTimeout(function () {
        btn.innerHTML = originalHTML;
        btn.classList.remove("copied");
      }, 2000);
    }

    function doCopy(btnTrigger) {
      if (!rawExportContent) return;

      var ta = document.createElement("textarea");
      ta.value = rawExportContent;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);

      copyCheck(btnTrigger);
    }

    copyBtnFooter.addEventListener("click", function () { doCopy(copyBtnFooter); });

    // Download File Logic
    downloadBtn.addEventListener("click", function () {
      const content = rawExportContent;
      const format = exportFormat.value;
      if (!content) return;

      let filename = "tokens";
      let mimeType = "text/plain";

      switch (format) {
        case 'css':
          filename += ".css";
          mimeType = "text/css";
          break;
        case 'json':
          filename += ".json";
          mimeType = "application/json";
          break;
        case 'tailwind':
          filename = "tailwind.config.js";
          mimeType = "text/javascript";
          break;
        case 'scss':
          filename += ".scss";
          mimeType = "text/x-scss";
          break;
        default:
          filename += ".txt";
      }

      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();

      // Cleanup
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // ============================================
    // TOKEN EDITING FUNCTIONS
    // ============================================
    var editingTokenKey = null;

    function deleteToken(tokenKey) {
      if (!currentTokens || !currentTokens[activeCategory]) return;

      if (confirm('Are you sure you want to delete "' + tokenKey + '"?')) {
        delete currentTokens[activeCategory][tokenKey];
        updatePreview();
        updateExport();
      }
    }

    function addToken() {
      if (!currentTokens) return;

      editingTokenKey = null;
      document.getElementById('modalTitle').textContent = 'Add Token';
      document.getElementById('modalTokenName').value = '';
      document.getElementById('modalTokenName').disabled = false;
      document.getElementById('modalTokenValue').value = '';
      document.getElementById('tokenModal').classList.add('active');
    }

    function saveToken() {
      var tokenName = document.getElementById('modalTokenName').value.trim();
      var tokenValue = document.getElementById('modalTokenValue').value.trim();

      if (!tokenName || !tokenValue) {
        alert('Please fill in both name and value');
        return;
      }

      if (!currentTokens[activeCategory]) {
        currentTokens[activeCategory] = {};
      }

      // If adding new token and name already exists
      if (!editingTokenKey && currentTokens[activeCategory][tokenName]) {
        if (!confirm('Token "' + tokenName + '" already exists. Overwrite?')) {
          return;
        }
      }

      currentTokens[activeCategory][tokenName] = tokenValue;
      closeModal();
      updatePreview();
      updateExport();
    }

    function closeModal() {
      document.getElementById('tokenModal').classList.remove('active');
      editingTokenKey = null;
    }

    // Close modal on background click
    document.getElementById('tokenModal').addEventListener('click', function (e) {
      if (e.target.id === 'tokenModal') {
        closeModal();
      }
    });

    // ============================================
    // CSS PARSER
    // ============================================
    function parseCssToTokens(css) {
      var tokens = {
        brand: {},
        system: {},
        gray: {},
        spacing: {},
        radius: {},
        typography: {},
        border: {}
      };

      // Regex to match --variable: value;
      var regex = /--([a-zA-Z0-9-_]+):\s*([^;]+);/g;
      var match;

      while ((match = regex.exec(css)) !== null) {
        var key = match[1].trim();
        var value = match[2].trim();

        // Categorization Logic
        if (key.includes("brand") || key.includes("primary")) {
          tokens.brand[key] = value;
        } else if (key.includes("system") || key.includes("success") || key.includes("warning") || key.includes("error") || key.includes("info")) {
          tokens.system[key] = value;
        } else if (key.includes("gray") || key.includes("grey") || key.includes("neutral")) {
          tokens.gray[key] = value;
        } else if (key.includes("spacing") || key.includes("gap") || key.includes("margin") || key.includes("padding")) {
          tokens.spacing[key] = value;
        } else if (key.includes("radius") || key.includes("rounded")) {
          tokens.radius[key] = value;
        } else if (key.includes("typo") || key.includes("font") || key.includes("text")) {
          tokens.typography[key] = value;
        } else if (key.includes("border") || key.includes("stroke")) {
          tokens.border[key] = value;
        }
      }

      return tokens;
    }



    // ============================================
    // INITIALIZATION
    // ============================================
    updateColorPreview(currentColor);
    // INITIALIZATION
    colorInput.value = currentColor;
    colorPicker.value = currentColor;
    updateColorPreview(currentColor);

    // ============================================
    // WINDOW RESIZE FUNCTIONALITY
    // ============================================

    // Resize handle element
    const resizeHandle = document.createElement('div');
    resizeHandle.id = 'resize-handle';
    resizeHandle.innerHTML = '↗';
    resizeHandle.style.cssText = `
      position: fixed;
      bottom: 0;
      right: 0;
      width: 16px;
      height: 16px;
      cursor: nw-resize;
      background: var(--poly-surface);
      color: var(--poly-text-muted);
      border: 1px solid var(--poly-border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: normal;
      border-radius: 3px 0 0 0;
      user-select: none;
      z-index: 1000;
      opacity: 0.7;
      transition: all 0.2s ease;
    `;

    resizeHandle.addEventListener('mouseenter', function() {
      this.style.backgroundColor = 'var(--poly-accent)';
      this.style.color = 'var(--poly-bg)';
      this.style.opacity = '1';
      this.style.transform = 'scale(1.1)';
    });

    resizeHandle.addEventListener('mouseleave', function() {
      this.style.backgroundColor = 'var(--poly-surface)';
      this.style.color = 'var(--poly-text-muted)';
      this.style.opacity = '0.7';
      this.style.transform = 'scale(1)';
    });

    document.body.appendChild(resizeHandle);

    // Resize functionality
    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    function startResize(e) {
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;

      // Get current window size
      startWidth = window.innerWidth;
      startHeight = window.innerHeight;

      document.body.classList.add('resizing');
      document.body.style.cursor = 'nw-resize';

      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
      e.preventDefault();
    }

    function resize(e) {
      if (!isResizing) return;

      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      // Contraintes de taille pour une bonne UX
      const MIN_WIDTH = 400;
      const MAX_WIDTH = 1600;
      const MIN_HEIGHT = 500;
      const MAX_HEIGHT = 1400;

      const newWidth = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, startWidth + deltaX));
      const newHeight = Math.max(MIN_HEIGHT, Math.min(MAX_HEIGHT, startHeight + deltaY));

      // Send resize message to main thread
      parent.postMessage({
        pluginMessage: {
          type: 'resize',
          width: newWidth,
          height: newHeight
        }
      }, '*');
    }

    function stopResize() {
      isResizing = false;
      document.body.classList.remove('resizing');
      document.body.style.cursor = '';

      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
    }

    resizeHandle.addEventListener('mousedown', startResize);

    // Prevent text selection during resize
    resizeHandle.addEventListener('selectstart', function(e) {
      e.preventDefault();
    });

  </script>
</body>

</html>
